{% extends "base_layout.html" %}

{% block title %}Economic Calendar - Qunex Trade{% endblock %}

{% block extra_styles %}
<style>
    /* Calendar Header */
    .calendar-header {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 24px;
        border-radius: 16px;
        margin-bottom: 32px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 24px;
    }

    .calendar-controls {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .month-nav-btn {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #fff;
        width: 40px;
        height: 40px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 1.2em;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .month-nav-btn:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.2);
        color: #00d9ff;
    }

    .current-month {
        font-size: 1.5rem;
        font-weight: 700;
        color: #fff;
        min-width: 200px;
        text-align: center;
    }

    /* Legend */
    .calendar-legend {
        display: flex;
        gap: 24px;
        align-items: center;
        font-size: 0.875rem;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        color: rgba(255, 255, 255, 0.6);
    }

    .legend-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .legend-dot.high {
        background: #ef4444;
        box-shadow: 0 0 8px rgba(239, 68, 68, 0.4);
    }

    .legend-dot.medium {
        background: #f59e0b;
        box-shadow: 0 0 8px rgba(245, 158, 11, 0.4);
    }

    .legend-dot.low {
        background: #22c55e;
        box-shadow: 0 0 8px rgba(34, 197, 94, 0.4);
    }

    /* Calendar Grid */
    .calendar-grid {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 24px;
        border-radius: 16px;
    }

    .weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 12px;
        margin-bottom: 16px;
    }

    .weekday {
        text-align: center;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.5);
        padding: 12px 0;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .days-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 12px;
    }

    .day-cell {
        min-height: 140px;
        background: rgba(255, 255, 255, 0.01);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 12px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        display: flex;
        flex-direction: column;
    }

    .day-cell:hover {
        background: rgba(255, 255, 255, 0.03);
        border-color: rgba(255, 255, 255, 0.12);
        transform: translateY(-2px);
    }

    .day-cell.other-month {
        opacity: 0.3;
        background: transparent;
    }

    .day-cell.today {
        border: 1px solid #00d9ff;
        background: rgba(0, 217, 255, 0.02);
        box-shadow: 0 0 15px rgba(0, 217, 255, 0.05);
    }

    .day-number {
        font-weight: 600;
        font-size: 1.125rem;
        margin-bottom: 8px;
        color: rgba(255, 255, 255, 0.6);
        font-family: 'JetBrains Mono', monospace;
    }

    .day-cell.today .day-number {
        color: #00d9ff;
    }

    .events-container {
        display: flex;
        flex-direction: column;
        gap: 6px;
        flex-grow: 1;
    }

    .event-pill {
        background: rgba(255, 255, 255, 0.05);
        border-left: 2px solid rgba(255, 255, 255, 0.3);
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 500;
        color: #fff;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        transition: all 0.2s ease;
    }

    .event-pill:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateX(2px);
    }

    .event-pill.high {
        border-left-color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
        color: #fca5a5;
    }

    .event-pill.medium {
        border-left-color: #f59e0b;
        background: rgba(245, 158, 11, 0.1);
        color: #fcd34d;
    }

    .event-pill.low {
        border-left-color: #22c55e;
        background: rgba(34, 197, 94, 0.1);
        color: #86efac;
    }

    .event-count {
        font-size: 0.7rem;
        color: rgba(255, 255, 255, 0.4);
        margin-top: auto;
        text-align: center;
        padding-top: 4px;
    }

    /* Event Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(8px);
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        background: #0a0a0a;
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 16px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        padding: 32px;
        position: relative;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .modal-close {
        position: absolute;
        top: 24px;
        right: 24px;
        background: transparent;
        border: none;
        color: rgba(255, 255, 255, 0.6);
        font-size: 1.5em;
        cursor: pointer;
        transition: color 0.2s ease;
        line-height: 1;
    }

    .modal-close:hover {
        color: #ef4444;
    }

    .modal-header {
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .modal-date {
        font-size: 1.5rem;
        font-weight: 700;
        color: #fff;
    }

    .modal-events {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .modal-event {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-left: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        padding: 20px;
        transition: transform 0.2s ease;
    }

    .modal-event:hover {
        transform: translateX(4px);
    }

    .modal-event.high {
        border-left-color: #ef4444;
    }

    .modal-event.medium {
        border-left-color: #f59e0b;
    }

    .modal-event.low {
        border-left-color: #22c55e;
    }

    .modal-event-title {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 12px;
        color: #fff;
    }

    .modal-event-details {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        font-size: 0.875rem;
    }

    .modal-event-detail {
        display: flex;
        align-items: center;
        gap: 8px;
        color: rgba(255, 255, 255, 0.6);
        background: rgba(255, 255, 255, 0.03);
        padding: 6px 12px;
        border-radius: 8px;
    }

    .detail-label {
        font-weight: 600;
        color: rgba(255, 255, 255, 0.4);
        font-size: 0.75rem;
        text-transform: uppercase;
    }

    .impact-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .impact-badge.high {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
    }

    .impact-badge.medium {
        background: rgba(245, 158, 11, 0.2);
        color: #f59e0b;
    }

    .impact-badge.low {
        background: rgba(34, 197, 94, 0.2);
        color: #22c55e;
    }

    /* Loading State */
    .loading {
        text-align: center;
        padding: 60px;
        color: rgba(255, 255, 255, 0.5);
        grid-column: 1 / -1;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-top-color: #00d9ff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    @media (max-width: 1024px) {
        .days-grid {
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .day-cell {
            min-height: 100px;
            padding: 8px;
        }

        .event-pill {
            font-size: 0.65rem;
        }
    }

    @media (max-width: 768px) {
        .calendar-header {
            flex-direction: column;
            align-items: stretch;
            gap: 20px;
        }

        .calendar-controls {
            justify-content: space-between;
        }

        .calendar-legend {
            flex-wrap: wrap;
            justify-content: center;
        }

        .day-cell {
            min-height: 80px;
            padding: 6px;
        }

        .day-number {
            font-size: 0.875rem;
        }

        .event-pill {
            display: none;
        }

        .day-cell .events-container::after {
            content: '•';
            color: #00d9ff;
            font-size: 1.5rem;
            line-height: 0.5;
            text-align: center;
            display: block;
        }

        .day-cell:empty .events-container::after {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="content-header">
    <div>
        <h1 class="content-title">Economic Calendar</h1>
        <p class="content-subtitle">
            Major economic events and data releases
        </p>
    </div>
    <div class="header-actions" style="display: flex; gap: 12px;">
        <button class="btn btn-secondary" onclick="refreshCalendar()">
            Refresh Events
        </button>
        <button class="btn btn-primary" onclick="goToToday()">
            Today
        </button>
    </div>
</div>

<!-- Calendar Header with Controls -->
<div class="calendar-header">
    <div class="calendar-controls">
        <button class="month-nav-btn" onclick="changeMonth(-1)">‹</button>
        <div class="current-month" id="current-month"></div>
        <button class="month-nav-btn" onclick="changeMonth(1)">›</button>
    </div>

    <div class="calendar-legend">
        <div class="legend-item">
            <div class="legend-dot high"></div>
            <span>High Impact</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot medium"></div>
            <span>Medium Impact</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot low"></div>
            <span>Low Impact</span>
        </div>
    </div>
</div>

<!-- Calendar Grid -->
<div class="calendar-grid">
    <div class="weekdays">
        <div class="weekday">Sun</div>
        <div class="weekday">Mon</div>
        <div class="weekday">Tue</div>
        <div class="weekday">Wed</div>
        <div class="weekday">Thu</div>
        <div class="weekday">Fri</div>
        <div class="weekday">Sat</div>
    </div>
    <div class="days-grid" id="calendar-days">
        <div class="loading">
            <div class="spinner"></div>
            <div>Loading calendar...</div>
        </div>
    </div>
</div>

<!-- Event Details Modal -->
<div class="modal" id="event-modal" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <div class="modal-header">
            <div class="modal-date" id="modal-date"></div>
        </div>
        <div class="modal-events" id="modal-events"></div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let currentDate = new Date();
    let eventsData = [];

    // Load events from API
    async function loadEvents() {
        try {
            const response = await fetch('/api/economic-calendar');
            const data = await response.json();

            if (data.success) {
                eventsData = data.events;
                renderCalendar();
            } else {
                console.error('Failed to load events:', data.message);
                document.getElementById('calendar-days').innerHTML =
                    '<div class="loading"><div>Failed to load calendar events</div></div>';
            }
        } catch (error) {
            console.error('Error loading events:', error);
            document.getElementById('calendar-days').innerHTML =
                '<div class="loading"><div>Error loading calendar</div></div>';
        }
    }

    // Render calendar for current month
    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        // Update month display
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'];
        document.getElementById('current-month').textContent = `${monthNames[month]} ${year}`;

        // Get first day of month and number of days
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();

        // Build calendar grid
        const daysGrid = document.getElementById('calendar-days');
        daysGrid.innerHTML = '';

        const today = new Date();
        const isCurrentMonth = today.getMonth() === month && today.getFullYear() === year;

        // Previous month days
        for (let i = firstDay - 1; i >= 0; i--) {
            const day = daysInPrevMonth - i;
            const cell = createDayCell(day, month - 1, year, true);
            daysGrid.appendChild(cell);
        }

        // Current month days
        for (let day = 1; day <= daysInMonth; day++) {
            const isToday = isCurrentMonth && day === today.getDate();
            const cell = createDayCell(day, month, year, false, isToday);
            daysGrid.appendChild(cell);
        }

        // Next month days
        const totalCells = daysGrid.children.length;
        const remainingCells = 42 - totalCells; // 6 rows x 7 days
        for (let day = 1; day <= remainingCells; day++) {
            const cell = createDayCell(day, month + 1, year, true);
            daysGrid.appendChild(cell);
        }
    }

    // Create a day cell
    function createDayCell(day, month, year, isOtherMonth, isToday = false) {
        const cell = document.createElement('div');
        cell.className = 'day-cell';
        if (isOtherMonth) cell.classList.add('other-month');
        if (isToday) cell.classList.add('today');

        // Day number
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = day;
        cell.appendChild(dayNumber);

        // Find events for this day
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayEvents = eventsData.filter(event => event.date === dateStr);

        if (dayEvents.length > 0) {
            const eventsContainer = document.createElement('div');
            eventsContainer.className = 'events-container';

            // Show up to 3 events
            const displayEvents = dayEvents.slice(0, 3);
            displayEvents.forEach(event => {
                const eventPill = document.createElement('div');
                eventPill.className = `event-pill ${event.impact.toLowerCase()}`;
                eventPill.textContent = event.title;
                eventsContainer.appendChild(eventPill);
            });

            // Show "+X more" if there are more events
            if (dayEvents.length > 3) {
                const moreCount = document.createElement('div');
                moreCount.className = 'event-count';
                moreCount.textContent = `+${dayEvents.length - 3} more`;
                eventsContainer.appendChild(moreCount);
            }

            cell.appendChild(eventsContainer);

            // Click to show modal
            cell.onclick = () => showEventModal(dateStr, dayEvents);
        }

        return cell;
    }

    function changeMonth(delta) {
        currentDate.setMonth(currentDate.getMonth() + delta);
        renderCalendar();
    }

    function goToToday() {
        currentDate = new Date();
        renderCalendar();
    }

    function showEventModal(dateStr, events) {
        const modal = document.getElementById('event-modal');
        const modalDate = document.getElementById('modal-date');
        const modalEvents = document.getElementById('modal-events');

        const date = new Date(dateStr);
        modalDate.textContent = date.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        modalEvents.innerHTML = events.map(event => `
            <div class="modal-event ${event.impact.toLowerCase()}">
                <div class="modal-event-title">${event.title}</div>
                <div class="modal-event-details">
                    <div class="modal-event-detail">
                        <span class="detail-label">Time:</span>
                        <span>${event.time || 'All Day'}</span>
                    </div>
                    <div class="modal-event-detail">
                        <span class="detail-label">Currency:</span>
                        <span>${event.currency || 'USD'}</span>
                    </div>
                    <div class="modal-event-detail">
                        <span class="detail-label">Impact:</span>
                        <span class="impact-badge ${event.impact.toLowerCase()}">${event.impact}</span>
                    </div>
                    ${event.forecast ? `
                    <div class="modal-event-detail">
                        <span class="detail-label">Forecast:</span>
                        <span>${event.forecast}</span>
                    </div>` : ''}
                    ${event.previous ? `
                    <div class="modal-event-detail">
                        <span class="detail-label">Previous:</span>
                        <span>${event.previous}</span>
                    </div>` : ''}
                </div>
            </div>
        `).join('');

        modal.classList.add('active');
    }

    function closeModal(event) {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById('event-modal').classList.remove('active');
    }

    // Close modal on Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeModal();
    });

    // Refresh calendar events from server
    async function refreshCalendar() {
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = 'Refreshing...';

        try {
            const response = await fetch('/api/economic-calendar/refresh');
            const data = await response.json();

            if (data.success) {
                if (data.count > 0) {
                    alert(`Added ${data.count} new economic events.`);
                } else {
                    alert('Calendar is already up to date.');
                }
                loadEvents();  // Reload events
            } else {
                alert('Failed to refresh calendar: ' + (data.message || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error refreshing calendar:', error);
            alert('Error refreshing calendar. Check console for details.');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    // Initial load
    loadEvents();
</script>
{% endblock %}
