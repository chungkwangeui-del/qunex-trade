{% extends "base_layout.html" %}

{% block title %}Scalp Trading - Candlestick + Volume Analysis - Qunex Trade{% endblock %}

{% block extra_styles %}
<style>
    /* Top Bar - Market Status & Auto-refresh */
    .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding: 12px 16px;
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        flex-wrap: wrap;
        gap: 12px;
    }

    .market-status {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: var(--text-sm);
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    .status-dot.open { background: var(--success); }
    .status-dot.closed { background: var(--danger); }
    .status-dot.premarket { background: #f59e0b; }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .auto-refresh-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: var(--text-sm);
        color: var(--text-secondary);
    }

    .toggle-switch {
        position: relative;
        width: 44px;
        height: 24px;
        background: var(--bg-hover);
        border-radius: 12px;
        cursor: pointer;
        transition: background var(--transition-fast);
    }

    .toggle-switch.active {
        background: var(--accent-cyan);
    }

    .toggle-switch::after {
        content: '';
        position: absolute;
        width: 18px;
        height: 18px;
        background: white;
        border-radius: 50%;
        top: 3px;
        left: 3px;
        transition: transform var(--transition-fast);
    }

    .toggle-switch.active::after {
        transform: translateX(20px);
    }

    .refresh-countdown {
        font-family: 'JetBrains Mono', monospace;
        font-size: var(--text-xs);
        color: var(--text-tertiary);
        min-width: 30px;
    }

    .keyboard-hint {
        font-size: var(--text-xs);
        color: var(--text-tertiary);
        display: flex;
        gap: 12px;
    }

    .kbd {
        padding: 2px 6px;
        background: var(--bg-hover);
        border: 1px solid var(--border-subtle);
        border-radius: 4px;
        font-family: 'JetBrains Mono', monospace;
        font-size: 10px;
    }

    /* Search Section */
    .search-section {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        padding: 24px;
        margin-bottom: 24px;
    }

    .search-row {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
    }

    .search-form {
        display: flex;
        gap: 12px;
        align-items: center;
        flex: 1;
    }

    .search-input {
        flex: 1;
        max-width: 300px;
        padding: 12px 16px;
        background: var(--bg-hover);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        color: var(--text-primary);
        font-size: 1rem;
        font-family: 'JetBrains Mono', monospace;
        text-transform: uppercase;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--accent-cyan);
        box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.1);
    }

    .search-btn {
        padding: 12px 24px;
        background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
        border: none;
        border-radius: var(--radius-lg);
        color: #000;
        font-weight: var(--font-semibold);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .search-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0, 217, 255, 0.3);
    }

    .search-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .timeframe-tabs {
        display: flex;
        gap: 8px;
        margin-left: auto;
    }

    .timeframe-tab {
        padding: 8px 14px;
        background: transparent;
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        color: var(--text-tertiary);
        font-size: var(--text-sm);
        font-family: 'JetBrains Mono', monospace;
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .timeframe-tab:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
        border-color: rgba(0, 217, 255, 0.3);
    }

    .timeframe-tab.active {
        background: rgba(0, 217, 255, 0.1);
        color: var(--accent-cyan);
        border-color: var(--accent-cyan);
    }

    /* Recent Searches & Watchlist */
    .quick-access {
        display: flex;
        gap: 16px;
        margin-top: 16px;
        flex-wrap: wrap;
    }

    .quick-access-section {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .quick-access-label {
        font-size: var(--text-xs);
        color: var(--text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .quick-ticker {
        padding: 4px 10px;
        background: var(--bg-hover);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-sm);
        font-size: var(--text-xs);
        font-family: 'JetBrains Mono', monospace;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .quick-ticker:hover {
        background: rgba(0, 217, 255, 0.1);
        border-color: var(--accent-cyan);
        color: var(--accent-cyan);
    }

    .quick-ticker.watchlist {
        border-color: rgba(234, 179, 8, 0.3);
    }

    .quick-ticker.watchlist:hover {
        background: rgba(234, 179, 8, 0.1);
        border-color: #eab308;
        color: #eab308;
    }

    .watchlist-btn {
        padding: 4px 8px;
        background: transparent;
        border: 1px dashed var(--border-subtle);
        border-radius: var(--radius-sm);
        font-size: var(--text-xs);
        color: var(--text-tertiary);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .watchlist-btn:hover {
        border-color: #eab308;
        color: #eab308;
    }

    .watchlist-btn.added {
        background: rgba(234, 179, 8, 0.1);
        border-style: solid;
        border-color: #eab308;
        color: #eab308;
    }

    /* Copy Buttons */
    .copy-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        background: transparent;
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-sm);
        color: var(--text-tertiary);
        cursor: pointer;
        transition: all var(--transition-fast);
        margin-left: 8px;
        font-size: 12px;
    }

    .copy-btn:hover {
        background: var(--bg-hover);
        border-color: var(--accent-cyan);
        color: var(--accent-cyan);
    }

    .copy-btn.copied {
        background: rgba(34, 197, 94, 0.1);
        border-color: var(--success);
        color: var(--success);
    }

    .entry-exit-value-wrapper {
        display: flex;
        align-items: center;
    }

    /* Toast Notification */
    .toast-container {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 9999;
    }

    .toast {
        padding: 12px 20px;
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        color: var(--text-primary);
        font-size: var(--text-sm);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        display: none;
        animation: slideIn 0.3s ease;
    }

    .toast.show {
        display: block;
    }

    .toast.success {
        border-color: var(--success);
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), var(--bg-card));
    }

    .toast.warning {
        border-color: #eab308;
        background: linear-gradient(135deg, rgba(234, 179, 8, 0.1), var(--bg-card));
    }

    .toast.error {
        border-color: var(--danger);
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), var(--bg-card));
    }

    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    /* Last Updated Timestamp */
    .last-updated {
        font-size: var(--text-xs);
        color: var(--text-tertiary);
        text-align: right;
        margin-top: 8px;
    }

    /* Price Levels Visual Panel */
    .price-levels-panel {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-top: none;
        padding: 16px 20px;
        display: none;
    }

    .price-levels-panel.show {
        display: block;
    }

    .price-levels-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .price-levels-title {
        font-size: var(--text-xs);
        font-weight: var(--font-semibold);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-tertiary);
    }

    .current-price-tag {
        font-family: 'JetBrains Mono', monospace;
        font-size: var(--text-sm);
        font-weight: var(--font-bold);
        padding: 4px 10px;
        background: rgba(0, 217, 255, 0.15);
        border: 1px solid var(--accent-cyan);
        border-radius: var(--radius-sm);
        color: var(--accent-cyan);
    }

    .price-levels-visual {
        position: relative;
        height: 140px;
        background: linear-gradient(180deg, rgba(239, 68, 68, 0.05) 0%, rgba(34, 197, 94, 0.05) 100%);
        border-radius: var(--radius-md);
        overflow: hidden;
        margin-bottom: 12px;
    }

    .price-level-line {
        position: absolute;
        left: 0;
        right: 0;
        height: 2px;
        display: flex;
        align-items: center;
        transition: top 0.3s ease;
    }

    .price-level-line::before {
        content: '';
        flex: 1;
        height: 2px;
        background: currentColor;
    }

    .price-level-line.entry {
        color: #22c55e;
        z-index: 5;
    }

    .price-level-line.stop {
        color: #ef4444;
        z-index: 4;
    }

    .price-level-line.tp1 {
        color: #22d3ee;
        z-index: 3;
    }

    .price-level-line.tp2 {
        color: #a855f7;
        z-index: 2;
    }

    .price-level-line.tp3 {
        color: #f59e0b;
        z-index: 1;
    }

    .price-level-line.current {
        color: var(--accent-cyan);
        z-index: 10;
        height: 3px;
    }

    .price-level-line.current::before {
        height: 3px;
        background: repeating-linear-gradient(
            90deg,
            var(--accent-cyan),
            var(--accent-cyan) 8px,
            transparent 8px,
            transparent 12px
        );
    }

    .price-level-label {
        position: absolute;
        right: 8px;
        transform: translateY(-50%);
        font-family: 'JetBrains Mono', monospace;
        font-size: 11px;
        font-weight: var(--font-semibold);
        padding: 2px 8px;
        border-radius: 3px;
        white-space: nowrap;
        background: var(--bg-card);
        border: 1px solid currentColor;
    }

    .price-level-name {
        position: absolute;
        left: 8px;
        transform: translateY(-50%);
        font-size: 10px;
        font-weight: var(--font-bold);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 2px 6px;
        border-radius: 3px;
        background: currentColor;
        color: #000;
    }

    .price-levels-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        justify-content: center;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: var(--text-xs);
        color: var(--text-secondary);
    }

    .legend-dot {
        width: 10px;
        height: 10px;
        border-radius: 2px;
    }

    .legend-dot.entry { background: #22c55e; }
    .legend-dot.stop { background: #ef4444; }
    .legend-dot.tp1 { background: #22d3ee; }
    .legend-dot.tp2 { background: #a855f7; }
    .legend-dot.tp3 { background: #f59e0b; }
    .legend-dot.current { background: var(--accent-cyan); }

    /* Risk/Reward Visual Bar */
    .rr-visual {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid var(--border-subtle);
    }

    .rr-bar-container {
        display: flex;
        height: 24px;
        border-radius: var(--radius-sm);
        overflow: hidden;
        margin-top: 8px;
    }

    .rr-bar-risk {
        background: linear-gradient(90deg, #ef4444, #dc2626);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: var(--font-bold);
        color: white;
    }

    .rr-bar-reward {
        background: linear-gradient(90deg, #22c55e, #16a34a);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: var(--font-bold);
        color: white;
        flex: 1;
    }

    .rr-stats {
        display: flex;
        justify-content: space-between;
        margin-top: 8px;
        font-size: var(--text-xs);
        color: var(--text-tertiary);
    }

    .rr-stat {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
    }

    .rr-stat-value {
        font-family: 'JetBrains Mono', monospace;
        font-weight: var(--font-semibold);
    }

    .rr-stat-value.risk { color: #ef4444; }
    .rr-stat-value.reward { color: #22c55e; }

    /* ============================================
       NEW SIGNAL DISPLAY - Clean & Professional
       ============================================ */

    /* Main Signal Hero */
    .signal-hero {
        background: var(--bg-card);
        border: 2px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        padding: 24px;
        text-align: center;
        margin-bottom: 16px;
        position: relative;
        overflow: hidden;
    }

    .signal-hero.long {
        border-color: var(--success);
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), var(--bg-card));
    }

    .signal-hero.short {
        border-color: var(--danger);
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), var(--bg-card));
    }

    .signal-hero.wait {
        border-color: #f59e0b;
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), var(--bg-card));
    }

    .signal-hero-badge {
        display: inline-block;
        padding: 8px 24px;
        border-radius: var(--radius-lg);
        font-size: 2rem;
        font-weight: var(--font-black);
        font-family: 'JetBrains Mono', monospace;
        letter-spacing: 2px;
        margin-bottom: 12px;
    }

    .signal-hero.long .signal-hero-badge {
        background: var(--success);
        color: #000;
    }

    .signal-hero.short .signal-hero-badge {
        background: var(--danger);
        color: #fff;
    }

    .signal-hero.wait .signal-hero-badge {
        background: #f59e0b;
        color: #000;
    }

    .signal-hero-subtitle {
        font-size: var(--text-sm);
        color: var(--text-secondary);
        margin-bottom: 16px;
    }

    /* Setup Grade */
    .setup-grade {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 12px;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border-subtle);
    }

    .grade-circle {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: var(--font-black);
        font-family: 'JetBrains Mono', monospace;
    }

    .grade-circle.grade-a {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: #fff;
        box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4);
    }

    .grade-circle.grade-b {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: #fff;
        box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
    }

    .grade-circle.grade-c {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: #000;
        box-shadow: 0 4px 20px rgba(245, 158, 11, 0.4);
    }

    .grade-circle.grade-f {
        background: linear-gradient(135deg, #6b7280, #4b5563);
        color: #fff;
    }

    .grade-info {
        text-align: left;
    }

    .grade-label {
        font-size: var(--text-xs);
        color: var(--text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .grade-description {
        font-size: var(--text-sm);
        color: var(--text-secondary);
        font-weight: var(--font-medium);
    }

    /* Trade Levels Card */
    .trade-levels-card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        padding: 20px;
        margin-bottom: 16px;
    }

    .trade-levels-title {
        font-size: var(--text-sm);
        font-weight: var(--font-semibold);
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .trade-level-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: var(--bg-hover);
        border-radius: var(--radius-md);
        margin-bottom: 8px;
        transition: all var(--transition-fast);
    }

    .trade-level-row:hover {
        background: rgba(0, 217, 255, 0.05);
    }

    .trade-level-row:last-child {
        margin-bottom: 0;
    }

    .trade-level-row.entry {
        border-left: 4px solid var(--success);
    }

    .trade-level-row.stop {
        border-left: 4px solid var(--danger);
    }

    .trade-level-row.tp {
        border-left: 4px solid var(--accent-cyan);
    }

    .trade-level-label {
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        color: var(--text-secondary);
    }

    .trade-level-value {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .trade-level-price {
        font-family: 'JetBrains Mono', monospace;
        font-size: 1.1rem;
        font-weight: var(--font-bold);
    }

    .trade-level-row.entry .trade-level-price { color: var(--success); }
    .trade-level-row.stop .trade-level-price { color: var(--danger); }
    .trade-level-row.tp .trade-level-price { color: var(--accent-cyan); }

    .trade-level-percent {
        font-size: var(--text-xs);
        padding: 2px 6px;
        border-radius: var(--radius-sm);
        font-family: 'JetBrains Mono', monospace;
    }

    .trade-level-row.entry .trade-level-percent { background: rgba(34, 197, 94, 0.15); color: var(--success); }
    .trade-level-row.stop .trade-level-percent { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
    .trade-level-row.tp .trade-level-percent { background: rgba(0, 217, 255, 0.15); color: var(--accent-cyan); }

    .copy-level-btn {
        padding: 6px 10px;
        background: transparent;
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-sm);
        color: var(--text-tertiary);
        font-size: var(--text-xs);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .copy-level-btn:hover {
        background: var(--bg-hover);
        border-color: var(--accent-cyan);
        color: var(--accent-cyan);
    }

    /* Key Reasons Card */
    .key-reasons-card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        padding: 20px;
        margin-bottom: 16px;
    }

    .key-reasons-title {
        font-size: var(--text-sm);
        font-weight: var(--font-semibold);
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 12px;
    }

    .reason-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        background: var(--bg-hover);
        border: 1px solid var(--border-subtle);
        border-radius: 20px;
        font-size: var(--text-sm);
        margin: 4px;
        transition: all var(--transition-fast);
    }

    .reason-chip.bullish {
        border-color: rgba(34, 197, 94, 0.3);
        background: rgba(34, 197, 94, 0.1);
    }

    .reason-chip.bearish {
        border-color: rgba(239, 68, 68, 0.3);
        background: rgba(239, 68, 68, 0.1);
    }

    .reason-chip-icon {
        font-size: 14px;
    }

    /* Warning Banner */
    .warning-banner {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: rgba(245, 158, 11, 0.1);
        border: 1px solid rgba(245, 158, 11, 0.3);
        border-radius: var(--radius-lg);
        margin-bottom: 16px;
    }

    .warning-banner-icon {
        font-size: 1.5rem;
    }

    .warning-banner-text {
        font-size: var(--text-sm);
        color: #f59e0b;
    }

    /* Collapsible Advanced Section */
    .advanced-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px;
        background: var(--bg-hover);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        cursor: pointer;
        font-size: var(--text-sm);
        color: var(--text-tertiary);
        margin-bottom: 16px;
        transition: all var(--transition-fast);
    }

    .advanced-toggle:hover {
        background: rgba(0, 217, 255, 0.05);
        border-color: var(--accent-cyan);
        color: var(--accent-cyan);
    }

    .advanced-section {
        display: none;
    }

    .advanced-section.show {
        display: block;
    }

    /* Mobile Improvements */
    @media (max-width: 768px) {
        .top-bar {
            flex-direction: column;
            align-items: flex-start;
        }

        .keyboard-hint {
            display: none;
        }

        .search-row {
            flex-direction: column;
            align-items: stretch;
        }

        .search-form {
            flex-direction: column;
        }

        .search-input {
            max-width: 100%;
        }

        .timeframe-tabs {
            margin-left: 0;
            justify-content: center;
            width: 100%;
        }

        .calc-inputs {
            grid-template-columns: 1fr;
        }

        .calc-results {
            grid-template-columns: 1fr;
        }

        .quick-access {
            flex-direction: column;
        }
    }

    /* Main Grid */
    .scalp-grid {
        display: grid;
        grid-template-columns: 1fr 420px;
        gap: 24px;
    }

    @media (max-width: 1200px) {
        .scalp-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Chart Section */
    .chart-section {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        overflow: hidden;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid var(--border-subtle);
    }

    .ticker-display {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .ticker-symbol {
        font-size: 1.5rem;
        font-weight: var(--font-bold);
        font-family: 'JetBrains Mono', monospace;
        background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .ticker-price {
        font-size: 1.25rem;
        font-weight: var(--font-semibold);
        font-family: 'JetBrains Mono', monospace;
    }

    .ticker-change {
        font-size: var(--text-sm);
        padding: 4px 10px;
        border-radius: var(--radius-sm);
    }

    .ticker-change.positive {
        color: var(--success);
        background: rgba(34, 197, 94, 0.1);
    }

    .ticker-change.negative {
        color: var(--danger);
        background: rgba(239, 68, 68, 0.1);
    }

    /* Analysis Panel */
    .analysis-panel {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .signal-card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        padding: 28px 24px;
        text-align: center;
        transition: all var(--transition-fast);
        position: relative;
        overflow: hidden;
    }

    .signal-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--border-subtle);
    }

    .signal-card.bullish {
        border-color: rgba(34, 197, 94, 0.3);
        background: linear-gradient(180deg, rgba(34, 197, 94, 0.08) 0%, rgba(34, 197, 94, 0.02) 100%);
        box-shadow: 0 0 30px rgba(34, 197, 94, 0.1);
    }

    .signal-card.bullish::before {
        background: linear-gradient(90deg, transparent, var(--success), transparent);
    }

    .signal-card.bearish {
        border-color: rgba(239, 68, 68, 0.3);
        background: linear-gradient(180deg, rgba(239, 68, 68, 0.08) 0%, rgba(239, 68, 68, 0.02) 100%);
        box-shadow: 0 0 30px rgba(239, 68, 68, 0.1);
    }

    .signal-card.bearish::before {
        background: linear-gradient(90deg, transparent, var(--danger), transparent);
    }

    .signal-card.neutral {
        border-color: rgba(234, 179, 8, 0.3);
        background: linear-gradient(180deg, rgba(234, 179, 8, 0.08) 0%, rgba(234, 179, 8, 0.02) 100%);
        box-shadow: 0 0 30px rgba(234, 179, 8, 0.1);
    }

    .signal-card.neutral::before {
        background: linear-gradient(90deg, transparent, #eab308, transparent);
    }

    .signal-icon {
        width: 56px;
        height: 56px;
        margin: 0 auto 16px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }

    .signal-icon.bullish {
        background: rgba(34, 197, 94, 0.15);
        border: 2px solid var(--success);
    }

    .signal-icon.bearish {
        background: rgba(239, 68, 68, 0.15);
        border: 2px solid var(--danger);
    }

    .signal-icon.neutral {
        background: rgba(234, 179, 8, 0.15);
        border: 2px solid #eab308;
    }

    .signal-icon.loading {
        background: rgba(0, 217, 255, 0.1);
        border: 2px solid var(--border-subtle);
    }

    .signal-icon::before {
        content: '';
        position: absolute;
    }

    .signal-icon.bullish::before {
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-bottom: 16px solid var(--success);
    }

    .signal-icon.bearish::before {
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-top: 16px solid var(--danger);
    }

    .signal-icon.neutral::before {
        width: 20px;
        height: 4px;
        background: #eab308;
        border-radius: 2px;
    }

    .signal-icon.loading::before {
        width: 24px;
        height: 24px;
        border: 3px solid var(--border-subtle);
        border-top-color: var(--accent-cyan);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .signal-text {
        font-size: 1.5rem;
        font-weight: var(--font-bold);
        margin-bottom: 8px;
    }

    .signal-text.bullish { color: var(--success); }
    .signal-text.bearish { color: var(--danger); }
    .signal-text.neutral { color: #eab308; }

    .signal-confidence {
        font-size: var(--text-sm);
        color: var(--text-secondary);
    }

    /* Reasoning List */
    .reasoning-list {
        margin-top: 12px;
        text-align: left;
        font-size: var(--text-xs);
        color: var(--text-tertiary);
    }

    .reasoning-item {
        padding: 4px 0;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .reasoning-item::before {
        content: "•";
        color: var(--accent-cyan);
    }

    /* Cards */
    .indicators-card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        padding: 20px;
        transition: border-color var(--transition-fast);
    }

    .indicators-card:hover {
        border-color: rgba(0, 217, 255, 0.2);
    }

    .card-title {
        font-size: var(--text-sm);
        font-weight: var(--font-semibold);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border-subtle);
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--text-secondary);
    }

    .card-badge {
        font-size: 10px;
        padding: 3px 8px;
        border-radius: var(--radius-sm);
        background: rgba(0, 217, 255, 0.1);
        color: var(--accent-cyan);
        font-weight: var(--font-semibold);
        font-family: 'JetBrains Mono', monospace;
        border: 1px solid rgba(0, 217, 255, 0.2);
    }

    .indicator-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    }

    .indicator-row:last-child {
        border-bottom: none;
    }

    .indicator-name {
        color: var(--text-tertiary);
        font-size: var(--text-sm);
    }

    .indicator-value {
        font-family: 'JetBrains Mono', monospace;
        font-weight: var(--font-medium);
        font-size: var(--text-sm);
    }

    .indicator-value.bullish { color: var(--success); }
    .indicator-value.bearish { color: var(--danger); }

    /* Pattern Badge */
    .pattern-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: var(--radius-sm);
        font-size: var(--text-xs);
        font-weight: var(--font-medium);
        margin: 2px;
    }

    .pattern-badge.bullish {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success);
        border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .pattern-badge.bearish {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .pattern-badge.neutral {
        background: rgba(234, 179, 8, 0.1);
        color: #eab308;
        border: 1px solid rgba(234, 179, 8, 0.3);
    }

    /* Volume Bar */
    .volume-bar-container {
        margin-top: 8px;
        background: var(--bg-hover);
        border-radius: var(--radius-sm);
        height: 8px;
        overflow: hidden;
    }

    .volume-bar {
        height: 100%;
        border-radius: var(--radius-sm);
        transition: width 0.3s ease;
    }

    .volume-bar.low { background: var(--text-tertiary); }
    .volume-bar.normal { background: var(--accent-cyan); }
    .volume-bar.high { background: var(--success); }
    .volume-bar.spike { background: linear-gradient(135deg, var(--success), #22c55e); }

    /* AI Analysis Card */
    .ai-analysis-card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        padding: 20px;
        flex: 1;
        transition: border-color var(--transition-fast);
    }

    .ai-analysis-card:hover {
        border-color: rgba(0, 217, 255, 0.2);
    }

    .ai-analysis-content {
        font-size: var(--text-sm);
        line-height: 1.7;
        color: var(--text-secondary);
    }

    .ai-analysis-content strong {
        color: var(--text-primary);
    }

    /* Trade Setup Box */
    .trade-setup-box {
        background: linear-gradient(180deg, rgba(0, 217, 255, 0.03) 0%, transparent 100%);
        border: 1px solid rgba(0, 217, 255, 0.15);
        border-radius: var(--radius-lg);
        padding: 16px;
        margin-top: 16px;
    }

    .trade-setup-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .trade-setup-title {
        font-weight: var(--font-semibold);
        font-size: var(--text-xs);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-secondary);
    }

    .trade-setup-rr {
        font-family: 'JetBrains Mono', monospace;
        padding: 4px 10px;
        background: rgba(234, 179, 8, 0.1);
        color: #eab308;
        border-radius: var(--radius-sm);
        font-size: var(--text-xs);
        font-weight: var(--font-bold);
        border: 1px solid rgba(234, 179, 8, 0.2);
    }

    .entry-exit-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
    }

    .entry-exit-label {
        color: var(--text-tertiary);
        font-size: var(--text-sm);
    }

    .entry-exit-value {
        font-family: 'JetBrains Mono', monospace;
        font-weight: var(--font-semibold);
    }

    .entry-exit-value.green { color: var(--success); }
    .entry-exit-value.red { color: var(--danger); }
    .entry-exit-value.yellow { color: #eab308; }

    .reasoning-text {
        font-size: var(--text-xs);
        color: var(--text-tertiary);
        margin-top: 4px;
        font-style: italic;
    }

    /* Loading State */
    .loading-overlay {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 48px;
        color: var(--text-tertiary);
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--border-subtle);
        border-top-color: var(--accent-cyan);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 16px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 80px 24px;
        color: var(--text-tertiary);
    }

    .empty-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 24px;
        background: linear-gradient(135deg, rgba(0, 217, 255, 0.1), rgba(139, 92, 246, 0.1));
        border: 1px solid var(--border-subtle);
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }

    .empty-icon::before {
        content: '';
        width: 32px;
        height: 24px;
        border: 3px solid var(--accent-cyan);
        border-radius: 4px;
        position: relative;
    }

    .empty-icon::after {
        content: '';
        position: absolute;
        width: 16px;
        height: 16px;
        background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
        border-radius: 50%;
        bottom: 20px;
        right: 24px;
    }

    .empty-title {
        font-size: 1.25rem;
        font-weight: var(--font-semibold);
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .empty-desc {
        font-size: var(--text-sm);
        max-width: 300px;
        margin: 0 auto;
    }

    /* Risk Warning */
    .risk-warning {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: var(--radius-lg);
        padding: 12px 16px;
        font-size: var(--text-xs);
        color: var(--text-secondary);
        margin-top: 16px;
    }

    .risk-warning strong {
        color: var(--danger);
    }

    /* Strategy Info */
    .strategy-info {
        background: rgba(0, 217, 255, 0.05);
        border: 1px solid rgba(0, 217, 255, 0.2);
        border-radius: var(--radius-lg);
        padding: 12px 16px;
        font-size: var(--text-xs);
        color: var(--text-secondary);
        margin-bottom: 24px;
    }

    .strategy-info strong {
        color: var(--accent-cyan);
    }

    .strategy-weights {
        display: flex;
        gap: 16px;
        margin-top: 8px;
    }

    .weight-item {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .weight-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .weight-dot.candle { background: var(--accent-cyan); }
    .weight-dot.volume { background: var(--accent-purple); }
    .weight-dot.vwap { background: #eab308; }
    .weight-dot.confluence { background: var(--success); }

    /* Confluence Card */
    .confluence-card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        padding: 20px;
        transition: all var(--transition-fast);
    }

    .confluence-card.met {
        border-color: rgba(34, 197, 94, 0.4);
        background: linear-gradient(180deg, rgba(34, 197, 94, 0.08) 0%, transparent 100%);
    }

    .confluence-card.not-met {
        border-color: rgba(234, 179, 8, 0.4);
        background: linear-gradient(180deg, rgba(234, 179, 8, 0.08) 0%, transparent 100%);
    }

    .confluence-status {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        border-radius: var(--radius-md);
        margin-bottom: 16px;
        font-weight: var(--font-semibold);
        font-size: var(--text-sm);
    }

    .confluence-status.met {
        background: rgba(34, 197, 94, 0.15);
        color: var(--success);
        border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .confluence-status.not-met {
        background: rgba(234, 179, 8, 0.15);
        color: #eab308;
        border: 1px solid rgba(234, 179, 8, 0.3);
    }

    .confluence-reasons {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .reason-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
    }

    .reason-item.bullish {
        border-left: 3px solid var(--success);
    }

    .reason-item.bearish {
        border-left: 3px solid var(--danger);
    }

    .reason-text {
        color: var(--text-secondary);
        flex: 1;
    }

    .reason-score {
        font-family: 'JetBrains Mono', monospace;
        font-weight: var(--font-semibold);
        font-size: var(--text-xs);
        padding: 2px 8px;
        border-radius: var(--radius-sm);
    }

    .reason-score.bullish {
        background: rgba(34, 197, 94, 0.15);
        color: var(--success);
    }

    .reason-score.bearish {
        background: rgba(239, 68, 68, 0.15);
        color: var(--danger);
    }

    /* Advanced Analysis Cards */
    .advanced-card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        padding: 20px;
        transition: border-color var(--transition-fast);
    }

    .advanced-card:hover {
        border-color: rgba(0, 217, 255, 0.2);
    }

    .zone-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: var(--radius-md);
        font-size: var(--text-xs);
        font-weight: var(--font-medium);
        margin: 4px 0;
    }

    .zone-badge.bullish {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success);
        border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .zone-badge.bearish {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .zone-badge.special {
        background: rgba(139, 92, 246, 0.15);
        color: var(--accent-purple);
        border: 1px solid rgba(139, 92, 246, 0.3);
    }

    .double-engulfing-badge {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(0, 217, 255, 0.2));
        color: var(--text-primary);
        border: 1px solid var(--accent-purple);
        padding: 8px 14px;
        border-radius: var(--radius-md);
        font-weight: var(--font-bold);
        text-align: center;
        margin: 8px 0;
    }

    /* Exit Warning */
    .exit-warning {
        background: rgba(234, 179, 8, 0.15);
        border: 1px solid rgba(234, 179, 8, 0.4);
        border-radius: var(--radius-md);
        padding: 12px 16px;
        margin-top: 12px;
        font-size: var(--text-sm);
        color: #eab308;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .exit-warning::before {
        content: "⚠️";
    }

    /* Fakeout/Trap Card */
    .trap-badge {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(0, 217, 255, 0.2));
        border: 1px solid var(--success);
        padding: 12px 16px;
        border-radius: var(--radius-lg);
        margin-top: 8px;
    }

    .trap-badge .trap-title {
        font-weight: var(--font-bold);
        color: var(--success);
        margin-bottom: 4px;
    }

    .trap-badge .trap-detail {
        font-size: var(--text-xs);
        color: var(--text-secondary);
    }

    .trap-badge.bearish {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(139, 92, 246, 0.2));
        border-color: var(--danger);
    }

    .trap-badge.bearish .trap-title {
        color: var(--danger);
    }
</style>
{% endblock %}

{% block content %}
<div class="content-header">
    <div>
        <h1 class="content-title">Scalp Trading Analysis</h1>
        <p class="content-subtitle">Candlestick + Volume based signals with clear entry/stop/target reasoning</p>
    </div>
</div>

<!-- Top Bar - Market Status & Controls -->
<div class="top-bar">
    <div class="market-status">
        <span class="status-dot" id="marketStatusDot"></span>
        <span id="marketStatusText">Checking market...</span>
        <span id="marketTime" style="margin-left: 8px; font-family: 'JetBrains Mono', monospace; color: var(--text-tertiary);"></span>
    </div>
    <div class="auto-refresh-toggle">
        <span>Auto-refresh</span>
        <div class="toggle-switch" id="autoRefreshToggle" onclick="toggleAutoRefresh()"></div>
        <span class="refresh-countdown" id="refreshCountdown">--</span>
    </div>
    <div class="keyboard-hint">
        <span><span class="kbd">R</span> Refresh</span>
        <span><span class="kbd">F</span> Focus search</span>
        <span><span class="kbd">1-5</span> Timeframe</span>
        <span><span class="kbd">W</span> Watchlist</span>
    </div>
</div>

<!-- Strategy Info - 쉽알 Strategy -->
<div class="strategy-info">
    <strong>Strategy:</strong> 쉽알 Trading Method - Confluence-based scalping with minimum 2 reasons required for entry
    <div class="strategy-weights">
        <div class="weight-item"><span class="weight-dot candle"></span> Order Blocks (장악형)</div>
        <div class="weight-item"><span class="weight-dot volume"></span> FVG (Fair Value Gap)</div>
        <div class="weight-item"><span class="weight-dot vwap"></span> Fakeout/Trap</div>
        <div class="weight-item"><span class="weight-dot confluence"></span> Confluence Scoring</div>
    </div>
    <div style="margin-top: 8px; font-size: var(--text-xs); color: var(--text-tertiary);">
        <strong style="color: var(--accent-cyan);">Key Rule:</strong> 최소 2개 근거 필요 (Minimum 2 confluences required) |
        <strong style="color: var(--success);">US Stocks</strong> &amp;
        <strong style="color: #f7931a;">Crypto</strong> supported
    </div>
</div>

<!-- Search Section -->
<div class="search-section">
    <div class="search-row">
        <form class="search-form" id="searchForm" onsubmit="return analyzeStock(event)">
            <input type="text" class="search-input" id="tickerInput" placeholder="AAPL or BTCUSDT" maxlength="12" required>
            <button type="submit" class="search-btn" id="analyzeBtn">Analyze</button>
            <button type="button" class="watchlist-btn" id="watchlistBtn" onclick="toggleWatchlist()" title="Add to Watchlist">+ Watch</button>
        </form>
        <div class="timeframe-tabs">
            <button type="button" class="timeframe-tab" data-interval="1" onclick="setTimeframe('1')">1m</button>
            <button type="button" class="timeframe-tab active" data-interval="5" onclick="setTimeframe('5')">5m</button>
            <button type="button" class="timeframe-tab" data-interval="15" onclick="setTimeframe('15')">15m</button>
            <button type="button" class="timeframe-tab" data-interval="30" onclick="setTimeframe('30')">30m</button>
            <button type="button" class="timeframe-tab" data-interval="60" onclick="setTimeframe('60')">1h</button>
        </div>
    </div>
    <div class="quick-access">
        <div class="quick-access-section" id="recentSearches">
            <span class="quick-access-label">Recent:</span>
            <!-- Populated by JS -->
        </div>
        <div class="quick-access-section" id="watchlistSection">
            <span class="quick-access-label">Watchlist:</span>
            <!-- Populated by JS -->
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="scalp-grid">
    <!-- Chart Section -->
    <div class="chart-section">
        <div class="chart-header" id="chartHeader" style="display: none;">
            <div class="ticker-display">
                <span class="ticker-symbol" id="displayTicker">--</span>
                <span class="ticker-price" id="displayPrice">$--</span>
                <span class="ticker-change" id="displayChange">--</span>
            </div>
        </div>
        <div id="chartContainer">
            <div class="empty-state">
                <div class="empty-icon"></div>
                <div class="empty-title">Enter a Ticker Symbol</div>
                <div class="empty-desc">Search for US stocks (AAPL, TSLA) or crypto pairs (BTCUSDT, ETHUSDT) for candlestick pattern analysis</div>
            </div>
        </div>

        <!-- Price Levels Visual Panel -->
        <div class="price-levels-panel" id="priceLevelsPanel">
            <div class="price-levels-header">
                <span class="price-levels-title">Trade Levels Visualization</span>
                <span class="current-price-tag" id="currentPriceTag">$--</span>
            </div>

            <div class="price-levels-visual" id="priceLevelsVisual">
                <!-- Lines will be dynamically added -->
                <div class="price-level-line tp3" id="levelTp3" style="top: 5%;">
                    <span class="price-level-name">TP3</span>
                    <span class="price-level-label" id="labelTp3">$--</span>
                </div>
                <div class="price-level-line tp2" id="levelTp2" style="top: 20%;">
                    <span class="price-level-name">TP2</span>
                    <span class="price-level-label" id="labelTp2">$--</span>
                </div>
                <div class="price-level-line tp1" id="levelTp1" style="top: 35%;">
                    <span class="price-level-name">TP1</span>
                    <span class="price-level-label" id="labelTp1">$--</span>
                </div>
                <div class="price-level-line entry" id="levelEntry" style="top: 50%;">
                    <span class="price-level-name">ENTRY</span>
                    <span class="price-level-label" id="labelEntry">$--</span>
                </div>
                <div class="price-level-line current" id="levelCurrent" style="top: 55%;">
                    <span class="price-level-label" id="labelCurrent">NOW</span>
                </div>
                <div class="price-level-line stop" id="levelStop" style="top: 85%;">
                    <span class="price-level-name">STOP</span>
                    <span class="price-level-label" id="labelStop">$--</span>
                </div>
            </div>

            <div class="price-levels-legend">
                <div class="legend-item"><span class="legend-dot current"></span> Current Price</div>
                <div class="legend-item"><span class="legend-dot entry"></span> Entry</div>
                <div class="legend-item"><span class="legend-dot stop"></span> Stop Loss</div>
                <div class="legend-item"><span class="legend-dot tp1"></span> TP1</div>
                <div class="legend-item"><span class="legend-dot tp2"></span> TP2</div>
                <div class="legend-item"><span class="legend-dot tp3"></span> TP3</div>
            </div>

            <!-- Risk/Reward Visual -->
            <div class="rr-visual">
                <div class="price-levels-title">Risk / Reward Ratio</div>
                <div class="rr-bar-container">
                    <div class="rr-bar-risk" id="rrBarRisk" style="width: 33%;">RISK</div>
                    <div class="rr-bar-reward" id="rrBarReward">REWARD</div>
                </div>
                <div class="rr-stats">
                    <div class="rr-stat">
                        <span class="rr-stat-value risk" id="rrRiskPercent">--%</span>
                        <span>Risk</span>
                    </div>
                    <div class="rr-stat">
                        <span class="rr-stat-value" id="rrRatio">1:2</span>
                        <span>R:R Ratio</span>
                    </div>
                    <div class="rr-stat">
                        <span class="rr-stat-value reward" id="rrRewardPercent">--%</span>
                        <span>Reward (TP1)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Panel - NEW CLEAN DESIGN -->
    <div class="analysis-panel" id="analysisPanel" style="display: none;">

        <!-- 1. MAIN SIGNAL HERO -->
        <div class="signal-hero wait" id="signalHero">
            <div class="signal-hero-badge" id="signalBadge">WAIT</div>
            <div class="signal-hero-subtitle" id="signalSubtitle">Analyzing market conditions...</div>

            <div class="setup-grade">
                <div class="grade-circle grade-f" id="gradeCircle">-</div>
                <div class="grade-info">
                    <div class="grade-label">Setup Quality</div>
                    <div class="grade-description" id="gradeDescription">Waiting for signal</div>
                </div>
            </div>
        </div>

        <!-- Warning Banner (if applicable) -->
        <div class="warning-banner" id="warningBanner" style="display: none;">
            <span class="warning-banner-icon">⚠️</span>
            <span class="warning-banner-text" id="warningText"></span>
        </div>

        <!-- 2. TRADE LEVELS - Entry/Stop/TP -->
        <div class="trade-levels-card" id="tradeLevelsCard" style="display: none;">
            <div class="trade-levels-title">
                <span>Trade Levels</span>
                <button class="copy-level-btn" onclick="copyAllLevels()">Copy All</button>
            </div>

            <div class="trade-level-row entry">
                <span class="trade-level-label">Entry</span>
                <div class="trade-level-value">
                    <span class="trade-level-price" id="lvlEntry">$--</span>
                    <span class="trade-level-percent" id="lvlEntryPct">--%</span>
                    <button class="copy-level-btn" onclick="copyLevel('lvlEntry')">Copy</button>
                </div>
            </div>

            <div class="trade-level-row stop">
                <span class="trade-level-label">Stop Loss</span>
                <div class="trade-level-value">
                    <span class="trade-level-price" id="lvlStop">$--</span>
                    <span class="trade-level-percent" id="lvlStopPct">--%</span>
                    <button class="copy-level-btn" onclick="copyLevel('lvlStop')">Copy</button>
                </div>
            </div>

            <div class="trade-level-row tp">
                <span class="trade-level-label">Take Profit 1</span>
                <div class="trade-level-value">
                    <span class="trade-level-price" id="lvlTp1">$--</span>
                    <span class="trade-level-percent" id="lvlTp1Pct">--%</span>
                    <button class="copy-level-btn" onclick="copyLevel('lvlTp1')">Copy</button>
                </div>
            </div>

            <div class="trade-level-row tp">
                <span class="trade-level-label">Take Profit 2</span>
                <div class="trade-level-value">
                    <span class="trade-level-price" id="lvlTp2">$--</span>
                    <span class="trade-level-percent" id="lvlTp2Pct">--%</span>
                    <button class="copy-level-btn" onclick="copyLevel('lvlTp2')">Copy</button>
                </div>
            </div>
        </div>

        <!-- 3. KEY REASONS -->
        <div class="key-reasons-card">
            <div class="key-reasons-title">Why This Signal?</div>
            <div id="keyReasons">
                <span class="reason-chip"><span class="reason-chip-icon">⏳</span> Analyzing...</span>
            </div>
        </div>

        <!-- 4. TOGGLE FOR ADVANCED DETAILS -->
        <div class="advanced-toggle" onclick="toggleAdvanced()">
            <span id="advancedToggleIcon">▼</span>
            <span>Show Advanced Analysis</span>
        </div>

        <!-- 5. ADVANCED SECTION (Hidden by default) -->
        <div class="advanced-section" id="advancedSection">
            <!-- Confluence Analysis (쉽알 Strategy) -->
            <div class="confluence-card" id="confluenceCard">
                <div class="card-title">
                    Confluence Analysis
                    <span class="card-badge">쉽알</span>
                </div>
                <div class="confluence-status not-met" id="confluenceStatus">
                    <span id="confluenceStatusIcon">⏳</span>
                    <span id="confluenceStatusText">Analyzing confluences...</span>
                </div>
                <div class="confluence-reasons" id="confluenceReasons">
                    <!-- Dynamically populated -->
                </div>
            </div>

            <!-- FVG & Order Blocks -->
            <div class="advanced-card">
                <div class="card-title">
                    FVG & Order Blocks
                    <span class="card-badge">S/R Zones</span>
                </div>
                <div id="fvgSection">
                    <div class="indicator-row">
                        <span class="indicator-name">At FVG Zone</span>
                        <span class="indicator-value" id="atFvg">--</span>
                    </div>
                    <div class="indicator-row">
                        <span class="indicator-name">FVG Count</span>
                        <span class="indicator-value" id="fvgCount">--</span>
                    </div>
                </div>
                <div id="orderBlockSection" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-subtle);">
                    <div class="indicator-row">
                        <span class="indicator-name">At Order Block</span>
                        <span class="indicator-value" id="atOb">--</span>
                    </div>
                    <div id="doubleObSection"></div>
                </div>
            </div>

            <!-- Fakeout/Trap Detection -->
            <div class="advanced-card">
                <div class="card-title">
                    Fakeout & Trap
                    <span class="card-badge">Entry Signal</span>
                </div>
                <div id="fakeoutSection">
                    <div class="indicator-row">
                        <span class="indicator-name">Fakeout</span>
                        <span class="indicator-value" id="fakeoutStatus">--</span>
                    </div>
                    <div class="indicator-row">
                        <span class="indicator-name">Trap (Double Bottom/Top)</span>
                        <span class="indicator-value" id="trapStatus">--</span>
                    </div>
                    <div id="trapDetail"></div>
                </div>
            </div>
        </div>

        <!-- Candlestick Patterns -->
        <div class="indicators-card">
            <div class="card-title">
                Candlestick Patterns
                <span class="card-badge">75%</span>
            </div>
            <div id="candlePatterns">
                <div class="indicator-row">
                    <span class="indicator-name">Primary Pattern</span>
                    <span class="indicator-value" id="primaryPattern">--</span>
                </div>
            </div>
            <div class="indicator-row">
                <span class="indicator-name">Pattern Strength</span>
                <span class="indicator-value" id="patternStrength">--</span>
            </div>
            <div class="indicator-row">
                <span class="indicator-name">Pattern Bias</span>
                <span class="indicator-value" id="patternBias">--</span>
            </div>
            <div id="allPatterns" style="margin-top: 12px;"></div>
        </div>

        <!-- Volume Analysis -->
        <div class="indicators-card">
            <div class="card-title">
                Volume Analysis
                <span class="card-badge">15%</span>
            </div>
            <div class="indicator-row">
                <span class="indicator-name">Volume Ratio</span>
                <span class="indicator-value" id="volumeRatio">--</span>
            </div>
            <div class="indicator-row">
                <span class="indicator-name">Spike Detected</span>
                <span class="indicator-value" id="volumeSpike">--</span>
            </div>
            <div class="indicator-row">
                <span class="indicator-name">Volume Trend</span>
                <span class="indicator-value" id="volumeTrend">--</span>
            </div>
            <div class="volume-bar-container">
                <div class="volume-bar" id="volumeBar" style="width: 50%;"></div>
            </div>
            <!-- Volume Exit Warning (쉽알: 거래량 급증 = 익절 시그널) -->
            <div class="exit-warning" id="volumeExitWarning" style="display: none;">
                <span id="volumeExitText">Volume spike = Consider taking profits</span>
            </div>
        </div>

        <!-- Key Levels -->
        <div class="indicators-card">
            <div class="card-title">
                Key Levels
                <span class="card-badge">10%</span>
            </div>
            <div class="indicator-row">
                <span class="indicator-name">VWAP</span>
                <span class="indicator-value" id="vwapLevel">--</span>
            </div>
            <div class="indicator-row">
                <span class="indicator-name">Price vs VWAP</span>
                <span class="indicator-value" id="priceVsVwap">--</span>
            </div>
            <div class="indicator-row">
                <span class="indicator-name">Nearest Support</span>
                <span class="indicator-value bullish" id="supportLevel">--</span>
            </div>
            <div class="indicator-row">
                <span class="indicator-name">Nearest Resistance</span>
                <span class="indicator-value bearish" id="resistanceLevel">--</span>
            </div>
        </div>

        <!-- AI Analysis -->
        <div class="ai-analysis-card">
            <div class="card-title">Analysis</div>
            <div class="ai-analysis-content" id="aiAnalysis">
                <div class="loading-overlay">
                    <div class="spinner"></div>
                    <span>Waiting for analysis...</span>
                </div>
            </div>

            <!-- Trade Setup -->
            <div class="trade-setup-box" id="tradeSetupBox" style="display: none;">
                <div class="trade-setup-header">
                    <span class="trade-setup-title">Trade Setup</span>
                    <span class="trade-setup-rr" id="riskReward">R:R --</span>
                </div>
                <div class="entry-exit-row">
                    <span class="entry-exit-label">Entry Price</span>
                    <div class="entry-exit-value-wrapper">
                        <span class="entry-exit-value green" id="entryPrice">--</span>
                        <button class="copy-btn" onclick="copyValue('entryPrice')" title="Copy">📋</button>
                    </div>
                </div>
                <div class="reasoning-text" id="entryReasoning"></div>
                <div class="entry-exit-row">
                    <span class="entry-exit-label">Stop Loss</span>
                    <div class="entry-exit-value-wrapper">
                        <span class="entry-exit-value red" id="stopLoss">--</span>
                        <button class="copy-btn" onclick="copyValue('stopLoss')" title="Copy">📋</button>
                    </div>
                </div>
                <div class="reasoning-text" id="stopReasoning"></div>
                <div class="entry-exit-row">
                    <span class="entry-exit-label">Take Profit 1</span>
                    <div class="entry-exit-value-wrapper">
                        <span class="entry-exit-value green" id="takeProfit">--</span>
                        <button class="copy-btn" onclick="copyValue('takeProfit')" title="Copy">📋</button>
                    </div>
                </div>
                <div class="entry-exit-row">
                    <span class="entry-exit-label">Take Profit 2</span>
                    <div class="entry-exit-value-wrapper">
                        <span class="entry-exit-value green" id="takeProfit2">--</span>
                        <button class="copy-btn" onclick="copyValue('takeProfit2')" title="Copy">📋</button>
                    </div>
                </div>
                <div class="entry-exit-row">
                    <span class="entry-exit-label">Take Profit 3</span>
                    <div class="entry-exit-value-wrapper">
                        <span class="entry-exit-value green" id="takeProfit3">--</span>
                        <button class="copy-btn" onclick="copyValue('takeProfit3')" title="Copy">📋</button>
                    </div>
                </div>
                <div class="reasoning-text" id="targetReasoning"></div>
                <!-- R:R Warning -->
                <div class="exit-warning" id="rrWarning" style="display: none;">
                    <span id="rrWarningText"></span>
                </div>
                <button class="copy-btn" style="width: 100%; height: auto; padding: 8px; margin-top: 12px;" onclick="copyAllLevels()" title="Copy All">
                    📋 Copy All Levels
                </button>
            </div>

            <div class="risk-warning">
                <strong>Risk Warning:</strong> Scalp trading is high-risk. Never risk more than 1-2% of your account per trade. Minimum R:R of 1:2 recommended. Past performance does not guarantee future results.
            </div>

            <div class="last-updated" id="lastUpdated"></div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="toast-container">
    <div class="toast" id="toast"></div>
</div>
{% endblock %}

{% block extra_scripts %}
<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script>
    let currentTicker = '';
    let currentInterval = '5';
    let currentAssetType = 'stock';
    let tvWidget = null;
    let signalShapes = [];
    let chartReady = false;
    let pendingSignal = null;

    // Detect if ticker is crypto
    function isCryptoTicker(ticker) {
        const cryptoPatterns = [
            /^[A-Z]+USDT$/,  // BTCUSDT, ETHUSDT
            /^[A-Z]+BUSD$/,  // BTCBUSD
            /^[A-Z]+BTC$/,   // ETHBTC
            /^[A-Z]+ETH$/,   // ADAETH
            /^[A-Z]+BNB$/,   // ADABNB
        ];
        return cryptoPatterns.some(pattern => pattern.test(ticker.toUpperCase()));
    }

    // Get TradingView symbol (with exchange prefix)
    function getTVSymbol(ticker) {
        ticker = ticker.toUpperCase();
        if (isCryptoTicker(ticker)) {
            // Use BINANCE for TradingView (works globally)
            return `BINANCE:${ticker}`;
        }
        return ticker;  // Stocks use default exchange
    }

    function setTimeframe(interval) {
        currentInterval = interval;
        document.querySelectorAll('.timeframe-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.interval === interval);
        });
        if (currentTicker) {
            initChart(currentTicker);
            fetchAnalysis(currentTicker);
        }
    }

    function analyzeStock(event) {
        event.preventDefault();
        const ticker = document.getElementById('tickerInput').value.toUpperCase().trim();
        if (!ticker) return false;

        currentTicker = ticker;
        currentAssetType = isCryptoTicker(ticker) ? 'crypto' : 'stock';
        document.getElementById('chartHeader').style.display = 'flex';
        document.getElementById('analysisPanel').style.display = 'flex';

        // Show ticker with asset type badge
        const tickerDisplay = document.getElementById('displayTicker');
        const assetBadge = currentAssetType === 'crypto'
            ? '<span style="font-size: 0.6em; padding: 2px 6px; background: #f7931a; color: #000; border-radius: 4px; margin-left: 8px;">CRYPTO</span>'
            : '<span style="font-size: 0.6em; padding: 2px 6px; background: var(--success); color: #000; border-radius: 4px; margin-left: 8px;">STOCK</span>';
        tickerDisplay.innerHTML = ticker + assetBadge;

        initChart(ticker);
        fetchAnalysis(ticker);

        return false;
    }

    function initChart(ticker) {
        const container = document.getElementById('chartContainer');
        container.innerHTML = '<div id="tradingview_scalp" style="height:500px;"></div>';

        const tvSymbol = getTVSymbol(ticker);
        const timezone = isCryptoTicker(ticker) ? "Etc/UTC" : "America/New_York";

        chartReady = false;
        pendingSignal = null;

        tvWidget = new TradingView.widget({
            "autosize": true,
            "symbol": tvSymbol,
            "interval": currentInterval,
            "timezone": timezone,
            "theme": "dark",
            "style": "1",
            "locale": "en",
            "toolbar_bg": "#000000",
            "enable_publishing": false,
            "hide_side_toolbar": false,
            "allow_symbol_change": true,
            "container_id": "tradingview_scalp",
            "studies": [
                {"id": "VWAP@tv-basicstudies"},
                {"id": "Volume@tv-basicstudies"}
            ],
            "backgroundColor": "#000000",
            "gridColor": "#1a1a1a"
        });

        tvWidget.onChartReady(() => {
            chartReady = true;
            if (pendingSignal) {
                drawSignalOnChart(pendingSignal);
                pendingSignal = null;
            }
        });
    }

    function clearSignalShapes() {
        if (!tvWidget || !tvWidget.chart) return;
        const chart = tvWidget.chart();
        signalShapes.forEach(id => {
            try { chart.removeEntity(id); } catch (e) {}
        });
        signalShapes = [];
    }

    function drawSignalOnChart(signal) {
        if (!tvWidget) return;
        if (!chartReady) {
            pendingSignal = signal;
            return;
        }
        const chart = tvWidget.activeChart ? tvWidget.activeChart() : tvWidget.chart();
        if (!chart) return;
        clearSignalShapes();
        const addLine = (price, color, text) => {
            if (price === null || price === undefined) return;
            const id = chart.createShape(
                { price },
                {
                    shape: 'horizontal_line',
                    lock: true,
                    disableSelection: true,
                    disableSave: true,
                    text,
                    color,
                    textColor: color,
                }
            );
            if (id) signalShapes.push(id);
        };
        addLine(signal.entry, '#22c55e', 'Entry');
        addLine(signal.stop, '#ef4444', 'Stop');
        addLine(signal.tp1, '#22d3ee', 'TP1');
        addLine(signal.tp2, '#a855f7', 'TP2');
        addLine(signal.tp3, '#f59e0b', 'TP3');
    }

    async function fetchSignalAndOverlay(ticker) {
        // Map chart interval to API timeframe
        const tfMap = {
            '1': '1m',
            '5': '5m',
            '15': '15m',
            '30': '30m',
            '60': '1h'
        };
        const timeframe = tfMap[currentInterval] || '5m';

        try {
            const resp = await fetch('/api/scalp/signal', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ticker, timeframe, risk_reward: 2.0 })
            });
            const sig = await resp.json();

            // Get current price from display
            const priceEl = document.getElementById('displayPrice');
            const currentPrice = priceEl ? parseFloat(priceEl.textContent.replace(/[$,]/g, '')) : sig.entry;

            // ==========================================
            // UPDATE NEW SIGNAL UI
            // ==========================================
            const signalType = sig.signal || 'WAIT';
            const direction = sig.direction || 'neutral';
            const confidence = sig.confidence || 0;
            const reasons = sig.reason || [];

            // Update Signal Hero (main signal display)
            updateSignalHero(signalType, direction, confidence, reasons);

            // Update Trade Levels if we have entry/stop
            if (sig.entry && sig.stop) {
                updateTradeLevels(sig.entry, sig.stop, sig.tp1, sig.tp2, currentPrice);

                // Also update the old trade setup box for compatibility
                document.getElementById('tradeSetupBox').style.display = 'block';
                document.getElementById('entryPrice').textContent = `$${sig.entry.toFixed(4)}`;
                document.getElementById('stopLoss').textContent = `$${sig.stop.toFixed(4)}`;
                document.getElementById('takeProfit').textContent = `$${sig.tp1?.toFixed(4) || '--'}`;
                document.getElementById('takeProfit2').textContent = `$${sig.tp2?.toFixed(4) || '--'}`;
                document.getElementById('takeProfit3').textContent = `$${sig.tp3?.toFixed(4) || '--'}`;
                document.getElementById('riskReward').textContent = `1:${(sig.r_multiple || 2).toFixed(1)}`;
            } else {
                document.getElementById('tradeSetupBox').style.display = 'none';
            }

            // Update reasoning
            document.getElementById('entryReasoning').textContent = (reasons && reasons.length)
                ? reasons.slice(0, 3).join(' | ')
                : signalType === 'WAIT' ? '최소 2개 근거 필요' : 'Signal detected';
            document.getElementById('stopReasoning').textContent = 'Stop at zone boundary';
            document.getElementById('targetReasoning').textContent = 'TP1=2R, TP2=3R (Risk multiple targets)';
            document.getElementById('rrWarning').style.display = 'none';

            // Update key levels with S/R from signal if present
            if (sig.levels) {
                const supportEl = document.getElementById('supportLevel');
                const resistanceEl = document.getElementById('resistanceLevel');
                if (supportEl && sig.levels.support) {
                    supportEl.textContent = `$${sig.levels.support.toFixed(2)}`;
                }
                if (resistanceEl && sig.levels.resistance) {
                    resistanceEl.textContent = `$${sig.levels.resistance.toFixed(2)}`;
                }
            }

            // Update Price Levels Visualization
            if (currentPrice && sig.entry) {
                updatePriceLevelsVisual(currentPrice, sig.entry, sig.stop, sig.tp1, sig.tp2, sig.tp3);
            }

            // Draw on chart (if supported)
            if (sig.entry) {
                drawSignalOnChart(sig);
            }

        } catch (e) {
            console.warn('Signal fetch failed', e);
            updateSignalHero('WAIT', 'neutral', 0, ['Error fetching signal']);
            showToast('Signal fetch failed', 'error');
        }
    }

    function showToast(message, variant = 'info') {
        const toast = document.getElementById('toast');
        if (!toast) return;
        toast.textContent = message;
        toast.className = `toast ${variant}`;
        toast.style.display = 'block';
        setTimeout(() => { toast.style.display = 'none'; }, 3000);
    }

    async function fetchAnalysis(ticker) {
        // Show loading state
        document.getElementById('signalIcon').className = 'signal-icon loading';
        document.getElementById('signalText').textContent = 'Analyzing...';
        document.getElementById('signalText').className = 'signal-text';
        document.getElementById('signalCard').className = 'signal-card';
        document.getElementById('signalConfidence').textContent = 'Detecting candlestick patterns...';
        document.getElementById('tradeSetupBox').style.display = 'none';
        document.getElementById('reasoningList').innerHTML = '';

        document.getElementById('aiAnalysis').innerHTML = `
            <div class="loading-overlay">
                <div class="spinner"></div>
                <span>Analyzing candlestick patterns...</span>
            </div>
        `;

        try {
            // Add timeout to prevent hanging
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout

            const response = await fetch(`/api/scalp/analyze/${ticker}?interval=${currentInterval}`, {
                signal: controller.signal
            });
            clearTimeout(timeoutId);

            const data = await response.json();

            if (data.error) {
                throw new Error(data.error);
            }

            updateDisplay(data);
            await fetchSignalAndOverlay(ticker);
        } catch (error) {
            // Handle abort/timeout specifically
            if (error.name === 'AbortError') {
                error.message = 'Request timed out. The server is taking too long to respond.';
            }
            console.error('Analysis error:', error);
            document.getElementById('signalIcon').className = 'signal-icon bearish';
            document.getElementById('signalCard').className = 'signal-card bearish';
            document.getElementById('signalText').textContent = 'Error';
            document.getElementById('signalText').className = 'signal-text bearish';
            document.getElementById('signalConfidence').textContent = error.message || 'Failed to analyze';
            const assetHint = isCryptoTicker(ticker)
                ? 'Crypto pairs use Binance data (e.g., BTCUSDT, ETHUSDT)'
                : 'Stocks use Polygon data. Ensure market is open.';
            document.getElementById('aiAnalysis').innerHTML = `
                <div style="color: var(--danger); text-align: center; padding: 20px;">
                    Failed to analyze ${ticker}. Please try again.<br>
                    <small style="color: var(--text-tertiary);">${assetHint}</small>
                </div>
            `;
            updateSignalHero('WAIT', 'neutral', 0, [error.message || 'Analysis failed - check market status or try crypto pair']);
        }
    }

    function updateDisplay(data) {
        // Update price info
        const isCrypto = data.asset_type === 'crypto';
        if (data.price) {
            // Crypto shows more decimals for precision
            const priceDecimals = isCrypto ? (data.price < 1 ? 6 : 2) : 2;
            const priceSymbol = isCrypto ? '' : '$';
            const priceSuffix = isCrypto ? ' USDT' : '';
            document.getElementById('displayPrice').textContent = `${priceSymbol}${data.price.toFixed(priceDecimals)}${priceSuffix}`;
            const changeClass = data.change_percent >= 0 ? 'positive' : 'negative';
            const changeSign = data.change_percent >= 0 ? '+' : '';
            document.getElementById('displayChange').className = `ticker-change ${changeClass}`;
            document.getElementById('displayChange').textContent = `${changeSign}${data.change_percent.toFixed(2)}%`;
        }

        // Update signal card
        const signal = data.signal || 'WAIT';
        const signalCard = document.getElementById('signalCard');
        const signalIcon = document.getElementById('signalIcon');
        const signalText = document.getElementById('signalText');

        if (signal === 'LONG') {
            signalCard.className = 'signal-card bullish';
            signalIcon.className = 'signal-icon bullish';
            signalText.textContent = 'LONG SIGNAL';
            signalText.className = 'signal-text bullish';
        } else if (signal === 'SHORT') {
            signalCard.className = 'signal-card bearish';
            signalIcon.className = 'signal-icon bearish';
            signalText.textContent = 'SHORT SIGNAL';
            signalText.className = 'signal-text bearish';
        } else {
            signalCard.className = 'signal-card neutral';
            signalIcon.className = 'signal-icon neutral';
            signalText.textContent = 'WAIT';
            signalText.className = 'signal-text neutral';
        }

        document.getElementById('signalConfidence').textContent = `Confidence: ${data.confidence || '--'}%`;

        // Update reasoning list
        const reasoningList = document.getElementById('reasoningList');
        if (data.signal_reasoning && data.signal_reasoning.length > 0) {
            reasoningList.innerHTML = data.signal_reasoning.map(r =>
                `<div class="reasoning-item">${r}</div>`
            ).join('');
        } else {
            reasoningList.innerHTML = '';
        }

        // Update candlestick patterns
        const candle = data.candlestick || {};
        const primary = candle.primary_pattern;

        if (primary) {
            const typeClass = primary.type === 'bullish' ? 'bullish' : (primary.type === 'bearish' ? 'bearish' : '');
            document.getElementById('primaryPattern').innerHTML =
                `<span class="${typeClass}">${primary.name}</span>`;
            document.getElementById('patternStrength').textContent = `${primary.strength}/100`;
        } else {
            document.getElementById('primaryPattern').textContent = 'None detected';
            document.getElementById('patternStrength').textContent = '--';
        }

        const patternBias = document.getElementById('patternBias');
        const bias = candle.bias || 'neutral';
        patternBias.textContent = bias.charAt(0).toUpperCase() + bias.slice(1);
        patternBias.className = `indicator-value ${bias === 'bullish' ? 'bullish' : (bias === 'bearish' ? 'bearish' : '')}`;

        // Show all detected patterns
        const allPatternsEl = document.getElementById('allPatterns');
        const patterns = candle.patterns || [];
        if (patterns.length > 0) {
            allPatternsEl.innerHTML = patterns.map(p =>
                `<span class="pattern-badge ${p.type}">${p.name}</span>`
            ).join('');
        } else {
            allPatternsEl.innerHTML = '<span style="color: var(--text-tertiary); font-size: var(--text-xs);">No patterns detected in current candles</span>';
        }

        // Update volume analysis
        const volume = data.volume || {};
        const volumeRatio = volume.ratio || 1;
        document.getElementById('volumeRatio').textContent = `${volumeRatio.toFixed(1)}x avg`;

        const volumeSpike = document.getElementById('volumeSpike');
        if (volume.spike_detected) {
            volumeSpike.textContent = 'Yes';
            volumeSpike.className = 'indicator-value bullish';
        } else {
            volumeSpike.textContent = 'No';
            volumeSpike.className = 'indicator-value';
        }

        const volumeTrend = document.getElementById('volumeTrend');
        volumeTrend.textContent = (volume.trend || 'neutral').charAt(0).toUpperCase() + (volume.trend || 'neutral').slice(1);
        volumeTrend.className = `indicator-value ${volume.trend === 'increasing' ? 'bullish' : ''}`;

        // Update volume bar
        const volumeBar = document.getElementById('volumeBar');
        const barWidth = Math.min(100, volumeRatio * 50);
        volumeBar.style.width = `${barWidth}%`;
        if (volumeRatio >= 2) {
            volumeBar.className = 'volume-bar spike';
        } else if (volumeRatio >= 1.5) {
            volumeBar.className = 'volume-bar high';
        } else if (volumeRatio >= 0.8) {
            volumeBar.className = 'volume-bar normal';
        } else {
            volumeBar.className = 'volume-bar low';
        }

        // Volume Exit Warning (쉽알: 거래량 급증 = 익절 시그널)
        const volumeExitWarning = document.getElementById('volumeExitWarning');
        if (volume.exit_warning) {
            volumeExitWarning.style.display = 'flex';
            document.getElementById('volumeExitText').textContent = volume.exit_warning;
        } else {
            volumeExitWarning.style.display = 'none';
        }

        // Update Confluence Analysis (쉽알 Strategy)
        updateConfluenceCard(data.confluence);

        // Update FVG & Order Blocks
        updateFvgOrderBlocks(data.fvg, data.order_blocks);

        // Update Fakeout/Trap
        updateFakeoutTrap(data.fakeout);

        // Update key levels
        const levels = data.levels || {};
        document.getElementById('vwapLevel').textContent = levels.vwap ? `$${levels.vwap.toFixed(2)}` : '--';

        if (data.price && levels.vwap) {
            const priceVsVwap = document.getElementById('priceVsVwap');
            if (data.price > levels.vwap) {
                priceVsVwap.textContent = 'Above (Bullish)';
                priceVsVwap.className = 'indicator-value bullish';
            } else {
                priceVsVwap.textContent = 'Below (Bearish)';
                priceVsVwap.className = 'indicator-value bearish';
            }
        }

        document.getElementById('supportLevel').textContent = levels.nearest_support ? `$${levels.nearest_support.toFixed(2)}` : 'N/A';
        document.getElementById('resistanceLevel').textContent = levels.nearest_resistance ? `$${levels.nearest_resistance.toFixed(2)}` : 'N/A';

        // Update AI Analysis
        if (data.analysis) {
            document.getElementById('aiAnalysis').innerHTML = data.analysis;
        }

        // Update trade setup
        const setup = data.trade_setup || {};
        if (setup.entry_price) {
            document.getElementById('tradeSetupBox').style.display = 'block';
            document.getElementById('entryPrice').textContent = `$${setup.entry_price.toFixed(2)}`;
            document.getElementById('stopLoss').textContent = `$${setup.stop_loss.toFixed(2)}`;
            document.getElementById('takeProfit').textContent = `$${setup.take_profit.toFixed(2)}`;
            document.getElementById('riskReward').textContent = setup.risk_reward || 'R:R 1:2';

            document.getElementById('entryReasoning').textContent = setup.entry_reasoning || '';
            document.getElementById('stopReasoning').textContent = setup.stop_reasoning || '';
            document.getElementById('targetReasoning').textContent = setup.target_reasoning || '';

            // R:R Warning display
            const rrWarningEl = document.getElementById('rrWarning');
            if (setup.rr_warning) {
                rrWarningEl.style.display = 'flex';
                document.getElementById('rrWarningText').textContent = setup.rr_warning;
            } else {
                rrWarningEl.style.display = 'none';
            }
        } else {
            document.getElementById('tradeSetupBox').style.display = 'block';
            document.getElementById('entryPrice').textContent = '--';
            document.getElementById('stopLoss').textContent = '--';
            document.getElementById('takeProfit').textContent = '--';
            document.getElementById('riskReward').textContent = 'N/A';
            document.getElementById('entryReasoning').textContent = setup.entry_reasoning || 'Wait for clear candlestick pattern';
            document.getElementById('stopReasoning').textContent = '';
            document.getElementById('targetReasoning').textContent = '';
            document.getElementById('rrWarning').style.display = 'none';
        }
    }

    // Confluence Card Update (쉽알 Strategy)
    function updateConfluenceCard(confluence) {
        if (!confluence) {
            document.getElementById('confluenceStatusText').textContent = 'No data';
            return;
        }

        const card = document.getElementById('confluenceCard');
        const status = document.getElementById('confluenceStatus');
        const statusIcon = document.getElementById('confluenceStatusIcon');
        const statusText = document.getElementById('confluenceStatusText');
        const reasonsContainer = document.getElementById('confluenceReasons');

        const met = confluence.min_confluence_met;
        const direction = confluence.direction;
        const bullishCount = confluence.bullish_count || 0;
        const bearishCount = confluence.bearish_count || 0;

        // Update card style
        card.className = met ? 'confluence-card met' : 'confluence-card not-met';
        status.className = met ? 'confluence-status met' : 'confluence-status not-met';

        // Update status
        if (met) {
            statusIcon.textContent = '✅';
            statusText.textContent = `${Math.max(bullishCount, bearishCount)} confluences found - Entry signal!`;
        } else if (bullishCount === 1 || bearishCount === 1) {
            statusIcon.textContent = '⚠️';
            statusText.textContent = `Only ${Math.max(bullishCount, bearishCount)} confluence - Need 2+ (근거 1개)`;
        } else {
            statusIcon.textContent = '❌';
            statusText.textContent = 'No confluences - Wait for setup';
        }

        // Build reasons HTML
        let reasonsHtml = '';

        // Bullish reasons
        if (confluence.bullish_reasons && confluence.bullish_reasons.length > 0) {
            confluence.bullish_reasons.forEach(r => {
                reasonsHtml += `
                    <div class="reason-item bullish">
                        <span class="reason-text">🟢 ${r.reason}</span>
                        <span class="reason-score bullish">+${r.strength}</span>
                    </div>
                `;
            });
        }

        // Bearish reasons
        if (confluence.bearish_reasons && confluence.bearish_reasons.length > 0) {
            confluence.bearish_reasons.forEach(r => {
                reasonsHtml += `
                    <div class="reason-item bearish">
                        <span class="reason-text">🔴 ${r.reason}</span>
                        <span class="reason-score bearish">+${r.strength}</span>
                    </div>
                `;
            });
        }

        if (!reasonsHtml) {
            reasonsHtml = '<div style="text-align: center; color: var(--text-tertiary); font-size: var(--text-xs); padding: 12px;">No confluences detected in current setup</div>';
        }

        reasonsContainer.innerHTML = reasonsHtml;
    }

    // FVG & Order Blocks Update
    function updateFvgOrderBlocks(fvg, orderBlocks) {
        // FVG Section
        const atFvgEl = document.getElementById('atFvg');
        const fvgCountEl = document.getElementById('fvgCount');

        if (fvg) {
            if (fvg.at_fvg) {
                const fvgType = fvg.at_fvg.type;
                atFvgEl.innerHTML = `<span class="zone-badge ${fvgType}">${fvgType === 'bullish' ? '🟢 Support' : '🔴 Resistance'} Zone</span>`;
            } else {
                atFvgEl.textContent = 'Not in FVG zone';
            }
            fvgCountEl.textContent = `${fvg.bullish_count || 0} Bullish / ${fvg.bearish_count || 0} Bearish`;
        } else {
            atFvgEl.textContent = '--';
            fvgCountEl.textContent = '--';
        }

        // Order Block Section
        const atObEl = document.getElementById('atOb');
        const doubleObSection = document.getElementById('doubleObSection');

        if (orderBlocks) {
            if (orderBlocks.at_ob) {
                const obType = orderBlocks.at_ob.type;
                atObEl.innerHTML = `<span class="zone-badge ${obType}">${obType === 'bullish' ? '🟢 Support' : '🔴 Resistance'}</span>`;
            } else {
                atObEl.textContent = 'Not at Order Block';
            }

            // Double Engulfing (이중 장악형) - VERY STRONG!
            if (orderBlocks.double_ob) {
                const doubleType = orderBlocks.double_ob.type;
                doubleObSection.innerHTML = `
                    <div class="double-engulfing-badge">
                        ⭐ 이중 장악형 (Double Engulfing) ⭐<br>
                        <small style="font-weight: normal; color: var(--text-secondary);">
                            ${doubleType === 'bullish' ? 'VERY STRONG Support' : 'VERY STRONG Resistance'} - Strength: ${orderBlocks.double_ob.strength}
                        </small>
                    </div>
                `;
            } else {
                doubleObSection.innerHTML = '';
            }
        } else {
            atObEl.textContent = '--';
            doubleObSection.innerHTML = '';
        }
    }

    // Fakeout/Trap Update
    function updateFakeoutTrap(fakeoutData) {
        const fakeoutStatus = document.getElementById('fakeoutStatus');
        const trapStatus = document.getElementById('trapStatus');
        const trapDetail = document.getElementById('trapDetail');

        if (!fakeoutData) {
            fakeoutStatus.textContent = '--';
            trapStatus.textContent = '--';
            trapDetail.innerHTML = '';
            return;
        }

        // Fakeout
        if (fakeoutData.fakeout) {
            const fo = fakeoutData.fakeout;
            fakeoutStatus.innerHTML = `<span class="zone-badge ${fo.type}">${fo.type === 'bullish' ? '🟢 LONG' : '🔴 SHORT'}</span>`;
        } else {
            fakeoutStatus.textContent = 'None';
        }

        // Trap (Double Bottom/Top)
        if (fakeoutData.trap) {
            const trap = fakeoutData.trap;
            trapStatus.innerHTML = `<span class="zone-badge ${trap.type}">${trap.type === 'bullish' ? '🟢 DETECTED' : '🔴 DETECTED'}</span>`;

            trapDetail.innerHTML = `
                <div class="trap-badge ${trap.type === 'bearish' ? 'bearish' : ''}">
                    <div class="trap-title">🎯 ${trap.description}</div>
                    <div class="trap-detail">
                        Stop Loss: $${trap.stop_loss?.toFixed(2) || 'N/A'}<br>
                        Entry: ${trap.entry_logic}
                    </div>
                </div>
            `;
        } else {
            trapStatus.textContent = 'None';
            trapDetail.innerHTML = '';
        }
    }

    // ==========================================
    // NEW FEATURES
    // ==========================================

    // State variables
    let autoRefreshEnabled = false;
    let autoRefreshInterval = null;
    let refreshCountdown = 30;
    let watchlist = JSON.parse(localStorage.getItem('scalp_watchlist') || '[]');
    let recentSearches = JSON.parse(localStorage.getItem('scalp_recent') || '[]');
    let currentEntryPrice = null;
    let currentStopPrice = null;
    let currentTP1Price = null;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateMarketStatus();
        setInterval(updateMarketStatus, 60000); // Update every minute
        renderWatchlist();
        renderRecentSearches();
        document.getElementById('tickerInput').focus();
    });

    // ==========================================
    // MARKET STATUS
    // ==========================================
    function updateMarketStatus() {
        const now = new Date();
        const nyTime = new Date(now.toLocaleString("en-US", {timeZone: "America/New_York"}));
        const day = nyTime.getDay();
        const hour = nyTime.getHours();
        const minute = nyTime.getMinutes();
        const timeStr = nyTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });

        const dot = document.getElementById('marketStatusDot');
        const text = document.getElementById('marketStatusText');
        const timeEl = document.getElementById('marketTime');

        timeEl.textContent = `(NY: ${timeStr})`;

        // Weekend
        if (day === 0 || day === 6) {
            dot.className = 'status-dot closed';
            text.textContent = 'Market Closed (Weekend)';
            return;
        }

        // Pre-market: 4:00 AM - 9:30 AM
        if ((hour >= 4 && hour < 9) || (hour === 9 && minute < 30)) {
            dot.className = 'status-dot premarket';
            text.textContent = 'Pre-Market';
            return;
        }

        // Regular hours: 9:30 AM - 4:00 PM
        if ((hour === 9 && minute >= 30) || (hour >= 10 && hour < 16)) {
            dot.className = 'status-dot open';
            text.textContent = 'Market Open';
            return;
        }

        // After-hours: 4:00 PM - 8:00 PM
        if (hour >= 16 && hour < 20) {
            dot.className = 'status-dot premarket';
            text.textContent = 'After-Hours';
            return;
        }

        // Closed
        dot.className = 'status-dot closed';
        text.textContent = 'Market Closed';
    }

    // ==========================================
    // AUTO-REFRESH
    // ==========================================
    function toggleAutoRefresh() {
        autoRefreshEnabled = !autoRefreshEnabled;
        const toggle = document.getElementById('autoRefreshToggle');
        const countdown = document.getElementById('refreshCountdown');

        if (autoRefreshEnabled) {
            toggle.classList.add('active');
            refreshCountdown = 30;
            countdown.textContent = `${refreshCountdown}s`;
            autoRefreshInterval = setInterval(() => {
                refreshCountdown--;
                countdown.textContent = `${refreshCountdown}s`;
                if (refreshCountdown <= 0) {
                    refreshCountdown = 30;
                    if (currentTicker) {
                        fetchAnalysis(currentTicker);
                    }
                }
            }, 1000);
        } else {
            toggle.classList.remove('active');
            countdown.textContent = '--';
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
    }

    // ==========================================
    // WATCHLIST
    // ==========================================
    function toggleWatchlist() {
        if (!currentTicker) {
            showToast('Enter a ticker first', 'warning');
            return;
        }

        const btn = document.getElementById('watchlistBtn');
        const idx = watchlist.indexOf(currentTicker);

        if (idx >= 0) {
            watchlist.splice(idx, 1);
            btn.classList.remove('added');
            btn.textContent = '+ Watch';
            showToast(`${currentTicker} removed from watchlist`, 'info');
        } else {
            if (watchlist.length >= 10) {
                watchlist.shift(); // Remove oldest
            }
            watchlist.push(currentTicker);
            btn.classList.add('added');
            btn.textContent = '★ Watching';
            showToast(`${currentTicker} added to watchlist`, 'success');
        }

        localStorage.setItem('scalp_watchlist', JSON.stringify(watchlist));
        renderWatchlist();
    }

    function renderWatchlist() {
        const container = document.getElementById('watchlistSection');
        let html = '<span class="quick-access-label">Watchlist:</span>';

        if (watchlist.length === 0) {
            html += '<span style="color: var(--text-tertiary); font-size: var(--text-xs);">Empty</span>';
        } else {
            watchlist.forEach(ticker => {
                html += `<span class="quick-ticker watchlist" onclick="quickAnalyze('${ticker}')">${ticker}</span>`;
            });
        }

        container.innerHTML = html;

        // Update watchlist button state if current ticker is in watchlist
        if (currentTicker) {
            const btn = document.getElementById('watchlistBtn');
            if (watchlist.includes(currentTicker)) {
                btn.classList.add('added');
                btn.textContent = '★ Watching';
            } else {
                btn.classList.remove('added');
                btn.textContent = '+ Watch';
            }
        }
    }

    // ==========================================
    // RECENT SEARCHES
    // ==========================================
    function addToRecent(ticker) {
        // Remove if already exists
        recentSearches = recentSearches.filter(t => t !== ticker);
        // Add to front
        recentSearches.unshift(ticker);
        // Keep only last 5
        recentSearches = recentSearches.slice(0, 5);
        localStorage.setItem('scalp_recent', JSON.stringify(recentSearches));
        renderRecentSearches();
    }

    function renderRecentSearches() {
        const container = document.getElementById('recentSearches');
        let html = '<span class="quick-access-label">Recent:</span>';

        if (recentSearches.length === 0) {
            html += '<span style="color: var(--text-tertiary); font-size: var(--text-xs);">None</span>';
        } else {
            recentSearches.forEach(ticker => {
                html += `<span class="quick-ticker" onclick="quickAnalyze('${ticker}')">${ticker}</span>`;
            });
        }

        container.innerHTML = html;
    }

    function quickAnalyze(ticker) {
        document.getElementById('tickerInput').value = ticker;
        document.getElementById('searchForm').dispatchEvent(new Event('submit', { cancelable: true }));
    }

    // ==========================================
    // NEW SIGNAL UI FUNCTIONS
    // ==========================================

    function toggleAdvanced() {
        const section = document.getElementById('advancedSection');
        const icon = document.getElementById('advancedToggleIcon');
        if (section.classList.contains('show')) {
            section.classList.remove('show');
            icon.textContent = '▼';
        } else {
            section.classList.add('show');
            icon.textContent = '▲';
        }
    }

    function copyLevel(elementId) {
        const el = document.getElementById(elementId);
        const text = el.textContent.replace('$', '').trim();
        navigator.clipboard.writeText(text).then(() => {
            showToast(`Copied: $${text}`, 'success');
        }).catch(() => {
            showToast('Failed to copy', 'error');
        });
    }

    function updateSignalHero(signal, direction, confidence, reasons) {
        const hero = document.getElementById('signalHero');
        const badge = document.getElementById('signalBadge');
        const subtitle = document.getElementById('signalSubtitle');
        const gradeCircle = document.getElementById('gradeCircle');
        const gradeDesc = document.getElementById('gradeDescription');
        const levelsCard = document.getElementById('tradeLevelsCard');
        const warningBanner = document.getElementById('warningBanner');
        const keyReasonsEl = document.getElementById('keyReasons');

        // Reset classes
        hero.className = 'signal-hero';
        gradeCircle.className = 'grade-circle';

        // Determine grade based on confidence
        let grade = 'F';
        let gradeText = 'No setup';
        let subtitleText = '';
        if (confidence >= 80) {
            grade = 'A';
            gradeText = 'Excellent setup - High confidence';
        } else if (confidence >= 65) {
            grade = 'B';
            gradeText = 'Good setup - Solid confluence';
        } else if (confidence >= 50) {
            grade = 'C';
            gradeText = 'Fair setup - Proceed with caution';
        }

        if (signal === 'LONG') {
            hero.classList.add('long');
            badge.textContent = 'LONG';
            subtitleText = 'Bullish signal detected';
            levelsCard.style.display = 'block';
        } else if (signal === 'SHORT') {
            hero.classList.add('short');
            badge.textContent = 'SHORT';
            subtitleText = 'Bearish signal detected';
            levelsCard.style.display = 'block';
        } else {
            hero.classList.add('wait');
            badge.textContent = 'WAIT';
            subtitleText = (reasons && reasons.length)
                ? reasons[0]
                : 'Conditions not met - Wait for cleaner setup';
            levelsCard.style.display = 'none';
            grade = 'F';
            gradeText = 'Conditions not met - Wait for better setup';
        }
        subtitle.textContent = subtitleText;

        // Update grade
        gradeCircle.classList.add(`grade-${grade.toLowerCase()}`);
        gradeCircle.textContent = grade;
        gradeDesc.textContent = gradeText;

        // Update key reasons
        if (reasons && reasons.length > 0) {
            const chipClass = direction === 'bullish' ? 'bullish' : (direction === 'bearish' ? 'bearish' : '');
            const icon = direction === 'bullish' ? '🟢' : (direction === 'bearish' ? '🔴' : '⚪');
            keyReasonsEl.innerHTML = reasons.map(r =>
                `<span class="reason-chip ${chipClass}"><span class="reason-chip-icon">${icon}</span> ${r}</span>`
            ).join('');
        } else {
            keyReasonsEl.innerHTML = '<span class="reason-chip"><span class="reason-chip-icon">⏳</span> No confluences found</span>';
        }

        // Check for warnings (volume spike)
        const hasVolumeWarning = reasons && reasons.some(r => r.includes('Volume spike') || r.includes('⚠️'));
        if (hasVolumeWarning) {
            warningBanner.style.display = 'flex';
            document.getElementById('warningText').textContent = 'Volume Spike Detected - Consider taking profits if already in position';
        } else {
            warningBanner.style.display = 'none';
        }
    }

    function updateTradeLevels(entry, stop, tp1, tp2, currentPrice) {
        if (!entry || !stop) return;

        const decimals = entry < 1 ? 4 : 2;

        // Entry
        document.getElementById('lvlEntry').textContent = `$${entry.toFixed(decimals)}`;
        const entryPct = ((entry - currentPrice) / currentPrice * 100);
        document.getElementById('lvlEntryPct').textContent = `${entryPct >= 0 ? '+' : ''}${entryPct.toFixed(2)}%`;

        // Stop
        document.getElementById('lvlStop').textContent = `$${stop.toFixed(decimals)}`;
        const stopPct = ((stop - entry) / entry * 100);
        document.getElementById('lvlStopPct').textContent = `${stopPct.toFixed(2)}%`;

        // TP1
        if (tp1) {
            document.getElementById('lvlTp1').textContent = `$${tp1.toFixed(decimals)}`;
            const tp1Pct = ((tp1 - entry) / entry * 100);
            document.getElementById('lvlTp1Pct').textContent = `+${tp1Pct.toFixed(2)}%`;
        }

        // TP2
        if (tp2) {
            document.getElementById('lvlTp2').textContent = `$${tp2.toFixed(decimals)}`;
            const tp2Pct = ((tp2 - entry) / entry * 100);
            document.getElementById('lvlTp2Pct').textContent = `+${tp2Pct.toFixed(2)}%`;
        }

        // Store for other calculations
        currentEntryPrice = entry;
        currentStopPrice = stop;
        currentTP1Price = tp1;
    }

    // ==========================================
    // PRICE LEVELS VISUALIZATION
    // ==========================================
    function updatePriceLevelsVisual(currentPrice, entry, stop, tp1, tp2, tp3) {
        const panel = document.getElementById('priceLevelsPanel');

        // Show panel if we have data
        if (currentPrice && (entry || stop || tp1)) {
            panel.classList.add('show');
        } else {
            panel.classList.remove('show');
            return;
        }

        // Update current price tag
        document.getElementById('currentPriceTag').textContent = `$${currentPrice.toFixed(2)}`;

        // Determine price range for visualization
        const prices = [currentPrice, entry, stop, tp1, tp2, tp3].filter(p => p && p > 0);
        if (prices.length < 2) return;

        const minPrice = Math.min(...prices) * 0.998;
        const maxPrice = Math.max(...prices) * 1.002;
        const priceRange = maxPrice - minPrice;

        // Helper function to calculate position (inverted: high prices at top)
        const calcPosition = (price) => {
            if (!price || price <= 0) return -100; // Hide off-screen
            const position = ((maxPrice - price) / priceRange) * 100;
            return Math.max(2, Math.min(98, position)); // Clamp between 2-98%
        };

        // Update line positions and labels
        const updateLevel = (id, labelId, price, decimals = 2) => {
            const line = document.getElementById(id);
            const label = document.getElementById(labelId);
            if (price && price > 0) {
                line.style.top = `${calcPosition(price)}%`;
                line.style.display = 'flex';
                label.textContent = `$${price.toFixed(decimals)}`;
            } else {
                line.style.display = 'none';
            }
        };

        const decimals = currentPrice < 1 ? 4 : 2;
        updateLevel('levelCurrent', 'labelCurrent', currentPrice, decimals);
        updateLevel('levelEntry', 'labelEntry', entry, decimals);
        updateLevel('levelStop', 'labelStop', stop, decimals);
        updateLevel('levelTp1', 'labelTp1', tp1, decimals);
        updateLevel('levelTp2', 'labelTp2', tp2, decimals);
        updateLevel('levelTp3', 'labelTp3', tp3, decimals);

        // Update "NOW" label with actual price
        document.getElementById('labelCurrent').textContent = `$${currentPrice.toFixed(decimals)}`;

        // Update Risk/Reward visualization
        if (entry && stop && tp1) {
            const risk = Math.abs(entry - stop);
            const reward = Math.abs(tp1 - entry);
            const rrRatio = risk > 0 ? (reward / risk).toFixed(1) : 0;

            // Calculate percentages
            const riskPercent = ((risk / entry) * 100).toFixed(1);
            const rewardPercent = ((reward / entry) * 100).toFixed(1);

            // Update R:R bar widths
            const totalRR = 1 + parseFloat(rrRatio);
            const riskWidth = (1 / totalRR) * 100;
            document.getElementById('rrBarRisk').style.width = `${Math.max(15, riskWidth)}%`;

            // Update stats
            document.getElementById('rrRiskPercent').textContent = `-${riskPercent}%`;
            document.getElementById('rrRewardPercent').textContent = `+${rewardPercent}%`;
            document.getElementById('rrRatio').textContent = `1:${rrRatio}`;
        }
    }

    // ==========================================
    // COPY FUNCTIONS
    // ==========================================
    function copyValue(elementId) {
        const el = document.getElementById(elementId);
        const text = el.textContent.replace('$', '').trim();
        navigator.clipboard.writeText(text).then(() => {
            // Visual feedback
            const btn = el.nextElementSibling || el.parentElement.querySelector('.copy-btn');
            if (btn) {
                btn.classList.add('copied');
                btn.textContent = '✓';
                setTimeout(() => {
                    btn.classList.remove('copied');
                    btn.textContent = '📋';
                }, 1500);
            }
            showToast(`Copied: ${text}`, 'success');
        }).catch(() => {
            showToast('Failed to copy', 'error');
        });
    }

    function copyAllLevels() {
        const entry = document.getElementById('entryPrice').textContent;
        const stop = document.getElementById('stopLoss').textContent;
        const tp1 = document.getElementById('takeProfit').textContent;
        const tp2 = document.getElementById('takeProfit2').textContent;
        const tp3 = document.getElementById('takeProfit3').textContent;

        const text = `${currentTicker} Trade Setup\nEntry: ${entry}\nStop: ${stop}\nTP1: ${tp1}\nTP2: ${tp2}\nTP3: ${tp3}`;

        navigator.clipboard.writeText(text).then(() => {
            showToast('All levels copied!', 'success');
        }).catch(() => {
            showToast('Failed to copy', 'error');
        });
    }

    // ==========================================
    // TOAST NOTIFICATIONS
    // ==========================================
    function showToast(message, variant = 'info') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast show ${variant}`;
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    // ==========================================
    // KEYBOARD SHORTCUTS
    // ==========================================
    document.addEventListener('keydown', function(e) {
        // Don't trigger shortcuts when typing in input
        if (e.target.tagName === 'INPUT') {
            if (e.key === 'Escape') {
                e.target.blur();
            }
            return;
        }

        switch(e.key.toLowerCase()) {
            case 'r':
                if (currentTicker) {
                    fetchAnalysis(currentTicker);
                    showToast('Refreshing...', 'info');
                }
                break;
            case 'f':
                document.getElementById('tickerInput').focus();
                e.preventDefault();
                break;
            case 'w':
                toggleWatchlist();
                break;
            case '1':
                setTimeframe('1');
                break;
            case '2':
                setTimeframe('5');
                break;
            case '3':
                setTimeframe('15');
                break;
            case '4':
                setTimeframe('30');
                break;
            case '5':
                setTimeframe('60');
                break;
            case 'a':
                toggleAutoRefresh();
                break;
        }
    });

    // ==========================================
    // OVERRIDE ANALYZE STOCK TO ADD FEATURES
    // ==========================================
    const originalAnalyzeStock = analyzeStock;
    analyzeStock = function(event) {
        const result = originalAnalyzeStock(event);
        if (currentTicker) {
            addToRecent(currentTicker);
            renderWatchlist(); // Update watchlist button
        }
        return result;
    };

    // Update position calculator and price levels visual when prices change
    const originalUpdateDisplay = updateDisplay;
    updateDisplay = function(data) {
        originalUpdateDisplay(data);

        // Update last updated timestamp
        const now = new Date();
        document.getElementById('lastUpdated').textContent = `Last updated: ${now.toLocaleTimeString()}`;

        // Store prices for calculator and update visuals
        let entry = null, stop = null, tp1 = null, tp2 = null, tp3 = null;

        if (data.trade_setup && data.trade_setup.entry_price) {
            currentEntryPrice = entry = data.trade_setup.entry_price;
            currentStopPrice = stop = data.trade_setup.stop_loss;
            currentTP1Price = tp1 = data.trade_setup.take_profit;
            tp2 = data.trade_setup.take_profit_2;
            tp3 = data.trade_setup.take_profit_3;
        } else if (data.price) {
            // Use current price as entry estimate
            currentEntryPrice = entry = data.price;
            currentStopPrice = stop = data.levels?.nearest_support || data.price * 0.98;
            currentTP1Price = tp1 = data.levels?.nearest_resistance || data.price * 1.04;
            tp2 = tp1 ? tp1 * 1.015 : null;
            tp3 = tp1 ? tp1 * 1.03 : null;
        }

        // Update price levels visualization
        if (data.price) {
            updatePriceLevelsVisual(data.price, entry, stop, tp1, tp2, tp3);
        }
    };

    // Also update from signal overlay
    const originalFetchSignalAndOverlay = fetchSignalAndOverlay;
    fetchSignalAndOverlay = async function(ticker) {
        await originalFetchSignalAndOverlay(ticker);

        // Get signal data from the DOM elements that were just updated
        const entryEl = document.getElementById('entryPrice');
        const stopEl = document.getElementById('stopLoss');
        const tp1El = document.getElementById('takeProfit');
        const tp2El = document.getElementById('takeProfit2');
        const tp3El = document.getElementById('takeProfit3');
        const priceEl = document.getElementById('displayPrice');

        const parsePrice = (el) => {
            if (!el) return null;
            const text = el.textContent.replace(/[$,\s]/g, '');
            const val = parseFloat(text);
            return isNaN(val) ? null : val;
        };

        const currentPrice = parsePrice(priceEl);
        const entry = parsePrice(entryEl);
        const stop = parsePrice(stopEl);
        const tp1 = parsePrice(tp1El);
        const tp2 = parsePrice(tp2El);
        const tp3 = parsePrice(tp3El);

        if (currentPrice) {
            updatePriceLevelsVisual(currentPrice, entry, stop, tp1, tp2, tp3);
        }
    };

    // Auto-focus on input
    document.getElementById('tickerInput').focus();
</script>
{% endblock %}
