{% extends "base_layout.html" %}

{% block title %}Scalp Trading - Candlestick + Volume Analysis - Qunex Trade{% endblock %}

{% block extra_styles %}
<style>
    /* Search Section */
    .search-section {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        padding: 24px;
        margin-bottom: 24px;
    }

    .search-form {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .search-input {
        flex: 1;
        max-width: 300px;
        padding: 12px 16px;
        background: var(--bg-hover);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        color: var(--text-primary);
        font-size: 1rem;
        font-family: 'JetBrains Mono', monospace;
        text-transform: uppercase;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--accent-cyan);
        box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.1);
    }

    .search-btn {
        padding: 12px 24px;
        background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
        border: none;
        border-radius: var(--radius-lg);
        color: #000;
        font-weight: var(--font-semibold);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .search-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0, 217, 255, 0.3);
    }

    .timeframe-tabs {
        display: flex;
        gap: 8px;
        margin-left: auto;
    }

    .timeframe-tab {
        padding: 8px 16px;
        background: var(--bg-hover);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        font-size: var(--text-sm);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .timeframe-tab:hover {
        background: var(--bg-active);
    }

    .timeframe-tab.active {
        background: var(--accent-cyan);
        color: #000;
        border-color: var(--accent-cyan);
    }

    /* Main Grid */
    .scalp-grid {
        display: grid;
        grid-template-columns: 1fr 420px;
        gap: 24px;
    }

    @media (max-width: 1200px) {
        .scalp-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Chart Section */
    .chart-section {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        overflow: hidden;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid var(--border-subtle);
    }

    .ticker-display {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .ticker-symbol {
        font-size: 1.5rem;
        font-weight: var(--font-bold);
        font-family: 'JetBrains Mono', monospace;
        background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .ticker-price {
        font-size: 1.25rem;
        font-weight: var(--font-semibold);
        font-family: 'JetBrains Mono', monospace;
    }

    .ticker-change {
        font-size: var(--text-sm);
        padding: 4px 10px;
        border-radius: var(--radius-sm);
    }

    .ticker-change.positive {
        color: var(--success);
        background: rgba(34, 197, 94, 0.1);
    }

    .ticker-change.negative {
        color: var(--danger);
        background: rgba(239, 68, 68, 0.1);
    }

    /* Analysis Panel */
    .analysis-panel {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .signal-card {
        background: var(--bg-card);
        border: 2px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        padding: 24px;
        text-align: center;
        transition: all var(--transition-fast);
    }

    .signal-card.bullish {
        border-color: var(--success);
        background: rgba(34, 197, 94, 0.05);
    }

    .signal-card.bearish {
        border-color: var(--danger);
        background: rgba(239, 68, 68, 0.05);
    }

    .signal-card.neutral {
        border-color: #eab308;
        background: rgba(234, 179, 8, 0.05);
    }

    .signal-icon {
        font-size: 3rem;
        margin-bottom: 12px;
    }

    .signal-text {
        font-size: 1.5rem;
        font-weight: var(--font-bold);
        margin-bottom: 8px;
    }

    .signal-text.bullish { color: var(--success); }
    .signal-text.bearish { color: var(--danger); }
    .signal-text.neutral { color: #eab308; }

    .signal-confidence {
        font-size: var(--text-sm);
        color: var(--text-secondary);
    }

    /* Reasoning List */
    .reasoning-list {
        margin-top: 12px;
        text-align: left;
        font-size: var(--text-xs);
        color: var(--text-tertiary);
    }

    .reasoning-item {
        padding: 4px 0;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .reasoning-item::before {
        content: "‚Ä¢";
        color: var(--accent-cyan);
    }

    /* Cards */
    .indicators-card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        padding: 20px;
    }

    .card-title {
        font-size: var(--text-lg);
        font-weight: var(--font-semibold);
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border-subtle);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .card-badge {
        font-size: var(--text-xs);
        padding: 2px 8px;
        border-radius: var(--radius-sm);
        background: rgba(0, 217, 255, 0.2);
        color: var(--accent-cyan);
        font-weight: var(--font-medium);
    }

    .indicator-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid var(--border-subtle);
    }

    .indicator-row:last-child {
        border-bottom: none;
    }

    .indicator-name {
        color: var(--text-secondary);
        font-size: var(--text-sm);
    }

    .indicator-value {
        font-family: 'JetBrains Mono', monospace;
        font-weight: var(--font-medium);
    }

    .indicator-value.bullish { color: var(--success); }
    .indicator-value.bearish { color: var(--danger); }

    /* Pattern Badge */
    .pattern-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: var(--radius-sm);
        font-size: var(--text-xs);
        font-weight: var(--font-medium);
        margin: 2px;
    }

    .pattern-badge.bullish {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success);
        border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .pattern-badge.bearish {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .pattern-badge.neutral {
        background: rgba(234, 179, 8, 0.1);
        color: #eab308;
        border: 1px solid rgba(234, 179, 8, 0.3);
    }

    /* Volume Bar */
    .volume-bar-container {
        margin-top: 8px;
        background: var(--bg-hover);
        border-radius: var(--radius-sm);
        height: 8px;
        overflow: hidden;
    }

    .volume-bar {
        height: 100%;
        border-radius: var(--radius-sm);
        transition: width 0.3s ease;
    }

    .volume-bar.low { background: var(--text-tertiary); }
    .volume-bar.normal { background: var(--accent-cyan); }
    .volume-bar.high { background: var(--success); }
    .volume-bar.spike { background: linear-gradient(135deg, var(--success), #22c55e); }

    /* AI Analysis Card */
    .ai-analysis-card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        padding: 20px;
        flex: 1;
    }

    .ai-analysis-content {
        font-size: var(--text-sm);
        line-height: 1.7;
        color: var(--text-secondary);
    }

    .ai-analysis-content strong {
        color: var(--text-primary);
    }

    /* Trade Setup Box */
    .trade-setup-box {
        background: var(--bg-hover);
        border-radius: var(--radius-lg);
        padding: 16px;
        margin-top: 16px;
    }

    .trade-setup-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border-subtle);
    }

    .trade-setup-title {
        font-weight: var(--font-semibold);
        font-size: var(--text-sm);
    }

    .trade-setup-rr {
        font-family: 'JetBrains Mono', monospace;
        padding: 4px 10px;
        background: rgba(234, 179, 8, 0.1);
        color: #eab308;
        border-radius: var(--radius-sm);
        font-size: var(--text-xs);
        font-weight: var(--font-bold);
    }

    .entry-exit-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
    }

    .entry-exit-label {
        color: var(--text-tertiary);
        font-size: var(--text-sm);
    }

    .entry-exit-value {
        font-family: 'JetBrains Mono', monospace;
        font-weight: var(--font-semibold);
    }

    .entry-exit-value.green { color: var(--success); }
    .entry-exit-value.red { color: var(--danger); }
    .entry-exit-value.yellow { color: #eab308; }

    .reasoning-text {
        font-size: var(--text-xs);
        color: var(--text-tertiary);
        margin-top: 4px;
        font-style: italic;
    }

    /* Loading State */
    .loading-overlay {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 48px;
        color: var(--text-tertiary);
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--border-subtle);
        border-top-color: var(--accent-cyan);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 16px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 24px;
        color: var(--text-tertiary);
    }

    .empty-icon {
        font-size: 4rem;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    .empty-title {
        font-size: 1.25rem;
        font-weight: var(--font-semibold);
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .empty-desc {
        font-size: var(--text-sm);
        max-width: 300px;
        margin: 0 auto;
    }

    /* Risk Warning */
    .risk-warning {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: var(--radius-lg);
        padding: 12px 16px;
        font-size: var(--text-xs);
        color: var(--text-secondary);
        margin-top: 16px;
    }

    .risk-warning strong {
        color: var(--danger);
    }

    /* Strategy Info */
    .strategy-info {
        background: rgba(0, 217, 255, 0.05);
        border: 1px solid rgba(0, 217, 255, 0.2);
        border-radius: var(--radius-lg);
        padding: 12px 16px;
        font-size: var(--text-xs);
        color: var(--text-secondary);
        margin-bottom: 24px;
    }

    .strategy-info strong {
        color: var(--accent-cyan);
    }

    .strategy-weights {
        display: flex;
        gap: 16px;
        margin-top: 8px;
    }

    .weight-item {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .weight-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .weight-dot.candle { background: var(--accent-cyan); }
    .weight-dot.volume { background: var(--accent-purple); }
    .weight-dot.vwap { background: #eab308; }
</style>
{% endblock %}

{% block content %}
<div class="content-header">
    <div>
        <h1 class="content-title">Scalp Trading Analysis</h1>
        <p class="content-subtitle">Candlestick + Volume based signals with clear entry/stop/target reasoning</p>
    </div>
</div>

<!-- Strategy Info -->
<div class="strategy-info">
    <strong>Strategy:</strong> Pure price action scalping focused on candlestick patterns with volume confirmation.
    <div class="strategy-weights">
        <div class="weight-item"><span class="weight-dot candle"></span> Candlestick Patterns: 75%</div>
        <div class="weight-item"><span class="weight-dot volume"></span> Volume Confirmation: 15%</div>
        <div class="weight-item"><span class="weight-dot vwap"></span> VWAP Level: 10%</div>
    </div>
    <div style="margin-top: 8px; font-size: var(--text-xs); color: var(--text-tertiary);">
        Supports: <strong style="color: var(--success);">US Stocks</strong> (AAPL, TSLA, etc.) &amp;
        <strong style="color: #f7931a;">Crypto</strong> (BTCUSDT, ETHUSDT, etc.)
    </div>
</div>

<!-- Search Section -->
<div class="search-section">
    <form class="search-form" id="searchForm" onsubmit="return analyzeStock(event)">
        <input type="text" class="search-input" id="tickerInput" placeholder="AAPL or BTCUSDT" maxlength="12" required>
        <button type="submit" class="search-btn" id="analyzeBtn">Analyze</button>
        <div class="timeframe-tabs">
            <button type="button" class="timeframe-tab" data-interval="1" onclick="setTimeframe('1')">1m</button>
            <button type="button" class="timeframe-tab active" data-interval="5" onclick="setTimeframe('5')">5m</button>
            <button type="button" class="timeframe-tab" data-interval="15" onclick="setTimeframe('15')">15m</button>
        </div>
    </form>
</div>

<!-- Main Content -->
<div class="scalp-grid">
    <!-- Chart Section -->
    <div class="chart-section">
        <div class="chart-header" id="chartHeader" style="display: none;">
            <div class="ticker-display">
                <span class="ticker-symbol" id="displayTicker">--</span>
                <span class="ticker-price" id="displayPrice">$--</span>
                <span class="ticker-change" id="displayChange">--</span>
            </div>
        </div>
        <div id="chartContainer">
            <div class="empty-state">
                <div class="empty-icon">üìä</div>
                <div class="empty-title">Enter a Ticker Symbol</div>
                <div class="empty-desc">Search for US stocks (AAPL, TSLA) or crypto pairs (BTCUSDT, ETHUSDT) for candlestick pattern analysis</div>
            </div>
        </div>
    </div>

    <!-- Analysis Panel -->
    <div class="analysis-panel" id="analysisPanel" style="display: none;">
        <!-- Signal Card -->
        <div class="signal-card" id="signalCard">
            <div class="signal-icon" id="signalIcon">‚è≥</div>
            <div class="signal-text" id="signalText">Analyzing...</div>
            <div class="signal-confidence" id="signalConfidence">--</div>
            <div class="reasoning-list" id="reasoningList"></div>
        </div>

        <!-- Candlestick Patterns -->
        <div class="indicators-card">
            <div class="card-title">
                Candlestick Patterns
                <span class="card-badge">75%</span>
            </div>
            <div id="candlePatterns">
                <div class="indicator-row">
                    <span class="indicator-name">Primary Pattern</span>
                    <span class="indicator-value" id="primaryPattern">--</span>
                </div>
            </div>
            <div class="indicator-row">
                <span class="indicator-name">Pattern Strength</span>
                <span class="indicator-value" id="patternStrength">--</span>
            </div>
            <div class="indicator-row">
                <span class="indicator-name">Pattern Bias</span>
                <span class="indicator-value" id="patternBias">--</span>
            </div>
            <div id="allPatterns" style="margin-top: 12px;"></div>
        </div>

        <!-- Volume Analysis -->
        <div class="indicators-card">
            <div class="card-title">
                Volume Analysis
                <span class="card-badge">15%</span>
            </div>
            <div class="indicator-row">
                <span class="indicator-name">Volume Ratio</span>
                <span class="indicator-value" id="volumeRatio">--</span>
            </div>
            <div class="indicator-row">
                <span class="indicator-name">Spike Detected</span>
                <span class="indicator-value" id="volumeSpike">--</span>
            </div>
            <div class="indicator-row">
                <span class="indicator-name">Volume Trend</span>
                <span class="indicator-value" id="volumeTrend">--</span>
            </div>
            <div class="volume-bar-container">
                <div class="volume-bar" id="volumeBar" style="width: 50%;"></div>
            </div>
        </div>

        <!-- Key Levels -->
        <div class="indicators-card">
            <div class="card-title">
                Key Levels
                <span class="card-badge">10%</span>
            </div>
            <div class="indicator-row">
                <span class="indicator-name">VWAP</span>
                <span class="indicator-value" id="vwapLevel">--</span>
            </div>
            <div class="indicator-row">
                <span class="indicator-name">Price vs VWAP</span>
                <span class="indicator-value" id="priceVsVwap">--</span>
            </div>
            <div class="indicator-row">
                <span class="indicator-name">Nearest Support</span>
                <span class="indicator-value bullish" id="supportLevel">--</span>
            </div>
            <div class="indicator-row">
                <span class="indicator-name">Nearest Resistance</span>
                <span class="indicator-value bearish" id="resistanceLevel">--</span>
            </div>
        </div>

        <!-- AI Analysis -->
        <div class="ai-analysis-card">
            <div class="card-title">Analysis</div>
            <div class="ai-analysis-content" id="aiAnalysis">
                <div class="loading-overlay">
                    <div class="spinner"></div>
                    <span>Waiting for analysis...</span>
                </div>
            </div>

            <!-- Trade Setup -->
            <div class="trade-setup-box" id="tradeSetupBox" style="display: none;">
                <div class="trade-setup-header">
                    <span class="trade-setup-title">Trade Setup</span>
                    <span class="trade-setup-rr" id="riskReward">R:R --</span>
                </div>
                <div class="entry-exit-row">
                    <span class="entry-exit-label">Entry Price</span>
                    <span class="entry-exit-value green" id="entryPrice">--</span>
                </div>
                <div class="reasoning-text" id="entryReasoning"></div>
                <div class="entry-exit-row">
                    <span class="entry-exit-label">Stop Loss</span>
                    <span class="entry-exit-value red" id="stopLoss">--</span>
                </div>
                <div class="reasoning-text" id="stopReasoning"></div>
                <div class="entry-exit-row">
                    <span class="entry-exit-label">Take Profit</span>
                    <span class="entry-exit-value green" id="takeProfit">--</span>
                </div>
                <div class="reasoning-text" id="targetReasoning"></div>
            </div>

            <div class="risk-warning">
                <strong>Risk Warning:</strong> Scalp trading is high-risk. Never risk more than 1-2% of your account per trade. Minimum R:R of 1:2 recommended. Past performance does not guarantee future results.
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script>
    let currentTicker = '';
    let currentInterval = '5';
    let currentAssetType = 'stock';
    let tvWidget = null;

    // Detect if ticker is crypto
    function isCryptoTicker(ticker) {
        const cryptoPatterns = [
            /^[A-Z]+USDT$/,  // BTCUSDT, ETHUSDT
            /^[A-Z]+BUSD$/,  // BTCBUSD
            /^[A-Z]+BTC$/,   // ETHBTC
            /^[A-Z]+ETH$/,   // ADAETH
            /^[A-Z]+BNB$/,   // ADABNB
        ];
        return cryptoPatterns.some(pattern => pattern.test(ticker.toUpperCase()));
    }

    // Get TradingView symbol (with exchange prefix)
    function getTVSymbol(ticker) {
        ticker = ticker.toUpperCase();
        if (isCryptoTicker(ticker)) {
            // Use BINANCE for TradingView (works globally)
            return `BINANCE:${ticker}`;
        }
        return ticker;  // Stocks use default exchange
    }

    function setTimeframe(interval) {
        currentInterval = interval;
        document.querySelectorAll('.timeframe-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.interval === interval);
        });
        if (currentTicker) {
            initChart(currentTicker);
            fetchAnalysis(currentTicker);
        }
    }

    function analyzeStock(event) {
        event.preventDefault();
        const ticker = document.getElementById('tickerInput').value.toUpperCase().trim();
        if (!ticker) return false;

        currentTicker = ticker;
        currentAssetType = isCryptoTicker(ticker) ? 'crypto' : 'stock';
        document.getElementById('chartHeader').style.display = 'flex';
        document.getElementById('analysisPanel').style.display = 'flex';

        // Show ticker with asset type badge
        const tickerDisplay = document.getElementById('displayTicker');
        const assetBadge = currentAssetType === 'crypto'
            ? '<span style="font-size: 0.6em; padding: 2px 6px; background: #f7931a; color: #000; border-radius: 4px; margin-left: 8px;">CRYPTO</span>'
            : '<span style="font-size: 0.6em; padding: 2px 6px; background: var(--success); color: #000; border-radius: 4px; margin-left: 8px;">STOCK</span>';
        tickerDisplay.innerHTML = ticker + assetBadge;

        initChart(ticker);
        fetchAnalysis(ticker);

        return false;
    }

    function initChart(ticker) {
        const container = document.getElementById('chartContainer');
        container.innerHTML = '<div id="tradingview_scalp" style="height:500px;"></div>';

        const tvSymbol = getTVSymbol(ticker);
        const timezone = isCryptoTicker(ticker) ? "Etc/UTC" : "America/New_York";

        tvWidget = new TradingView.widget({
            "autosize": true,
            "symbol": tvSymbol,
            "interval": currentInterval,
            "timezone": timezone,
            "theme": "dark",
            "style": "1",
            "locale": "en",
            "toolbar_bg": "#000000",
            "enable_publishing": false,
            "hide_side_toolbar": false,
            "allow_symbol_change": true,
            "container_id": "tradingview_scalp",
            "studies": [
                {"id": "VWAP@tv-basicstudies"},
                {"id": "Volume@tv-basicstudies"}
            ],
            "backgroundColor": "#000000",
            "gridColor": "#1a1a1a"
        });
    }

    async function fetchAnalysis(ticker) {
        // Show loading state
        document.getElementById('signalIcon').textContent = '‚è≥';
        document.getElementById('signalText').textContent = 'Analyzing...';
        document.getElementById('signalText').className = 'signal-text';
        document.getElementById('signalCard').className = 'signal-card';
        document.getElementById('signalConfidence').textContent = 'Detecting candlestick patterns...';
        document.getElementById('tradeSetupBox').style.display = 'none';
        document.getElementById('reasoningList').innerHTML = '';

        document.getElementById('aiAnalysis').innerHTML = `
            <div class="loading-overlay">
                <div class="spinner"></div>
                <span>Analyzing candlestick patterns...</span>
            </div>
        `;

        try {
            const response = await fetch(`/api/scalp/analyze/${ticker}?interval=${currentInterval}`);
            const data = await response.json();

            if (data.error) {
                throw new Error(data.error);
            }

            updateDisplay(data);
        } catch (error) {
            console.error('Analysis error:', error);
            document.getElementById('signalIcon').textContent = '‚ùå';
            document.getElementById('signalText').textContent = 'Error';
            document.getElementById('signalConfidence').textContent = error.message || 'Failed to analyze';
            const assetHint = isCryptoTicker(ticker)
                ? 'Crypto pairs use Binance data (e.g., BTCUSDT, ETHUSDT)'
                : 'Stocks use Polygon data. Ensure market is open.';
            document.getElementById('aiAnalysis').innerHTML = `
                <div style="color: var(--danger); text-align: center; padding: 20px;">
                    Failed to analyze ${ticker}. Please try again.<br>
                    <small style="color: var(--text-tertiary);">${assetHint}</small>
                </div>
            `;
        }
    }

    function updateDisplay(data) {
        // Update price info
        const isCrypto = data.asset_type === 'crypto';
        if (data.price) {
            // Crypto shows more decimals for precision
            const priceDecimals = isCrypto ? (data.price < 1 ? 6 : 2) : 2;
            const priceSymbol = isCrypto ? '' : '$';
            const priceSuffix = isCrypto ? ' USDT' : '';
            document.getElementById('displayPrice').textContent = `${priceSymbol}${data.price.toFixed(priceDecimals)}${priceSuffix}`;
            const changeClass = data.change_percent >= 0 ? 'positive' : 'negative';
            const changeSign = data.change_percent >= 0 ? '+' : '';
            document.getElementById('displayChange').className = `ticker-change ${changeClass}`;
            document.getElementById('displayChange').textContent = `${changeSign}${data.change_percent.toFixed(2)}%`;
        }

        // Update signal card
        const signal = data.signal || 'WAIT';
        const signalCard = document.getElementById('signalCard');
        const signalIcon = document.getElementById('signalIcon');
        const signalText = document.getElementById('signalText');

        if (signal === 'LONG') {
            signalCard.className = 'signal-card bullish';
            signalIcon.textContent = 'üöÄ';
            signalText.textContent = 'LONG SIGNAL';
            signalText.className = 'signal-text bullish';
        } else if (signal === 'SHORT') {
            signalCard.className = 'signal-card bearish';
            signalIcon.textContent = 'üîª';
            signalText.textContent = 'SHORT SIGNAL';
            signalText.className = 'signal-text bearish';
        } else {
            signalCard.className = 'signal-card neutral';
            signalIcon.textContent = '‚è∏Ô∏è';
            signalText.textContent = 'WAIT';
            signalText.className = 'signal-text neutral';
        }

        document.getElementById('signalConfidence').textContent = `Confidence: ${data.confidence || '--'}%`;

        // Update reasoning list
        const reasoningList = document.getElementById('reasoningList');
        if (data.signal_reasoning && data.signal_reasoning.length > 0) {
            reasoningList.innerHTML = data.signal_reasoning.map(r =>
                `<div class="reasoning-item">${r}</div>`
            ).join('');
        } else {
            reasoningList.innerHTML = '';
        }

        // Update candlestick patterns
        const candle = data.candlestick || {};
        const primary = candle.primary_pattern;

        if (primary) {
            const typeClass = primary.type === 'bullish' ? 'bullish' : (primary.type === 'bearish' ? 'bearish' : '');
            document.getElementById('primaryPattern').innerHTML =
                `<span class="${typeClass}">${primary.name}</span>`;
            document.getElementById('patternStrength').textContent = `${primary.strength}/100`;
        } else {
            document.getElementById('primaryPattern').textContent = 'None detected';
            document.getElementById('patternStrength').textContent = '--';
        }

        const patternBias = document.getElementById('patternBias');
        const bias = candle.bias || 'neutral';
        patternBias.textContent = bias.charAt(0).toUpperCase() + bias.slice(1);
        patternBias.className = `indicator-value ${bias === 'bullish' ? 'bullish' : (bias === 'bearish' ? 'bearish' : '')}`;

        // Show all detected patterns
        const allPatternsEl = document.getElementById('allPatterns');
        const patterns = candle.patterns || [];
        if (patterns.length > 0) {
            allPatternsEl.innerHTML = patterns.map(p =>
                `<span class="pattern-badge ${p.type}">${p.name}</span>`
            ).join('');
        } else {
            allPatternsEl.innerHTML = '<span style="color: var(--text-tertiary); font-size: var(--text-xs);">No patterns detected in current candles</span>';
        }

        // Update volume analysis
        const volume = data.volume || {};
        const volumeRatio = volume.ratio || 1;
        document.getElementById('volumeRatio').textContent = `${volumeRatio.toFixed(1)}x avg`;

        const volumeSpike = document.getElementById('volumeSpike');
        if (volume.spike_detected) {
            volumeSpike.textContent = 'Yes ‚úì';
            volumeSpike.className = 'indicator-value bullish';
        } else {
            volumeSpike.textContent = 'No';
            volumeSpike.className = 'indicator-value';
        }

        const volumeTrend = document.getElementById('volumeTrend');
        volumeTrend.textContent = (volume.trend || 'neutral').charAt(0).toUpperCase() + (volume.trend || 'neutral').slice(1);
        volumeTrend.className = `indicator-value ${volume.trend === 'increasing' ? 'bullish' : ''}`;

        // Update volume bar
        const volumeBar = document.getElementById('volumeBar');
        const barWidth = Math.min(100, volumeRatio * 50);
        volumeBar.style.width = `${barWidth}%`;
        if (volumeRatio >= 2) {
            volumeBar.className = 'volume-bar spike';
        } else if (volumeRatio >= 1.5) {
            volumeBar.className = 'volume-bar high';
        } else if (volumeRatio >= 0.8) {
            volumeBar.className = 'volume-bar normal';
        } else {
            volumeBar.className = 'volume-bar low';
        }

        // Update key levels
        const levels = data.levels || {};
        document.getElementById('vwapLevel').textContent = levels.vwap ? `$${levels.vwap.toFixed(2)}` : '--';

        if (data.price && levels.vwap) {
            const priceVsVwap = document.getElementById('priceVsVwap');
            if (data.price > levels.vwap) {
                priceVsVwap.textContent = 'Above (Bullish)';
                priceVsVwap.className = 'indicator-value bullish';
            } else {
                priceVsVwap.textContent = 'Below (Bearish)';
                priceVsVwap.className = 'indicator-value bearish';
            }
        }

        document.getElementById('supportLevel').textContent = levels.nearest_support ? `$${levels.nearest_support.toFixed(2)}` : 'N/A';
        document.getElementById('resistanceLevel').textContent = levels.nearest_resistance ? `$${levels.nearest_resistance.toFixed(2)}` : 'N/A';

        // Update AI Analysis
        if (data.analysis) {
            document.getElementById('aiAnalysis').innerHTML = data.analysis;
        }

        // Update trade setup
        const setup = data.trade_setup || {};
        if (setup.entry_price) {
            document.getElementById('tradeSetupBox').style.display = 'block';
            document.getElementById('entryPrice').textContent = `$${setup.entry_price.toFixed(2)}`;
            document.getElementById('stopLoss').textContent = `$${setup.stop_loss.toFixed(2)}`;
            document.getElementById('takeProfit').textContent = `$${setup.take_profit.toFixed(2)}`;
            document.getElementById('riskReward').textContent = setup.risk_reward || 'R:R 1:2';

            document.getElementById('entryReasoning').textContent = setup.entry_reasoning || '';
            document.getElementById('stopReasoning').textContent = setup.stop_reasoning || '';
            document.getElementById('targetReasoning').textContent = setup.target_reasoning || '';
        } else {
            document.getElementById('tradeSetupBox').style.display = 'block';
            document.getElementById('entryPrice').textContent = '--';
            document.getElementById('stopLoss').textContent = '--';
            document.getElementById('takeProfit').textContent = '--';
            document.getElementById('riskReward').textContent = 'N/A';
            document.getElementById('entryReasoning').textContent = setup.entry_reasoning || 'Wait for clear candlestick pattern';
            document.getElementById('stopReasoning').textContent = '';
            document.getElementById('targetReasoning').textContent = '';
        }
    }

    // Auto-focus on input
    document.getElementById('tickerInput').focus();
</script>
{% endblock %}
