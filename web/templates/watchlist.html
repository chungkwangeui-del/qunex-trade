{% extends "base_layout.html" %}

{% block title %}Watchlist - Qunex Trade{% endblock %}

{% block extra_styles %}
<style>
    /* Stats Cards */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 32px;
    }

    @media (max-width: 1024px) {
        .stats-row {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 640px) {
        .stats-row {
            grid-template-columns: 1fr;
        }
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        padding: 24px;
        transition: all 0.2s ease;
    }

    .stat-card:hover {
        border-color: rgba(255, 255, 255, 0.15);
        transform: translateY(-2px);
    }

    .stat-card.gainers { border-left: 3px solid #22c55e; }
    .stat-card.losers { border-left: 3px solid #ef4444; }
    .stat-card.neutral { border-left: 3px solid #6b7280; }
    .stat-card.total { border-left: 3px solid #00d9ff; }

    .stat-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: rgba(255, 255, 255, 0.5);
        font-weight: 600;
        margin-bottom: 8px;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        font-family: 'JetBrains Mono', monospace;
    }

    .stat-value.green { color: #22c55e; }
    .stat-value.red { color: #ef4444; }
    .stat-value.gray { color: #6b7280; }
    .stat-value.cyan { color: #00d9ff; }

    /* Add Button */
    .add-btn {
        background: linear-gradient(135deg, #00d9ff, #a855f7);
        border: none;
        padding: 12px 24px;
        border-radius: 50px;
        color: #000;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .add-btn:hover {
        transform: scale(1.02);
        box-shadow: 0 4px 20px rgba(0, 217, 255, 0.3);
    }

    /* Watchlist Grid */
    .watchlist-section {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        padding: 24px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #fff;
    }

    .watchlist-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
        gap: 20px;
    }

    .stock-card {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 12px;
        padding: 20px;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .stock-card:hover {
        border-color: rgba(0, 217, 255, 0.3);
        transform: translateY(-4px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    /* Price flash animations */
    .price-value.flash-green {
        animation: flashGreen 0.5s ease;
    }

    .price-value.flash-red {
        animation: flashRed 0.5s ease;
    }

    @keyframes flashGreen {
        0%, 100% { background: transparent; }
        50% { background: rgba(34, 197, 94, 0.3); border-radius: 4px; }
    }

    @keyframes flashRed {
        0%, 100% { background: transparent; }
        50% { background: rgba(239, 68, 68, 0.3); border-radius: 4px; }
    }

    /* Live indicator */
    .live-indicator {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.3);
        border-radius: 20px;
        font-size: 0.75rem;
        color: #22c55e;
        font-weight: 600;
    }

    .live-dot {
        width: 8px;
        height: 8px;
        background: #22c55e;
        border-radius: 50%;
        animation: livePulse 2s infinite;
    }

    .live-indicator.pulse .live-dot {
        animation: livePulseQuick 0.5s ease;
    }

    @keyframes livePulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(0.8); }
    }

    @keyframes livePulseQuick {
        0% { transform: scale(1); }
        50% { transform: scale(1.5); box-shadow: 0 0 10px #22c55e; }
        100% { transform: scale(1); }
    }

    /* Alert styles */
    .alert-banner {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 14px;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 12px;
        animation: alertPulse 2s infinite;
    }

    .alert-banner.above {
        background: rgba(34, 197, 94, 0.15);
        border: 1px solid rgba(34, 197, 94, 0.4);
        color: #22c55e;
    }

    .alert-banner.below {
        background: rgba(239, 68, 68, 0.15);
        border: 1px solid rgba(239, 68, 68, 0.4);
        color: #ef4444;
    }

    @keyframes alertPulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    .alert-status {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
    }

    .alert-tag {
        display: inline-flex;
        align-items: center;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
        font-family: 'JetBrains Mono', monospace;
    }

    .alert-tag.above {
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.3);
        color: #22c55e;
    }

    .alert-tag.below {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #ef4444;
    }

    .action-btn.alert {
        background: rgba(249, 115, 22, 0.1);
        border-color: rgba(249, 115, 22, 0.3);
        color: #f97316;
    }

    .action-btn.alert:hover {
        background: rgba(249, 115, 22, 0.2);
        border-color: #f97316;
    }

    .stock-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
    }

    .stock-ticker {
        font-size: 1.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, #00d9ff, #a855f7);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-family: 'JetBrains Mono', monospace;
    }

    .stock-company {
        font-size: 0.875rem;
        color: rgba(255, 255, 255, 0.5);
        margin-top: 4px;
    }

    .stock-price {
        text-align: right;
    }

    .price-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #fff;
        font-family: 'JetBrains Mono', monospace;
    }

    .price-change {
        font-size: 0.875rem;
        font-weight: 600;
        margin-top: 4px;
        padding: 4px 10px;
        border-radius: 6px;
        display: inline-block;
    }

    .price-change.positive {
        color: #22c55e;
        background: rgba(34, 197, 94, 0.1);
    }

    .price-change.negative {
        color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
    }

    .stock-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        padding: 16px 0;
        border-top: 1px solid rgba(255, 255, 255, 0.06);
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        margin-bottom: 16px;
    }

    .stat-item {
        text-align: center;
    }

    .stat-item-label {
        font-size: 0.6875rem;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.4);
        letter-spacing: 0.05em;
    }

    .stat-item-value {
        font-size: 0.875rem;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.8);
        font-family: 'JetBrains Mono', monospace;
        margin-top: 4px;
    }

    .stock-notes {
        font-size: 0.8125rem;
        color: rgba(255, 255, 255, 0.5);
        line-height: 1.5;
        margin-bottom: 16px;
        min-height: 20px;
    }

    .stock-actions {
        display: flex;
        gap: 10px;
    }

    .action-btn {
        flex: 1;
        padding: 10px;
        border-radius: 8px;
        font-size: 0.8125rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
    }

    .action-btn.view {
        background: rgba(0, 217, 255, 0.1);
        border: 1px solid rgba(0, 217, 255, 0.3);
        color: #00d9ff;
    }

    .action-btn.view:hover {
        background: rgba(0, 217, 255, 0.2);
    }

    .action-btn.edit {
        background: rgba(168, 85, 247, 0.1);
        border: 1px solid rgba(168, 85, 247, 0.3);
        color: #a855f7;
    }

    .action-btn.edit:hover {
        background: rgba(168, 85, 247, 0.2);
    }

    .action-btn.remove {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #ef4444;
    }

    .action-btn.remove:hover {
        background: rgba(239, 68, 68, 0.2);
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
    }

    .empty-icon {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.5;
    }

    .empty-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 8px;
    }

    .empty-subtitle {
        font-size: 0.875rem;
        color: rgba(255, 255, 255, 0.4);
        margin-bottom: 24px;
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-container {
        background: #0a0a0a;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        width: 100%;
        max-width: 480px;
        margin: 20px;
        overflow: hidden;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 24px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .modal-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #fff;
    }

    .modal-close {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.05);
        border: none;
        color: rgba(255, 255, 255, 0.5);
        font-size: 1.25rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .modal-close:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
    }

    .modal-body {
        padding: 24px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        font-size: 0.8125rem;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 8px;
    }

    .form-input {
        width: 100%;
        padding: 14px 16px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        color: #fff;
        font-size: 1rem;
        transition: all 0.2s ease;
    }

    .form-input:focus {
        outline: none;
        border-color: #00d9ff;
        box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.1);
    }

    .form-input::placeholder {
        color: rgba(255, 255, 255, 0.3);
    }

    textarea.form-input {
        resize: vertical;
        min-height: 100px;
    }

    .modal-actions {
        display: flex;
        gap: 12px;
        margin-top: 24px;
    }

    .btn-cancel {
        flex: 1;
        padding: 14px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        color: rgba(255, 255, 255, 0.7);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-cancel:hover {
        background: rgba(255, 255, 255, 0.08);
        color: #fff;
    }

    .btn-submit {
        flex: 1;
        padding: 14px;
        background: linear-gradient(135deg, #00d9ff, #a855f7);
        border: none;
        border-radius: 10px;
        color: #000;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-submit:hover {
        transform: scale(1.02);
        box-shadow: 0 4px 20px rgba(0, 217, 255, 0.3);
    }

    .loading-state {
        text-align: center;
        padding: 60px 20px;
        color: rgba(255, 255, 255, 0.5);
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-top-color: #00d9ff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="content-header">
    <div>
        <h1 class="content-title">Watchlist</h1>
        <p class="content-subtitle">Monitor your favorite stocks in real-time</p>
    </div>
    <button class="add-btn" onclick="openAddStockModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path d="M12 5v14M5 12h14"/>
        </svg>
        Add Stock
    </button>
</div>

<!-- Stats Overview -->
<div class="stats-row">
    <div class="stat-card total">
        <div class="stat-label">Total Stocks</div>
        <div class="stat-value cyan" id="stat-total">0</div>
    </div>
    <div class="stat-card gainers">
        <div class="stat-label">Gainers</div>
        <div class="stat-value green" id="stat-gainers">0</div>
    </div>
    <div class="stat-card losers">
        <div class="stat-label">Losers</div>
        <div class="stat-value red" id="stat-losers">0</div>
    </div>
    <div class="stat-card neutral">
        <div class="stat-label">Unchanged</div>
        <div class="stat-value gray" id="stat-neutral">0</div>
    </div>
</div>

<!-- Watchlist Section -->
<div class="watchlist-section">
    <div class="section-header">
        <h2 class="section-title">Your Stocks</h2>
        <div style="display: flex; align-items: center; gap: 12px;">
            <div class="live-indicator" id="live-indicator">
                <span class="live-dot"></span>
                LIVE
            </div>
            <span id="last-updated" style="font-size: 0.75rem; color: rgba(255,255,255,0.4);"></span>
        </div>
    </div>
    <div id="watchlist-container">
        <div class="loading-state">
            <div class="loading-spinner"></div>
            Loading watchlist...
        </div>
    </div>
</div>

<!-- Add Stock Modal -->
<div id="addStockModal" class="modal-overlay" style="display: none;">
    <div class="modal-container">
        <div class="modal-header">
            <h3 class="modal-title">Add to Watchlist</h3>
            <button class="modal-close" onclick="closeAddStockModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="addStockForm" onsubmit="addStock(event); return false;">
                <div class="form-group">
                    <label class="form-label">Ticker Symbol</label>
                    <input type="text" id="ticker" class="form-input" placeholder="e.g., AAPL, TSLA, NVDA"
                        required maxlength="5" style="text-transform: uppercase;">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes (Optional)</label>
                    <textarea id="notes" class="form-input" placeholder="Why are you tracking this stock?"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeAddStockModal()">Cancel</button>
                    <button type="submit" class="btn-submit">Add to Watchlist</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Notes Modal -->
<div id="editNotesModal" class="modal-overlay" style="display: none;">
    <div class="modal-container">
        <div class="modal-header">
            <h3 class="modal-title">Edit Notes</h3>
            <button class="modal-close" onclick="closeEditNotesModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editNotesForm" onsubmit="updateNotes(event); return false;">
                <input type="hidden" id="edit-item-id">
                <div class="form-group">
                    <label class="form-label">Notes for <span id="edit-ticker" style="color: #00d9ff;"></span></label>
                    <textarea id="edit-notes" class="form-input" placeholder="Add your notes..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeEditNotesModal()">Cancel</button>
                    <button type="submit" class="btn-submit">Save Notes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Price Alert Modal -->
<div id="alertModal" class="modal-overlay" style="display: none;">
    <div class="modal-container">
        <div class="modal-header">
            <h3 class="modal-title">Set Price Alerts</h3>
            <button class="modal-close" onclick="closeAlertModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="alertForm" onsubmit="saveAlerts(event); return false;">
                <input type="hidden" id="alert-item-id">
                <div style="text-align: center; margin-bottom: 20px;">
                    <span id="alert-ticker" style="font-size: 1.5rem; font-weight: 700; color: #00d9ff;"></span>
                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.5); margin-top: 4px;">
                        Current: <span id="alert-current-price" style="color: #fff;">$0.00</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" style="color: #22c55e;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle;">
                            <path d="M18 15l-6-6-6 6"/>
                        </svg>
                        Alert when price goes ABOVE
                    </label>
                    <input type="number" step="0.01" id="alert-above" class="form-input" placeholder="e.g., 150.00" style="border-color: rgba(34, 197, 94, 0.3);">
                </div>
                <div class="form-group">
                    <label class="form-label" style="color: #ef4444;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle;">
                            <path d="M6 9l6 6 6-6"/>
                        </svg>
                        Alert when price goes BELOW
                    </label>
                    <input type="number" step="0.01" id="alert-below" class="form-input" placeholder="e.g., 130.00" style="border-color: rgba(239, 68, 68, 0.3);">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="clearAlerts()">Clear Alerts</button>
                    <button type="submit" class="btn-submit">Save Alerts</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let watchlistData = [];

    async function loadWatchlist() {
        try {
            const response = await fetch('/api/watchlist');
            const data = await response.json();

            watchlistData = data;
            renderWatchlist(data);
            updateStats(data);

            // Update timestamp
            document.getElementById('last-updated').textContent =
                'Updated ' + new Date().toLocaleTimeString();
        } catch (error) {
            console.error('Error loading watchlist:', error);
            document.getElementById('watchlist-container').innerHTML =
                '<div class="loading-state" style="color: #ef4444;">Error loading watchlist. Please refresh.</div>';
        }
    }

    function updateStats(data) {
        let gainers = 0, losers = 0, neutral = 0;

        data.forEach(stock => {
            const change = stock.change_percent || 0;
            if (change > 0) gainers++;
            else if (change < 0) losers++;
            else neutral++;
        });

        document.getElementById('stat-total').textContent = data.length;
        document.getElementById('stat-gainers').textContent = gainers;
        document.getElementById('stat-losers').textContent = losers;
        document.getElementById('stat-neutral').textContent = neutral;
    }

    function renderWatchlist(data) {
        const container = document.getElementById('watchlist-container');

        if (!data || data.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.4;">
                            <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="empty-title">Your watchlist is empty</div>
                    <div class="empty-subtitle">Start tracking stocks by adding your first ticker</div>
                    <button class="add-btn" onclick="openAddStockModal()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                        Add Your First Stock
                    </button>
                </div>
            `;
            return;
        }

        container.innerHTML = '<div class="watchlist-grid" id="watchlist-grid"></div>';
        const grid = document.getElementById('watchlist-grid');

        data.forEach(stock => {
            const changePct = stock.change_percent || 0;
            const change = stock.change || 0;
            const isPositive = changePct >= 0;
            const changeClass = isPositive ? 'positive' : 'negative';

            const card = document.createElement('div');
            card.className = 'stock-card';
            card.setAttribute('data-ticker', stock.ticker);
            card.innerHTML = `
                <div class="stock-card-header">
                    <div>
                        <div class="stock-ticker">${stock.ticker}</div>
                        <div class="stock-company">${stock.company_name || 'Loading...'}</div>
                    </div>
                    <div class="stock-price">
                        <div class="price-value">$${(stock.price || 0).toFixed(2)}</div>
                        <div class="price-change ${changeClass}">
                            ${isPositive ? '▲' : '▼'} ${Math.abs(change).toFixed(2)} (${isPositive ? '+' : ''}${changePct.toFixed(2)}%)
                        </div>
                    </div>
                </div>
                <div class="stock-stats">
                    <div class="stat-item">
                        <div class="stat-item-label">High</div>
                        <div class="stat-item-value">$${(stock.day_high || stock.price || 0).toFixed(2)}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item-label">Low</div>
                        <div class="stat-item-value">$${(stock.day_low || stock.price || 0).toFixed(2)}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item-label">Volume</div>
                        <div class="stat-item-value">${formatVolume(stock.volume)}</div>
                    </div>
                </div>
                <div class="stock-notes">${stock.notes || '<span style="opacity: 0.5; font-style: italic;">No notes</span>'}</div>
                ${stock.alert_triggered ? `
                    <div class="alert-banner ${stock.alert_triggered}">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                        </svg>
                        ${stock.alert_message}
                    </div>
                ` : ''}
                ${(stock.alert_price_above || stock.alert_price_below) && !stock.alert_triggered ? `
                    <div class="alert-status">
                        ${stock.alert_price_above ? `<span class="alert-tag above">▲ $${stock.alert_price_above.toFixed(2)}</span>` : ''}
                        ${stock.alert_price_below ? `<span class="alert-tag below">▼ $${stock.alert_price_below.toFixed(2)}</span>` : ''}
                    </div>
                ` : ''}
                <div class="stock-actions">
                    <button class="action-btn view" onclick="window.location='/stocks/${stock.ticker}'">View Chart</button>
                    <button class="action-btn alert" onclick="openAlertModal(${stock.id}, '${stock.ticker}', ${stock.alert_price_above || 'null'}, ${stock.alert_price_below || 'null'}, ${stock.price || 0})">Alert</button>
                    <button class="action-btn edit" onclick="openEditNotesModal(${stock.id}, '${stock.ticker}', '${(stock.notes || '').replace(/'/g, "\\'")}')">Edit</button>
                    <button class="action-btn remove" onclick="removeStock(${stock.id}, '${stock.ticker}')">Remove</button>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    function formatVolume(volume) {
        if (!volume) return '0';
        if (volume >= 1e9) return (volume / 1e9).toFixed(1) + 'B';
        if (volume >= 1e6) return (volume / 1e6).toFixed(1) + 'M';
        if (volume >= 1e3) return (volume / 1e3).toFixed(1) + 'K';
        return volume.toLocaleString();
    }

    function openAddStockModal() {
        document.getElementById('addStockModal').style.display = 'flex';
        document.getElementById('ticker').focus();
    }

    function closeAddStockModal() {
        document.getElementById('addStockModal').style.display = 'none';
        document.getElementById('addStockForm').reset();
    }

    function openEditNotesModal(itemId, ticker, notes) {
        document.getElementById('edit-item-id').value = itemId;
        document.getElementById('edit-ticker').textContent = ticker;
        document.getElementById('edit-notes').value = notes || '';
        document.getElementById('editNotesModal').style.display = 'flex';
    }

    function closeEditNotesModal() {
        document.getElementById('editNotesModal').style.display = 'none';
        document.getElementById('editNotesForm').reset();
    }

    // Alert Modal Functions
    function openAlertModal(itemId, ticker, alertAbove, alertBelow, currentPrice) {
        document.getElementById('alert-item-id').value = itemId;
        document.getElementById('alert-ticker').textContent = ticker;
        document.getElementById('alert-current-price').textContent = '$' + (currentPrice || 0).toFixed(2);
        document.getElementById('alert-above').value = alertAbove || '';
        document.getElementById('alert-below').value = alertBelow || '';
        document.getElementById('alertModal').style.display = 'flex';
    }

    function closeAlertModal() {
        document.getElementById('alertModal').style.display = 'none';
        document.getElementById('alertForm').reset();
    }

    async function saveAlerts(event) {
        event.preventDefault();

        const itemId = document.getElementById('alert-item-id').value;
        const alertAbove = document.getElementById('alert-above').value;
        const alertBelow = document.getElementById('alert-below').value;

        try {
            const response = await fetch(`/api/watchlist/${itemId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    alert_price_above: alertAbove ? parseFloat(alertAbove) : null,
                    alert_price_below: alertBelow ? parseFloat(alertBelow) : null
                })
            });

            if (response.ok) {
                closeAlertModal();
                await loadWatchlist();
            } else {
                const result = await response.json();
                alert(result.error || 'Failed to save alerts');
            }
        } catch (error) {
            console.error('Error saving alerts:', error);
            alert('Network error. Please try again.');
        }
    }

    async function clearAlerts() {
        const itemId = document.getElementById('alert-item-id').value;

        try {
            const response = await fetch(`/api/watchlist/${itemId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    alert_price_above: null,
                    alert_price_below: null
                })
            });

            if (response.ok) {
                closeAlertModal();
                await loadWatchlist();
            }
        } catch (error) {
            console.error('Error clearing alerts:', error);
        }
    }

    async function addStock(event) {
        event.preventDefault();

        const ticker = document.getElementById('ticker').value.toUpperCase().trim();
        const notes = document.getElementById('notes').value.trim();

        try {
            const response = await fetch('/api/watchlist', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ticker, notes })
            });

            const result = await response.json();

            if (response.ok) {
                closeAddStockModal();
                await loadWatchlist();
            } else {
                alert(result.error || 'Failed to add stock');
            }
        } catch (error) {
            console.error('Error adding stock:', error);
            alert('Network error. Please try again.');
        }
    }

    async function updateNotes(event) {
        event.preventDefault();

        const itemId = document.getElementById('edit-item-id').value;
        const notes = document.getElementById('edit-notes').value.trim();

        try {
            const response = await fetch(`/api/watchlist/${itemId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ notes })
            });

            if (response.ok) {
                closeEditNotesModal();
                await loadWatchlist();
            } else {
                const result = await response.json();
                alert(result.error || 'Failed to update notes');
            }
        } catch (error) {
            console.error('Error updating notes:', error);
            alert('Network error. Please try again.');
        }
    }

    async function removeStock(itemId, ticker) {
        if (!confirm(`Remove ${ticker} from watchlist?`)) return;

        try {
            const response = await fetch(`/api/watchlist/${itemId}`, { method: 'DELETE' });

            if (response.ok) {
                await loadWatchlist();
            } else {
                const result = await response.json();
                alert(result.error || 'Failed to remove stock');
            }
        } catch (error) {
            console.error('Error removing stock:', error);
            alert('Network error. Please try again.');
        }
    }

    // Close modals on outside click
    document.getElementById('addStockModal').addEventListener('click', function(e) {
        if (e.target === this) closeAddStockModal();
    });

    document.getElementById('editNotesModal').addEventListener('click', function(e) {
        if (e.target === this) closeEditNotesModal();
    });

    document.getElementById('alertModal').addEventListener('click', function(e) {
        if (e.target === this) closeAlertModal();
    });

    // Load on page load
    loadWatchlist();

    // Auto-refresh prices every 15 seconds
    let priceRefreshInterval = setInterval(loadWatchlist, 15000);

    // Live price update indicator
    function showLiveIndicator() {
        const indicator = document.getElementById('live-indicator');
        if (indicator) {
            indicator.classList.add('pulse');
            setTimeout(() => indicator.classList.remove('pulse'), 1000);
        }
    }

    // Price change flash animation
    function flashPriceChange(ticker, newPrice, oldPrice) {
        const card = document.querySelector(`[data-ticker="${ticker}"]`);
        if (!card) return;

        const priceEl = card.querySelector('.price-value');
        if (!priceEl) return;

        if (newPrice > oldPrice) {
            priceEl.classList.add('flash-green');
            setTimeout(() => priceEl.classList.remove('flash-green'), 500);
        } else if (newPrice < oldPrice) {
            priceEl.classList.add('flash-red');
            setTimeout(() => priceEl.classList.remove('flash-red'), 500);
        }
    }

    // Track previous prices for flash animation
    let previousPrices = {};

    // Enhanced loadWatchlist with price flash
    const originalLoad = loadWatchlist;
    loadWatchlist = async function() {
        const oldPrices = {...previousPrices};
        await originalLoad();

        // Flash changed prices
        watchlistData.forEach(stock => {
            if (oldPrices[stock.ticker] && oldPrices[stock.ticker] !== stock.price) {
                flashPriceChange(stock.ticker, stock.price, oldPrices[stock.ticker]);
            }
            previousPrices[stock.ticker] = stock.price;
        });

        showLiveIndicator();
    };
</script>
{% endblock %}
