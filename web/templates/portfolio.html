<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio - Qunex Trade</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/basic.css">
    <script src="/static/toast.js"></script>
    <style>
        .portfolio-header {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
        }

        .portfolio-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }

        .stat-card {
            background: var(--bg-dark);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .stat-label {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2.2em;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-value.positive { color: #22c55e; }
        .stat-value.negative { color: #ef4444; }
        .stat-value.neutral { color: var(--text-primary); }

        .portfolio-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .section-title {
            font-size: 1.5em;
            font-weight: 600;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 0.95em;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(168, 85, 247, 0.4);
        }

        .btn-secondary {
            background: var(--bg-dark);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--primary);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .holdings-table {
            width: 100%;
            border-collapse: collapse;
        }

        .holdings-table th {
            text-align: left;
            padding: 16px;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border);
        }

        .holdings-table td {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .holdings-table tr:hover {
            background: rgba(168, 85, 247, 0.05);
        }

        .ticker-cell {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 1.1em;
            color: var(--primary);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-dark);
            color: var(--text-primary);
            font-size: 1em;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .transaction-type-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .type-option {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid var(--border);
            background: var(--bg-dark);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .type-option.active {
            border-color: var(--primary);
            background: rgba(168, 85, 247, 0.1);
            color: var(--primary);
        }

        .transactions-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--bg-dark);
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-ticker {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 1.1em;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .transaction-details {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .transaction-type {
            padding: 4px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.85em;
            margin-right: 12px;
        }

        .type-buy {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .type-sell {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <a href="/" class="nav-brand">
                <div class="logo">Q</div>
                <span class="brand-text">Qunex</span>
            </a>
            <div class="nav-links">
                <a href="/">Home</a>
                <a href="/stocks">Stocks</a>
                <a href="/market">Market</a>
                <a href="/news">News</a>
                <a href="/calendar">Calendar</a>
                <a href="/watchlist">Watchlist</a>
                <a href="/dashboard">Dashboard</a>
                <a href="/portfolio" class="active">Portfolio</a>
                <a href="/account">Account</a>
            </div>
        </nav>

        <!-- Portfolio Header -->
        <div class="portfolio-header">
            <h1 style="font-size: 2.5em; margin-bottom: 8px;">
                üíº Portfolio
            </h1>
            <p style="color: var(--text-secondary); font-size: 1.1em;">
                Track your investments and P&L
            </p>

            <div class="portfolio-stats">
                <div class="stat-card">
                    <div class="stat-label">Total Value</div>
                    <div class="stat-value neutral">
                        ${{ "%.2f"|format(portfolio.total_value) if portfolio.total_value else "0.00" }}
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Cost</div>
                    <div class="stat-value neutral">
                        ${{ "%.2f"|format(portfolio.total_cost) if portfolio.total_cost else "0.00" }}
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total P&L</div>
                    <div class="stat-value {{ 'positive' if portfolio.total_pnl > 0 else 'negative' if portfolio.total_pnl < 0 else 'neutral' }}">
                        {{ '+' if portfolio.total_pnl > 0 else '' }}${{ "%.2f"|format(portfolio.total_pnl) if portfolio.total_pnl else "0.00" }}
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Return</div>
                    <div class="stat-value {{ 'positive' if portfolio.total_pnl_pct > 0 else 'negative' if portfolio.total_pnl_pct < 0 else 'neutral' }}">
                        {{ '+' if portfolio.total_pnl_pct > 0 else '' }}{{ "%.2f"|format(portfolio.total_pnl_pct) if portfolio.total_pnl_pct else "0.00" }}%
                    </div>
                </div>
            </div>
        </div>

        <!-- Holdings Section -->
        <div class="portfolio-section">
            <div class="section-header">
                <h2 class="section-title">Current Holdings</h2>
                <button class="btn btn-primary" onclick="openAddTransactionModal()">
                    + Add Transaction
                </button>
            </div>

            {% if portfolio.holdings %}
            <table class="holdings-table">
                <thead>
                    <tr>
                        <th>Ticker</th>
                        <th>Shares</th>
                        <th>Avg Cost</th>
                        <th>Current Price</th>
                        <th>Market Value</th>
                        <th>P&L</th>
                        <th>Return</th>
                    </tr>
                </thead>
                <tbody>
                    {% for holding in portfolio.holdings %}
                    <tr>
                        <td class="ticker-cell">{{ holding.ticker }}</td>
                        <td>{{ "%.4f"|format(holding.shares) }}</td>
                        <td>${{ "%.2f"|format(holding.avg_cost) }}</td>
                        <td>${{ "%.2f"|format(holding.current_price) }}</td>
                        <td>${{ "%.2f"|format(holding.market_value) }}</td>
                        <td style="color: {{ '#22c55e' if holding.pnl > 0 else '#ef4444' if holding.pnl < 0 else 'inherit' }}; font-weight: 600;">
                            {{ '+' if holding.pnl > 0 else '' }}${{ "%.2f"|format(holding.pnl) }}
                        </td>
                        <td style="color: {{ '#22c55e' if holding.pnl_pct > 0 else '#ef4444' if holding.pnl_pct < 0 else 'inherit' }}; font-weight: 600;">
                            {{ '+' if holding.pnl_pct > 0 else '' }}{{ "%.2f"|format(holding.pnl_pct) }}%
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">üìä</div>
                <h3 style="margin-bottom: 12px; font-size: 1.5em;">No holdings yet</h3>
                <p style="margin-bottom: 24px;">Start tracking your investments by adding transactions</p>
                <button class="btn btn-primary" onclick="openAddTransactionModal()">
                    + Add Your First Transaction
                </button>
            </div>
            {% endif %}
        </div>

        <!-- Transaction History -->
        <div class="portfolio-section">
            <div class="section-header">
                <h2 class="section-title">Transaction History</h2>
            </div>

            {% if transactions %}
            <div class="transactions-list">
                {% for txn in transactions %}
                <div class="transaction-item">
                    <div class="transaction-info">
                        <div class="transaction-ticker">{{ txn.ticker }}</div>
                        <div class="transaction-details">
                            <span class="transaction-type type-{{ txn.transaction_type }}">
                                {{ txn.transaction_type|upper }}
                            </span>
                            {{ "%.4f"|format(txn.shares) }} shares @ ${{ "%.2f"|format(txn.price) }}
                            ‚Ä¢ {{ txn.transaction_date.strftime('%b %d, %Y') if txn.transaction_date else 'Recently' }}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 700; font-size: 1.1em; font-family: 'JetBrains Mono', monospace;">
                            ${{ "%.2f"|format(txn.shares * txn.price) }}
                        </div>
                        <button class="btn-danger" style="margin-top: 8px; padding: 4px 12px; font-size: 0.85em;"
                                onclick="deleteTransaction({{ txn.id }})">
                            Delete
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state" style="padding: 40px 20px;">
                <div class="empty-icon" style="font-size: 3em;">üìù</div>
                <p>No transactions recorded yet</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Add Transaction Modal -->
    <div id="addTransactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Add Transaction</div>

            <div class="transaction-type-selector">
                <div class="type-option active" onclick="selectTransactionType('buy')" data-type="buy">
                    üìà BUY
                </div>
                <div class="type-option" onclick="selectTransactionType('sell')" data-type="sell">
                    üìâ SELL
                </div>
            </div>

            <form id="transactionForm" onsubmit="submitTransaction(event)">
                <input type="hidden" id="transactionType" value="buy">

                <div class="form-group">
                    <label class="form-label">Ticker Symbol</label>
                    <input type="text" id="ticker" class="form-input" placeholder="e.g., AAPL" required
                           style="text-transform: uppercase;">
                </div>

                <div class="form-group">
                    <label class="form-label">Number of Shares</label>
                    <input type="number" id="shares" class="form-input" placeholder="e.g., 10"
                           step="0.0001" min="0.0001" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Price per Share ($)</label>
                    <input type="number" id="price" class="form-input" placeholder="e.g., 150.00"
                           step="0.01" min="0.01" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Notes (Optional)</label>
                    <input type="text" id="notes" class="form-input" placeholder="Add notes...">
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeAddTransactionModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        Add Transaction
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function openAddTransactionModal() {
            document.getElementById('addTransactionModal').classList.add('active');
        }

        function closeAddTransactionModal() {
            document.getElementById('addTransactionModal').classList.remove('active');
            document.getElementById('transactionForm').reset();
        }

        function selectTransactionType(type) {
            document.getElementById('transactionType').value = type;

            document.querySelectorAll('.type-option').forEach(opt => {
                opt.classList.remove('active');
            });
            document.querySelector(`.type-option[data-type="${type}"]`).classList.add('active');
        }

        async function submitTransaction(event) {
            event.preventDefault();

            const data = {
                ticker: document.getElementById('ticker').value.toUpperCase(),
                shares: parseFloat(document.getElementById('shares').value),
                price: parseFloat(document.getElementById('price').value),
                transaction_type: document.getElementById('transactionType').value,
                notes: document.getElementById('notes').value
            };

            try {
                const response = await fetch('/api/portfolio/transaction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    showToast('Transaction added successfully!', 'success');
                    closeAddTransactionModal();
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(result.error || 'Failed to add transaction', 'error');
                }
            } catch (error) {
                showToast('Network error. Please try again.', 'error');
            }
        }

        async function deleteTransaction(transactionId) {
            if (!confirm('Are you sure you want to delete this transaction?')) return;

            try {
                const response = await fetch(`/api/portfolio/transaction/${transactionId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    showToast('Transaction deleted', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(result.error || 'Failed to delete transaction', 'error');
                }
            } catch (error) {
                showToast('Network error. Please try again.', 'error');
            }
        }

        // Close modal on outside click
        document.getElementById('addTransactionModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAddTransactionModal();
            }
        });
    </script>
</body>
</html>
