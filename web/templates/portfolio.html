{% extends "base_layout.html" %}

{% block title %}Portfolio - Qunex Trade{% endblock %}

{% block extra_styles %}
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
    /* Portfolio Summary */
    .portfolio-summary {
        background: linear-gradient(135deg, rgba(0, 217, 255, 0.1), rgba(168, 85, 247, 0.1));
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        padding: 32px;
        margin-bottom: 32px;
    }

    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 24px;
    }

    .summary-item {
        text-align: center;
    }

    .summary-label {
        font-size: var(--text-sm);
        color: var(--text-tertiary);
        margin-bottom: 8px;
    }

    .summary-value {
        font-size: var(--text-2xl);
        font-weight: var(--font-bold);
        font-family: 'JetBrains Mono', monospace;
    }

    .summary-value.positive { color: var(--success); }
    .summary-value.negative { color: var(--danger); }

    /* Holdings Section */
    .holdings-section {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        overflow: hidden;
        margin-bottom: 32px;
    }

    .section-header {
        padding: 20px 24px;
        background: var(--bg-hover);
        border-bottom: 1px solid var(--border-subtle);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .section-title {
        font-size: var(--text-xl);
        font-weight: var(--font-semibold);
    }

    .holdings-table {
        width: 100%;
        border-collapse: collapse;
    }

    .holdings-table th {
        padding: 16px 24px;
        text-align: left;
        font-size: var(--text-xs);
        font-weight: var(--font-semibold);
        color: var(--text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        background: var(--bg-hover);
    }

    .holdings-table th.text-right { text-align: right; }

    .holdings-table tbody tr {
        border-bottom: 1px solid var(--border-subtle);
        transition: all var(--transition-fast);
    }

    .holdings-table tbody tr:hover {
        background: var(--bg-hover);
    }

    .holdings-table td {
        padding: 20px 24px;
        font-size: var(--text-sm);
    }

    .stock-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .stock-logo {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, rgba(0, 217, 255, 0.2), rgba(168, 85, 247, 0.2));
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: var(--font-bold);
        font-size: var(--text-xs);
    }

    .stock-symbol { font-weight: var(--font-semibold); }
    .stock-name { font-size: var(--text-xs); color: var(--text-tertiary); }

    .positive { color: var(--success); }
    .negative { color: var(--danger); }

    .action-buttons {
        display: flex;
        gap: 8px;
    }

    .btn-action {
        padding: 6px 12px;
        border-radius: var(--radius-md);
        font-size: var(--text-xs);
        font-weight: var(--font-semibold);
        cursor: pointer;
        transition: all var(--transition-fast);
        border: none;
    }

    .btn-edit {
        background: rgba(0, 217, 255, 0.1);
        color: var(--accent-cyan);
        border: 1px solid rgba(0, 217, 255, 0.3);
    }

    .btn-edit:hover {
        background: rgba(0, 217, 255, 0.2);
    }

    .btn-delete {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .btn-delete:hover {
        background: rgba(239, 68, 68, 0.2);
    }

    /* Empty State */
    .empty-state {
        padding: 64px 24px;
        text-align: center;
    }

    .empty-icon {
        margin-bottom: 24px;
        color: var(--text-secondary);
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .empty-title {
        font-size: var(--text-xl);
        font-weight: var(--font-semibold);
        margin-bottom: 8px;
    }

    .empty-text {
        color: var(--text-tertiary);
        margin-bottom: 24px;
    }

    /* Transaction History */
    .transactions-section {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        overflow: hidden;
    }

    .transaction-list {
        padding: 24px;
        max-height: 400px;
        overflow-y: auto;
    }

    .transaction-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        background: var(--bg-hover);
        border-radius: var(--radius-lg);
        margin-bottom: 12px;
        transition: all var(--transition-fast);
    }

    .transaction-item:last-child {
        margin-bottom: 0;
    }

    .transaction-info {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .transaction-type {
        padding: 6px 12px;
        border-radius: var(--radius-sm);
        font-size: var(--text-xs);
        font-weight: var(--font-semibold);
        text-transform: uppercase;
    }

    .transaction-type.buy {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success);
        border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .transaction-type.sell {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .transaction-ticker { font-weight: var(--font-semibold); }
    .transaction-meta { font-size: var(--text-xs); color: var(--text-tertiary); }
    .transaction-amount { font-size: var(--text-lg); font-weight: var(--font-semibold); font-family: 'JetBrains Mono', monospace; }
    .transaction-date { font-size: var(--text-xs); color: var(--text-tertiary); }
    .text-right { text-align: right; }

    /* Modal */
    .modal-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
    }

    .modal-overlay.show { display: flex; }

    .modal-container {
        background: var(--bg-card);
        border: 1px solid var(--border-medium);
        border-radius: var(--radius-xl);
        padding: 32px;
        width: 90%;
        max-width: 500px;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .modal-title { font-size: var(--text-xl); font-weight: var(--font-bold); }

    .modal-close {
        width: 32px; height: 32px;
        background: var(--bg-hover);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--text-secondary);
    }

    .transaction-types {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 24px;
    }

    .type-button {
        padding: 12px;
        background: var(--bg-hover);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        font-weight: var(--font-semibold);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .type-button.active.buy {
        background: rgba(34, 197, 94, 0.1);
        border-color: rgba(34, 197, 94, 0.3);
        color: var(--success);
    }

    .type-button.active.sell {
        background: rgba(239, 68, 68, 0.1);
        border-color: rgba(239, 68, 68, 0.3);
        color: var(--danger);
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        color: var(--text-secondary);
        margin-bottom: 8px;
    }

    .form-input {
        width: 100%;
        padding: 12px 16px;
        background: var(--bg-hover);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-size: var(--text-base);
        transition: all var(--transition-fast);
    }

    .form-input:focus {
        outline: none;
        border-color: var(--accent-cyan);
        box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.1);
    }

    .form-hint {
        font-size: var(--text-xs);
        color: var(--text-tertiary);
        margin-top: 6px;
    }

    .form-hint.error {
        color: var(--danger);
    }

    .modal-actions {
        display: flex;
        gap: 12px;
        margin-top: 24px;
    }

    .btn-modal {
        flex: 1;
        padding: 12px;
        border-radius: var(--radius-md);
        font-weight: var(--font-semibold);
        cursor: pointer;
        border: none;
        transition: all var(--transition-fast);
    }

    .btn-cancel {
        background: var(--bg-hover);
        border: 1px solid var(--border-subtle);
        color: var(--text-secondary);
    }

    .btn-confirm {
        background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
        color: #000;
    }

    .btn-confirm:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Loading */
    .loading-spinner {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 64px;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--border-subtle);
        border-top-color: var(--accent-cyan);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
        .holdings-table th, .holdings-table td { padding: 12px; }
        .action-buttons { flex-direction: column; }
    }
</style>
{% endblock %}

{% block content %}
<div class="content-header">
    <div>
        <h1 class="content-title">My Portfolio</h1>
        <p class="content-subtitle">Track and manage your stock holdings</p>
    </div>
    <button class="btn btn-primary" onclick="showTransactionModal()">+ Add Transaction</button>
</div>

<!-- Portfolio Summary -->
<div class="portfolio-summary">
    <div class="summary-grid">
        <div class="summary-item">
            <div class="summary-label">Total Value</div>
            <div class="summary-value" id="totalValue">$0.00</div>
        </div>
        <div class="summary-item">
            <div class="summary-label">Total Cost</div>
            <div class="summary-value" id="totalCost">$0.00</div>
        </div>
        <div class="summary-item">
            <div class="summary-label">Total Gain/Loss</div>
            <div class="summary-value" id="totalGain">$0.00</div>
        </div>
        <div class="summary-item">
            <div class="summary-label">Positions</div>
            <div class="summary-value" id="totalPositions">0</div>
        </div>
    </div>
</div>

<!-- Holdings Table -->
<div class="holdings-section">
    <div class="section-header">
        <h2 class="section-title">Holdings</h2>
    </div>
    <div id="holdingsContent">
        <div class="loading-spinner">
            <div class="spinner"></div>
        </div>
    </div>
</div>

<!-- Transaction History -->
<div class="transactions-section">
    <div class="section-header">
        <h2 class="section-title">Transaction History</h2>
    </div>
    <div class="transaction-list" id="transactionsContent">
        <div class="loading-spinner">
            <div class="spinner"></div>
        </div>
    </div>
</div>

<!-- Transaction Modal -->
<div class="modal-overlay" id="transactionModal">
    <div class="modal-container">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">Add Transaction</h3>
            <button class="modal-close" onclick="hideTransactionModal()">&times;</button>
        </div>
        <div class="transaction-types">
            <button class="type-button buy active" onclick="setTransactionType('buy')">BUY</button>
            <button class="type-button sell" onclick="setTransactionType('sell')">SELL</button>
        </div>
        <form id="transactionForm" onsubmit="submitTransaction(event)">
            <input type="hidden" id="transactionType" value="buy">
            <input type="hidden" id="editingId" value="">

            <div class="form-group">
                <label class="form-label">Stock Symbol</label>
                <input type="text" class="form-input" id="stockSymbol" placeholder="e.g., AAPL" required
                       oninput="this.value = this.value.toUpperCase(); checkSellLimit();">
            </div>

            <div class="form-group">
                <label class="form-label">Number of Shares</label>
                <input type="number" class="form-input" id="shares" placeholder="100" min="1" step="1" required
                       oninput="checkSellLimit();">
                <div class="form-hint" id="sharesHint"></div>
            </div>

            <div class="form-group">
                <label class="form-label">Price per Share</label>
                <input type="number" class="form-input" id="pricePerShare" placeholder="150.00" step="0.01" min="0.01" required>
            </div>

            <div class="form-group">
                <label class="form-label">Date</label>
                <input type="date" class="form-input" id="transactionDate" required>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn-modal btn-cancel" onclick="hideTransactionModal()">Cancel</button>
                <button type="submit" class="btn-modal btn-confirm" id="submitBtn">Add Transaction</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="deleteModal">
    <div class="modal-container">
        <div class="modal-header">
            <h3 class="modal-title">Delete Holding</h3>
            <button class="modal-close" onclick="hideDeleteModal()">&times;</button>
        </div>
        <p style="color: var(--text-secondary); margin-bottom: 24px;">
            Are you sure you want to delete this holding? This action cannot be undone.
        </p>
        <div class="modal-actions">
            <button class="btn-modal btn-cancel" onclick="hideDeleteModal()">Cancel</button>
            <button class="btn-modal btn-delete" onclick="confirmDelete()" style="background: var(--danger); color: white;">Delete</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Store holdings data for validation
    let holdingsData = {};
    let deleteTargetId = null;

    // Load Portfolio Data
    async function loadPortfolio() {
        try {
            const response = await fetch('/api/portfolio');
            if (response.ok) {
                const data = await response.json();
                holdingsData = {};

                // Build holdings map for sell validation
                if (data.holdings) {
                    data.holdings.forEach(h => {
                        holdingsData[h.ticker] = h.shares;
                    });
                }

                updateSummary(data);
                renderHoldings(data.holdings || []);
                renderTransactions(data.transactions || []);
            }
        } catch (error) {
            console.error('Failed to load portfolio:', error);
            document.getElementById('holdingsContent').innerHTML =
                '<div class="empty-state"><p>Failed to load portfolio</p></div>';
        }
    }

    function updateSummary(data) {
        const totalValue = data.total_value || 0;
        const totalCost = data.total_cost || 0;
        const totalGain = totalValue - totalCost;
        const positions = data.holdings ? data.holdings.length : 0;

        document.getElementById('totalValue').textContent = formatPrice(totalValue);
        document.getElementById('totalCost').textContent = formatPrice(totalCost);

        const gainEl = document.getElementById('totalGain');
        gainEl.textContent = `${totalGain >= 0 ? '+' : ''}${formatPrice(totalGain)}`;
        gainEl.className = `summary-value ${totalGain >= 0 ? 'positive' : 'negative'}`;

        document.getElementById('totalPositions').textContent = positions;
    }

    function renderHoldings(holdings) {
        const container = document.getElementById('holdingsContent');

        if (!holdings || holdings.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.4;">
                            <path d="M3 3v18h18" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M7 16l4-4 4 4 5-6" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="empty-title">No Holdings Yet</div>
                    <p class="empty-text">Start building your portfolio by adding your first transaction</p>
                    <button class="btn btn-primary" onclick="showTransactionModal()">+ Add Transaction</button>
                </div>
            `;
            return;
        }

        container.innerHTML = `
            <table class="holdings-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th class="text-right">Shares</th>
                        <th class="text-right">Avg Cost</th>
                        <th class="text-right">Current Price</th>
                        <th class="text-right">Value</th>
                        <th class="text-right">Gain/Loss</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${holdings.map(h => {
                        const gainPercent = h.avg_cost > 0 ? ((h.current_price - h.avg_cost) / h.avg_cost * 100) : 0;
                        const gainAmount = (h.current_price - h.avg_cost) * h.shares;
                        const isPositive = gainPercent >= 0;

                        return `
                            <tr>
                                <td>
                                    <div class="stock-info">
                                        <div class="stock-logo">${h.ticker.substring(0, 2)}</div>
                                        <div>
                                            <div class="stock-symbol">${h.ticker}</div>
                                            <div class="stock-name">${h.name || ''}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-right" style="font-family: 'JetBrains Mono';">${h.shares}</td>
                                <td class="text-right" style="font-family: 'JetBrains Mono';">${formatPrice(h.avg_cost)}</td>
                                <td class="text-right" style="font-family: 'JetBrains Mono';">${formatPrice(h.current_price)}</td>
                                <td class="text-right" style="font-family: 'JetBrains Mono'; font-weight: 600;">${formatPrice(h.shares * h.current_price)}</td>
                                <td class="text-right ${isPositive ? 'positive' : 'negative'}" style="font-family: 'JetBrains Mono'; font-weight: 600;">
                                    ${isPositive ? '+' : ''}${gainPercent.toFixed(2)}%
                                    <br><span style="font-size: 12px;">${isPositive ? '+' : ''}${formatPrice(gainAmount)}</span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-action btn-edit" onclick="editHolding('${h.ticker}', ${h.shares}, ${h.avg_cost})">Edit</button>
                                        <button class="btn-action btn-delete" onclick="showDeleteModal('${h.id || h.ticker}')">Delete</button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;
    }

    function renderTransactions(transactions) {
        const container = document.getElementById('transactionsContent');

        if (!transactions || transactions.length === 0) {
            container.innerHTML = '<div class="empty-state"><p style="color: var(--text-tertiary);">No transactions yet</p></div>';
            return;
        }

        container.innerHTML = transactions.slice(0, 10).map(t => `
            <div class="transaction-item">
                <div class="transaction-info">
                    <span class="transaction-type ${t.type}">${t.type.toUpperCase()}</span>
                    <div>
                        <div class="transaction-ticker">${t.ticker}</div>
                        <div class="transaction-meta">${t.shares} shares @ ${formatPrice(t.price)}</div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="transaction-amount">${formatPrice(t.shares * t.price)}</div>
                    <div class="transaction-date">${formatDate(t.date)}</div>
                </div>
            </div>
        `).join('');
    }

    // Modal Functions
    function showTransactionModal() {
        document.getElementById('transactionModal').classList.add('show');
        document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('modalTitle').textContent = 'Add Transaction';
        document.getElementById('editingId').value = '';
        setTransactionType('buy');
    }

    function hideTransactionModal() {
        document.getElementById('transactionModal').classList.remove('show');
        document.getElementById('transactionForm').reset();
        document.getElementById('sharesHint').textContent = '';
        document.getElementById('sharesHint').className = 'form-hint';
        document.getElementById('submitBtn').disabled = false;
    }

    function setTransactionType(type) {
        document.getElementById('transactionType').value = type;
        document.querySelectorAll('.type-button').forEach(btn => {
            btn.classList.remove('active');
            if (btn.textContent.toLowerCase() === type) {
                btn.classList.add('active');
            }
        });
        checkSellLimit();
    }

    function checkSellLimit() {
        const type = document.getElementById('transactionType').value;
        const symbol = document.getElementById('stockSymbol').value.toUpperCase();
        const shares = parseInt(document.getElementById('shares').value) || 0;
        const hint = document.getElementById('sharesHint');
        const submitBtn = document.getElementById('submitBtn');

        if (type === 'sell' && symbol) {
            const owned = holdingsData[symbol] || 0;
            if (owned > 0) {
                hint.textContent = `You own ${owned} shares of ${symbol}`;
                hint.className = 'form-hint';

                if (shares > owned) {
                    hint.textContent = `Cannot sell more than ${owned} shares (you own ${owned})`;
                    hint.className = 'form-hint error';
                    submitBtn.disabled = true;
                } else {
                    submitBtn.disabled = false;
                }
            } else {
                hint.textContent = `You don't own any ${symbol} shares`;
                hint.className = 'form-hint error';
                submitBtn.disabled = true;
            }
        } else {
            hint.textContent = '';
            hint.className = 'form-hint';
            submitBtn.disabled = false;
        }
    }

    function editHolding(ticker, shares, avgCost) {
        showTransactionModal();
        document.getElementById('modalTitle').textContent = 'Edit Holding';
        document.getElementById('stockSymbol').value = ticker;
        document.getElementById('stockSymbol').readOnly = true;
        document.getElementById('shares').value = shares;
        document.getElementById('pricePerShare').value = avgCost.toFixed(2);
        document.getElementById('editingId').value = ticker;

        // Hide transaction type buttons for edit
        document.querySelector('.transaction-types').style.display = 'none';
    }

    async function submitTransaction(event) {
        event.preventDefault();

        const editingId = document.getElementById('editingId').value;
        const formData = {
            ticker: document.getElementById('stockSymbol').value.toUpperCase(),
            shares: parseFloat(document.getElementById('shares').value),
            price: parseFloat(document.getElementById('pricePerShare').value),
            transaction_type: document.getElementById('transactionType').value,
            date: document.getElementById('transactionDate').value
        };

        try {
            let url = '/api/portfolio/transaction';
            let method = 'POST';

            if (editingId) {
                url = `/api/portfolio/holding/${editingId}`;
                method = 'PUT';
            }

            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                hideTransactionModal();
                loadPortfolio();
            } else {
                const error = await response.json();
                alert(error.message || 'Failed to save transaction');
            }
        } catch (error) {
            alert('Error saving transaction');
        }
    }

    // Delete Functions
    function showDeleteModal(id) {
        deleteTargetId = id;
        document.getElementById('deleteModal').classList.add('show');
    }

    function hideDeleteModal() {
        deleteTargetId = null;
        document.getElementById('deleteModal').classList.remove('show');
    }

    async function confirmDelete() {
        if (!deleteTargetId) return;

        try {
            const response = await fetch(`/api/portfolio/holding/${deleteTargetId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                hideDeleteModal();
                loadPortfolio();
            } else {
                alert('Failed to delete holding');
            }
        } catch (error) {
            alert('Error deleting holding');
        }
    }

    // Utility Functions
    function formatPrice(price) {
        if (price === null || price === undefined) return '--';
        return '$' + parseFloat(price).toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    function formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadPortfolio();

        // Close modals on overlay click
        document.getElementById('transactionModal').addEventListener('click', function(e) {
            if (e.target === this) hideTransactionModal();
        });

        document.getElementById('deleteModal').addEventListener('click', function(e) {
            if (e.target === this) hideDeleteModal();
        });
    });
</script>
{% endblock %}
