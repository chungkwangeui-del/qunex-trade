{% extends "base_layout.html" %}

{% block title %}Admin Dashboard - Qunex Trade{% endblock %}

{% block extra_styles %}
<style>
    /* Header */
    .admin-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 32px;
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: var(--text-tertiary);
        text-decoration: none;
        font-size: var(--text-sm);
        transition: color var(--transition-fast);
    }

    .back-link:hover {
        color: var(--accent-cyan);
    }

    .back-link svg {
        width: 16px;
        height: 16px;
    }

    .admin-title {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .admin-title h1 {
        font-size: var(--text-2xl);
        font-weight: var(--font-bold);
    }

    .admin-badge {
        padding: 4px 10px;
        background: linear-gradient(135deg, var(--accent-purple), var(--danger));
        border-radius: var(--radius-full);
        font-size: var(--text-xs);
        font-weight: var(--font-bold);
        color: #fff;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 16px;
        margin-bottom: 32px;
    }

    .stat-card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        padding: 24px;
        text-align: center;
        transition: all var(--transition-fast);
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple));
        opacity: 0;
        transition: opacity var(--transition-fast);
    }

    .stat-card:hover {
        border-color: var(--border-medium);
        transform: translateY(-2px);
    }

    .stat-card:hover::before {
        opacity: 1;
    }

    .stat-label {
        font-size: var(--text-xs);
        color: var(--text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-weight: var(--font-semibold);
        margin-bottom: 8px;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: var(--font-bold);
        font-family: 'JetBrains Mono', monospace;
        background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    /* Section Card */
    .section-card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        margin-bottom: 24px;
        overflow: hidden;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-subtle);
    }

    .section-title {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: var(--text-lg);
        font-weight: var(--font-bold);
        color: var(--text-primary);
    }

    .section-title-icon {
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, rgba(0, 217, 255, 0.1), rgba(168, 85, 247, 0.1));
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .section-title-icon svg {
        width: 18px;
        height: 18px;
        stroke: var(--accent-cyan);
    }

    .section-actions {
        display: flex;
        gap: 8px;
    }

    .section-body {
        padding: 24px;
    }

    /* Buttons */
    .btn-admin {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        background: transparent;
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        font-size: var(--text-xs);
        font-weight: var(--font-semibold);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .btn-admin:hover {
        border-color: var(--accent-cyan);
        color: var(--accent-cyan);
        background: rgba(0, 217, 255, 0.05);
    }

    .btn-admin svg {
        width: 14px;
        height: 14px;
    }

    .btn-admin.primary {
        background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
        border-color: transparent;
        color: #000;
    }

    .btn-admin.primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 217, 255, 0.3);
    }

    .btn-admin.danger {
        border-color: rgba(239, 68, 68, 0.3);
        color: var(--danger);
    }

    .btn-admin.danger:hover {
        background: rgba(239, 68, 68, 0.1);
        border-color: var(--danger);
    }

    /* Announcement Section */
    .announcement-form {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .announcement-input {
        flex: 1;
        min-width: 300px;
        padding: 12px 16px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-size: var(--text-sm);
        transition: all var(--transition-fast);
    }

    .announcement-input:focus {
        outline: none;
        border-color: var(--accent-cyan);
        box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.1);
    }

    .announcement-select {
        padding: 12px 16px;
        background: var(--bg-primary);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-size: var(--text-sm);
        min-width: 140px;
        cursor: pointer;
    }

    .announcement-preview {
        padding: 16px 20px;
        border-radius: var(--radius-md);
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--border-subtle);
    }

    .preview-label {
        font-size: var(--text-xs);
        color: var(--text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 8px;
    }

    /* API Status Grid */
    .api-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 16px;
    }

    .api-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        transition: all var(--transition-fast);
    }

    .api-card:hover {
        border-color: var(--border-medium);
    }

    .api-info {
        display: flex;
        align-items: center;
        gap: 14px;
    }

    .api-icon {
        width: 40px;
        height: 40px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .api-icon svg {
        width: 20px;
        height: 20px;
        stroke: var(--text-tertiary);
    }

    .api-name {
        font-weight: var(--font-semibold);
        color: var(--text-primary);
        font-size: var(--text-sm);
        margin-bottom: 2px;
    }

    .api-message {
        font-size: var(--text-xs);
        color: var(--text-tertiary);
        font-family: 'JetBrains Mono', monospace;
    }

    .api-env {
        font-size: 10px;
        color: var(--text-tertiary);
        opacity: 0.6;
        margin-top: 2px;
    }

    .api-status {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    .status-dot.connected {
        background: var(--success);
        box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
    }

    .status-dot.disconnected {
        background: var(--danger);
        animation: none;
    }

    .status-text {
        font-size: var(--text-xs);
        font-weight: var(--font-semibold);
        padding: 4px 10px;
        border-radius: var(--radius-full);
    }

    .status-text.connected {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success);
        border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .status-text.disconnected {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
        border: 1px solid rgba(239, 68, 68, 0.2);
    }

    /* Users Table */
    .table-controls {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        align-items: center;
    }

    .search-input {
        flex: 1;
        min-width: 200px;
        max-width: 300px;
        padding: 10px 14px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-size: var(--text-sm);
    }

    .search-input:focus {
        outline: none;
        border-color: var(--accent-cyan);
    }

    .filter-select {
        padding: 10px 14px;
        background: var(--bg-primary);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-size: var(--text-sm);
        min-width: 120px;
        cursor: pointer;
    }

    .table-wrapper {
        overflow-x: auto;
    }

    .users-table {
        width: 100%;
        border-collapse: collapse;
    }

    .users-table th {
        padding: 14px 16px;
        text-align: left;
        font-size: var(--text-xs);
        font-weight: var(--font-semibold);
        color: var(--text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 1px solid var(--border-subtle);
        background: rgba(255, 255, 255, 0.02);
    }

    .users-table td {
        padding: 16px;
        border-bottom: 1px solid var(--border-subtle);
        font-size: var(--text-sm);
    }

    .users-table tbody tr:hover td {
        background: rgba(255, 255, 255, 0.02);
    }

    .users-table .email {
        font-family: 'JetBrains Mono', monospace;
        color: var(--accent-cyan);
        font-size: var(--text-xs);
    }

    .users-table .username {
        font-weight: var(--font-semibold);
        color: var(--text-primary);
    }

    .users-table .date {
        font-family: 'JetBrains Mono', monospace;
        color: var(--text-tertiary);
        font-size: var(--text-xs);
    }

    /* Tier Badges */
    .tier-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: var(--radius-full);
        font-size: 10px;
        font-weight: var(--font-bold);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .tier-badge.free {
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-tertiary);
        border: 1px solid var(--border-subtle);
    }

    .tier-badge.beta {
        background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(251, 191, 36, 0.05));
        color: var(--warning);
        border: 1px solid rgba(251, 191, 36, 0.3);
    }

    .tier-badge.pro {
        background: linear-gradient(135deg, rgba(0, 217, 255, 0.15), rgba(0, 217, 255, 0.05));
        color: var(--accent-cyan);
        border: 1px solid rgba(0, 217, 255, 0.3);
    }

    .tier-badge.premium {
        background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(168, 85, 247, 0.05));
        color: var(--accent-purple);
        border: 1px solid rgba(168, 85, 247, 0.3);
    }

    .tier-badge.developer {
        background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(255, 140, 0, 0.1));
        color: #ffd700;
        border: 1px solid rgba(251, 191, 36, 0.4);
    }

    .tier-badge.active {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success);
        border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .tier-badge.inactive {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning);
        border: 1px solid rgba(245, 158, 11, 0.2);
    }

    .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    .spin {
        animation: spin 1s linear infinite;
    }

    @media (max-width: 1200px) {
        .stats-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .admin-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 16px;
        }

        .section-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="admin-header">
    <div>
        <a href="/account" class="back-link">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Back to Account
        </a>
        <div class="admin-title" style="margin-top: 12px;">
            <h1>Admin Dashboard</h1>
            <span class="admin-badge">Admin</span>
        </div>
    </div>
</div>

<!-- Statistics -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Total Users</div>
        <div class="stat-value">{{ stats.total_users }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Free</div>
        <div class="stat-value">{{ stats.free_users }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Pro</div>
        <div class="stat-value">{{ stats.pro_users }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Premium</div>
        <div class="stat-value">{{ stats.premium_users }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Developer</div>
        <div class="stat-value">{{ stats.developer_users }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Revenue</div>
        <div class="stat-value" style="font-size: 1.5rem;">${{ "%.0f"|format(stats.monthly_revenue) }}</div>
    </div>
</div>

<!-- Announcement Section -->
<div class="section-card">
    <div class="section-header">
        <div class="section-title">
            <div class="section-title-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 17H2a3 3 0 0 0 3-3V9a7 7 0 0 1 14 0v5a3 3 0 0 0 3 3z"/>
                    <path d="M12 22v-5"/>
                </svg>
            </div>
            Site Announcement
        </div>
    </div>
    <div class="section-body">
        <div class="announcement-form">
            <input type="text" id="announcement-message" class="announcement-input" placeholder="Enter announcement message...">
            <select id="announcement-type" class="announcement-select">
                <option value="info">Info (Blue)</option>
                <option value="success">Success (Green)</option>
                <option value="warning">Warning (Yellow)</option>
                <option value="error">Error (Red)</option>
            </select>
            <button onclick="createAnnouncement()" class="btn-admin primary">Publish</button>
        </div>

        <div class="preview-label">Current Announcement</div>
        <div id="announcement-preview" class="announcement-preview">
            <span style="color: var(--text-tertiary);">No active announcement</span>
        </div>
    </div>
</div>

<!-- API Status Section -->
<div class="section-card">
    <div class="section-header">
        <div class="section-title">
            <div class="section-title-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                </svg>
            </div>
            API Status
        </div>
        <div class="section-actions">
            <button onclick="loadApiStatus()" class="btn-admin" id="refresh-status-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 4v6h-6M1 20v-6h6"/>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                </svg>
                Refresh
            </button>
            <button id="copy-status-btn" onclick="copyApiStatus()" class="btn-admin">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                </svg>
                Copy
            </button>
        </div>
    </div>
    <div class="section-body">
        <div class="api-grid" id="api-status-grid">
            <div class="api-card">
                <div class="api-info">
                    <div class="api-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 6v6l4 2"/>
                        </svg>
                    </div>
                    <div>
                        <div class="api-name">Loading...</div>
                        <div class="api-message">Checking status</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ticker Data Test Section -->
<div class="section-card">
    <div class="section-header">
        <div class="section-title">
            <div class="section-title-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                </svg>
            </div>
            Test Ticker Data (Debug)
        </div>
    </div>
    <div class="section-body">
        <p style="color: var(--text-tertiary); font-size: var(--text-sm); margin-bottom: 16px;">
            Test which APIs return data for any stock ticker. Enter a ticker to see what each API source provides.
        </p>
        <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
            <input type="text" id="test-ticker-input" class="announcement-input" placeholder="Enter ticker (e.g., AAPL, BMNU)" style="max-width: 250px; text-transform: uppercase;">
            <button onclick="testTickerData()" class="btn-admin primary" id="test-ticker-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                    <circle cx="11" cy="11" r="8"/>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                </svg>
                Test Ticker
            </button>
            <span id="test-ticker-status" style="font-size: var(--text-xs); color: var(--text-tertiary);"></span>
        </div>
        <div id="ticker-test-results" style="display: none;">
            <!-- Results will be populated by JS -->
        </div>
    </div>
</div>

<!-- User Management Section -->
<div class="section-card">
    <div class="section-header">
        <div class="section-title">
            <div class="section-title-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
            </div>
            Users (<span id="user-count">{{ users|length }}</span>)
        </div>
        <div class="section-actions">
            <button onclick="exportUsersCSV()" class="btn-admin">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Export CSV
            </button>
        </div>
    </div>
    <div class="section-body">
        <div class="table-controls">
            <input type="text" id="user-search" class="search-input" placeholder="Search email or username..." oninput="filterUsers()">
            <select id="tier-filter" class="filter-select" onchange="filterUsers()">
                <option value="">All Tiers</option>
                <option value="free">Free</option>
                <option value="beta">Beta</option>
                <option value="pro">Pro</option>
                <option value="premium">Premium</option>
                <option value="developer">Developer</option>
            </select>
        </div>

        <div class="table-wrapper">
            <table class="users-table" id="users-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Tier</th>
                        <th>Status</th>
                        <th>Joined</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>{{ user.id }}</td>
                        <td class="username">{{ user.username }}</td>
                        <td class="email">{{ user.email }}</td>
                        <td><span class="tier-badge {{ user.subscription_tier }}">{{ user.subscription_tier }}</span></td>
                        <td><span class="tier-badge {{ user.subscription_status }}">{{ user.subscription_status }}</span></td>
                        <td class="date">{{ user.created_at.strftime('%Y-%m-%d') if user.created_at else 'N/A' }}</td>
                        <td>
                            <div class="action-buttons">
                                {% if user.subscription_tier == 'free' %}
                                <button class="btn-admin" onclick="upgradeUser('{{ user.email }}', 'beta')">Beta</button>
                                <button class="btn-admin" onclick="upgradeUser('{{ user.email }}', 'pro')">Pro</button>
                                {% elif user.subscription_tier == 'beta' %}
                                <button class="btn-admin" onclick="upgradeUser('{{ user.email }}', 'pro')">Pro</button>
                                <button class="btn-admin danger" onclick="upgradeUser('{{ user.email }}', 'free')">Free</button>
                                {% elif user.subscription_tier == 'pro' %}
                                <button class="btn-admin" onclick="upgradeUser('{{ user.email }}', 'premium')">Premium</button>
                                <button class="btn-admin danger" onclick="upgradeUser('{{ user.email }}', 'free')">Free</button>
                                {% elif user.subscription_tier == 'premium' %}
                                <button class="btn-admin" onclick="upgradeUser('{{ user.email }}', 'developer')">Dev</button>
                                <button class="btn-admin danger" onclick="upgradeUser('{{ user.email }}', 'free')">Free</button>
                                {% else %}
                                <button class="btn-admin danger" onclick="upgradeUser('{{ user.email }}', 'free')">Free</button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const bannerColors = {
        info: { bg: 'rgba(0, 217, 255, 0.1)', border: 'rgba(0, 217, 255, 0.3)', text: '#00d9ff' },
        success: { bg: 'rgba(34, 197, 94, 0.1)', border: 'rgba(34, 197, 94, 0.3)', text: '#22c55e' },
        warning: { bg: 'rgba(245, 158, 11, 0.1)', border: 'rgba(245, 158, 11, 0.3)', text: '#f59e0b' },
        error: { bg: 'rgba(239, 68, 68, 0.1)', border: 'rgba(239, 68, 68, 0.3)', text: '#ef4444' }
    };

    async function loadAnnouncements() {
        try {
            const response = await fetch('/auth/admin/announcement');
            const data = await response.json();

            if (data.announcements && data.announcements.length > 0) {
                const active = data.announcements.find(a => a.is_active);
                const preview = document.getElementById('announcement-preview');

                if (active) {
                    const colors = bannerColors[active.banner_type] || bannerColors.info;
                    preview.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: ${colors.text};">${active.message}</span>
                            <button onclick="toggleAnnouncement(${active.id})" class="btn-admin danger" style="margin-left: 12px;">Deactivate</button>
                        </div>
                    `;
                    preview.style.background = colors.bg;
                    preview.style.borderColor = colors.border;
                } else {
                    preview.innerHTML = '<span style="color: var(--text-tertiary);">No active announcement</span>';
                    preview.style.background = 'rgba(255,255,255,0.02)';
                    preview.style.borderColor = 'var(--border-subtle)';
                }
            }
        } catch (error) {
            console.error('Error loading announcements:', error);
        }
    }

    async function createAnnouncement() {
        const message = document.getElementById('announcement-message').value.trim();
        const bannerType = document.getElementById('announcement-type').value;

        if (!message) {
            alert('Please enter a message');
            return;
        }

        try {
            const response = await fetch('/auth/admin/announcement', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message, banner_type: bannerType })
            });

            const data = await response.json();

            if (data.success) {
                document.getElementById('announcement-message').value = '';
                loadAnnouncements();
                alert('Announcement published!');
            } else {
                alert('Error: ' + (data.error || 'Failed to create'));
            }
        } catch (error) {
            alert('Error creating announcement');
        }
    }

    async function toggleAnnouncement(id) {
        try {
            const response = await fetch(`/auth/admin/announcement/${id}/toggle`, { method: 'POST' });
            const data = await response.json();
            if (data.success) loadAnnouncements();
        } catch (error) {
            console.error('Error:', error);
        }
    }

    loadAnnouncements();

    const serviceIcons = {
        polygon: '<path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/>',
        twelvedata: '<path d="M3 3v18h18"/><path d="M7 14l3-3 3 3 5-6"/><circle cx="17" cy="8" r="2"/>',
        binance: '<circle cx="12" cy="12" r="10"/><path d="M12 6v2M12 16v2M6 12h2M16 12h2"/>',
        gemini: '<circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2"/>',
        finnhub: '<path d="M3 3v18h18"/><path d="M7 16l4-4 4 4 5-6"/>',
        database: '<ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>'
    };

    async function loadApiStatus() {
        const container = document.getElementById('api-status-grid');
        const refreshBtn = document.getElementById('refresh-status-btn');
        
        // Show loading state
        refreshBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spin" width="14" height="14"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg> Checking...';

        try {
            const response = await fetch('/api/status');
            const status = await response.json();

            container.innerHTML = Object.entries(status).map(([key, data]) => {
                const icon = serviceIcons[key] || serviceIcons.database;
                const statusClass = data.connected ? 'connected' : 'disconnected';
                const statusText = data.connected ? 'OK' : 'Error';
                
                // Show data sample if available (for APIs that return real data)
                let dataSample = '';
                if (data.data_sample) {
                    dataSample = `<div style="font-size: 10px; color: var(--success); margin-top: 2px;">✓ Real data verified</div>`;
                }

                return `
                    <div class="api-card">
                        <div class="api-info">
                            <div class="api-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">${icon}</svg>
                            </div>
                            <div>
                                <div class="api-name">${data.label || key}</div>
                                <div class="api-message">${data.message}</div>
                                ${dataSample}
                                ${data.env_var ? `<div class="api-env">ENV: ${data.env_var}</div>` : ''}
                            </div>
                        </div>
                        <div class="api-status">
                            <span class="status-dot ${statusClass}"></span>
                            <span class="status-text ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                `;
            }).join('');

            window.apiStatusData = status;
        } catch (error) {
            container.innerHTML = `<div class="api-card"><div class="api-info"><div class="api-name">Error loading status: ${error.message}</div></div></div>`;
        }
        
        // Reset button
        refreshBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg> Refresh';
    }
    
    async function testTickerData() {
        const ticker = document.getElementById('test-ticker-input').value.trim().toUpperCase();
        const statusEl = document.getElementById('test-ticker-status');
        const resultsEl = document.getElementById('ticker-test-results');
        const btn = document.getElementById('test-ticker-btn');
        
        if (!ticker) {
            statusEl.textContent = 'Please enter a ticker symbol';
            statusEl.style.color = 'var(--danger)';
            return;
        }
        
        // Show loading state
        btn.disabled = true;
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spin" width="14" height="14"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg> Testing...';
        statusEl.textContent = `Testing ${ticker}...`;
        statusEl.style.color = 'var(--text-tertiary)';
        
        try {
            const response = await fetch(`/api/status/test-ticker?ticker=${encodeURIComponent(ticker)}`);
            const data = await response.json();
            
            resultsEl.style.display = 'block';
            
            // Build results HTML
            let html = `
                <div style="background: rgba(0,0,0,0.3); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div>
                            <h3 style="font-size: var(--text-lg); font-weight: var(--font-bold); margin: 0;">${data.ticker}</h3>
                            <span style="font-size: var(--text-xs); color: var(--text-tertiary);">Tested at ${new Date(data.tested_at).toLocaleString()}</span>
                        </div>
                        <div style="text-align: right;">
                            ${data.summary.best_source ? 
                                `<div style="font-size: var(--text-sm); color: var(--success);">Best price: $${data.summary.best_price.toFixed(4)}</div>
                                 <div style="font-size: var(--text-xs); color: var(--text-tertiary);">from ${data.summary.best_source}</div>` :
                                `<div style="font-size: var(--text-sm); color: var(--danger);">No data found</div>`
                            }
                        </div>
                    </div>
            `;
            
            // Show each source
            const sourceOrder = ['polygon', 'twelvedata', 'finnhub', 'binance'];
            sourceOrder.forEach(sourceName => {
                const source = data.sources[sourceName];
                if (!source) return;
                
                const available = source.available;
                const statusColor = available ? 'var(--success)' : 'var(--danger)';
                const statusIcon = available ? '✓' : '✗';
                
                html += `
                    <div style="background: rgba(255,255,255,0.02); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); padding: 16px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: var(--font-semibold); text-transform: uppercase; font-size: var(--text-sm);">${sourceName}</span>
                            <span style="color: ${statusColor}; font-size: var(--text-xs); font-weight: var(--font-bold);">${statusIcon} ${available ? 'Data Available' : 'No Data'}</span>
                        </div>
                `;
                
                if (available) {
                    html += `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; font-size: var(--text-xs);">
                            <div>
                                <div style="color: var(--text-tertiary);">Price</div>
                                <div style="font-family: 'JetBrains Mono', monospace; color: var(--accent-cyan);">$${(source.price || 0).toFixed(4)}</div>
                            </div>
                            ${source.change_percent !== undefined ? `
                            <div>
                                <div style="color: var(--text-tertiary);">Change</div>
                                <div style="font-family: 'JetBrains Mono', monospace; color: ${source.change_percent >= 0 ? 'var(--success)' : 'var(--danger)'};">${source.change_percent >= 0 ? '+' : ''}${(source.change_percent || 0).toFixed(2)}%</div>
                            </div>` : ''}
                            ${source.market_cap ? `
                            <div>
                                <div style="color: var(--text-tertiary);">Market Cap</div>
                                <div style="font-family: 'JetBrains Mono', monospace;">$${(source.market_cap / 1e9).toFixed(2)}B</div>
                            </div>` : ''}
                            ${source.volume ? `
                            <div>
                                <div style="color: var(--text-tertiary);">Volume</div>
                                <div style="font-family: 'JetBrains Mono', monospace;">${(source.volume / 1e6).toFixed(2)}M</div>
                            </div>` : ''}
                            ${source.source_type ? `
                            <div>
                                <div style="color: var(--text-tertiary);">Source Type</div>
                                <div style="font-family: 'JetBrains Mono', monospace;">${source.source_type}</div>
                            </div>` : ''}
                            ${source.high_24h ? `
                            <div>
                                <div style="color: var(--text-tertiary);">24h High</div>
                                <div style="font-family: 'JetBrains Mono', monospace;">$${source.high_24h.toFixed(4)}</div>
                            </div>` : ''}
                            ${source.low_24h ? `
                            <div>
                                <div style="color: var(--text-tertiary);">24h Low</div>
                                <div style="font-family: 'JetBrains Mono', monospace;">$${source.low_24h.toFixed(4)}</div>
                            </div>` : ''}
                            ${source.trades_24h ? `
                            <div>
                                <div style="color: var(--text-tertiary);">24h Trades</div>
                                <div style="font-family: 'JetBrains Mono', monospace;">${source.trades_24h.toLocaleString()}</div>
                            </div>` : ''}
                            ${source.source ? `
                            <div>
                                <div style="color: var(--text-tertiary);">Exchange</div>
                                <div style="font-family: 'JetBrains Mono', monospace;">${source.source}</div>
                            </div>` : ''}
                        </div>
                    `;
                } else {
                    html += `<div style="font-size: var(--text-xs); color: var(--danger);">${source.error || 'Unknown error'}</div>`;
                }
                
                html += `</div>`;
            });
            
            html += `
                    <div style="font-size: var(--text-xs); color: var(--text-tertiary); margin-top: 12px;">
                        <strong>Summary:</strong> 
                        ${data.summary.sources_with_data.length} sources have data 
                        (${data.summary.sources_with_data.join(', ') || 'none'}), 
                        ${data.summary.sources_failed.length} failed 
                        (${data.summary.sources_failed.join(', ') || 'none'})
                    </div>
                </div>
            `;
            
            resultsEl.innerHTML = html;
            statusEl.textContent = `✓ Test complete for ${ticker}`;
            statusEl.style.color = 'var(--success)';
            
        } catch (error) {
            statusEl.textContent = `Error: ${error.message}`;
            statusEl.style.color = 'var(--danger)';
            resultsEl.innerHTML = `<div style="color: var(--danger);">Failed to test ticker: ${error.message}</div>`;
            resultsEl.style.display = 'block';
        }
        
        // Reset button
        btn.disabled = false;
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Test Ticker';
    }
    
    // Allow Enter key to trigger test
    document.addEventListener('DOMContentLoaded', function() {
        const input = document.getElementById('test-ticker-input');
        if (input) {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    testTickerData();
                }
            });
        }
    });

    function copyApiStatus() {
        if (!window.apiStatusData) return;

        const lines = Object.entries(window.apiStatusData).map(([key, data]) => {
            return `[${data.connected ? 'OK' : 'FAIL'}] ${data.label}: ${data.message}`;
        });

        navigator.clipboard.writeText(`API Status:\n${lines.join('\n')}`).then(() => {
            const btn = document.getElementById('copy-status-btn');
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M20 6L9 17l-5-5"/></svg> Copied';
            setTimeout(() => btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg> Copy', 2000);
        });
    }

    loadApiStatus();

    function filterUsers() {
        const search = document.getElementById('user-search').value.toLowerCase();
        const tier = document.getElementById('tier-filter').value.toLowerCase();
        const rows = document.querySelectorAll('#users-table tbody tr');
        let count = 0;

        rows.forEach(row => {
            const username = row.querySelector('.username')?.textContent.toLowerCase() || '';
            const email = row.querySelector('.email')?.textContent.toLowerCase() || '';
            const tierBadge = row.querySelector('.tier-badge')?.textContent.toLowerCase() || '';

            const matchSearch = !search || username.includes(search) || email.includes(search);
            const matchTier = !tier || tierBadge.includes(tier);

            if (matchSearch && matchTier) {
                row.style.display = '';
                count++;
            } else {
                row.style.display = 'none';
            }
        });

        document.getElementById('user-count').textContent = count;
    }

    function exportUsersCSV() {
        const rows = Array.from(document.querySelectorAll('#users-table tbody tr')).filter(r => r.style.display !== 'none');
        if (!rows.length) return alert('No users to export');

        const csv = [['ID', 'Username', 'Email', 'Tier', 'Status', 'Joined'].join(',')];
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            csv.push([
                cells[0]?.textContent.trim(),
                cells[1]?.textContent.trim(),
                cells[2]?.textContent.trim(),
                cells[3]?.textContent.trim(),
                cells[4]?.textContent.trim(),
                cells[5]?.textContent.trim()
            ].map(c => `"${c}"`).join(','));
        });

        const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `users_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
    }

    function upgradeUser(email, tier) {
        if (!confirm(`Change ${email} to ${tier.toUpperCase()}?`)) return;

        const password = prompt('Admin password:');
        if (!password) return;

        fetch(`/auth/admin/upgrade-user/${encodeURIComponent(email)}/${tier}?password=${encodeURIComponent(password)}`)
            .then(r => r.json())
            .then(data => {
                if (data.error) alert('Error: ' + data.error);
                else if (data.success) {
                    alert(`${data.username}: ${data.old_tier} -> ${data.new_tier}`);
                    location.reload();
                }
            });
    }
</script>
{% endblock %}
