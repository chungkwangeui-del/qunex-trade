{% extends "authenticated_base.html" %}

{% block title %}Trade Journal - Qunex Trade{% endblock %}
{% block page_title %}Trade Journal{% endblock %}

{% block extra_styles %}
<style>
    .journal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
    }
    
    .stat-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 20px;
    }
    
    .stat-label {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.5);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 8px;
    }
    
    .stat-value {
        font-size: 28px;
        font-weight: 700;
        font-family: 'JetBrains Mono', monospace;
    }
    
    .stat-value.positive { color: #00d9ff; }
    .stat-value.negative { color: #ff4757; }
    
    .btn-primary {
        background: linear-gradient(135deg, #00d9ff, #a855f7);
        color: #000;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0, 217, 255, 0.3);
    }
    
    .journal-table {
        width: 100%;
        border-collapse: collapse;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 12px;
        overflow: hidden;
    }
    
    .journal-table th,
    .journal-table td {
        padding: 16px;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .journal-table th {
        background: rgba(255, 255, 255, 0.05);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: rgba(255, 255, 255, 0.6);
    }
    
    .journal-table tr:hover {
        background: rgba(255, 255, 255, 0.03);
    }
    
    .ticker-badge {
        background: rgba(0, 217, 255, 0.1);
        color: #00d9ff;
        padding: 4px 8px;
        border-radius: 4px;
        font-family: 'JetBrains Mono', monospace;
        font-weight: 600;
    }
    
    .trade-type {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .trade-type.long {
        background: rgba(0, 217, 255, 0.1);
        color: #00d9ff;
    }
    
    .trade-type.short {
        background: rgba(168, 85, 247, 0.1);
        color: #a855f7;
    }
    
    .outcome-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .outcome-badge.win {
        background: rgba(46, 213, 115, 0.1);
        color: #2ed573;
    }
    
    .outcome-badge.loss {
        background: rgba(255, 71, 87, 0.1);
        color: #ff4757;
    }
    
    .outcome-badge.breakeven {
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.7);
    }
    
    .outcome-badge.open {
        background: rgba(255, 193, 7, 0.1);
        color: #ffc107;
    }
    
    /* Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    
    .modal.show {
        display: flex;
    }
    
    .modal-content {
        background: #0a0a0a;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 32px;
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }
    
    .modal-title {
        font-size: 24px;
        font-weight: 700;
    }
    
    .modal-close {
        background: none;
        border: none;
        color: #fff;
        font-size: 24px;
        cursor: pointer;
        opacity: 0.5;
    }
    
    .modal-close:hover {
        opacity: 1;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 8px;
        color: rgba(255, 255, 255, 0.8);
    }
    
    .form-input,
    .form-select,
    .form-textarea {
        width: 100%;
        padding: 12px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        color: #fff;
        font-size: 14px;
    }
    
    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
        outline: none;
        border-color: #00d9ff;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }
    
    .emotion-select {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    
    .emotion-option {
        padding: 8px 16px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .emotion-option:hover,
    .emotion-option.selected {
        background: rgba(0, 217, 255, 0.1);
        border-color: #00d9ff;
        color: #00d9ff;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: rgba(255, 255, 255, 0.5);
    }
    
    .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
    }
    
    .filters-bar {
        display: flex;
        gap: 16px;
        margin-bottom: 24px;
        flex-wrap: wrap;
    }
    
    .filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .filter-select {
        padding: 8px 16px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        color: #fff;
        font-size: 14px;
    }
</style>
{% endblock %}

{% block content %}
<div class="journal-header">
    <h2>Track Your Trades, Improve Your Performance</h2>
    <button class="btn-primary" onclick="openNewTradeModal()">+ New Trade Entry</button>
</div>

<!-- Stats Grid -->
<div class="stats-grid" id="statsGrid">
    <div class="stat-card">
        <div class="stat-label">Total Trades</div>
        <div class="stat-value" id="totalTrades">-</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Win Rate</div>
        <div class="stat-value positive" id="winRate">-</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Total P&L</div>
        <div class="stat-value" id="totalPnl">-</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Profit Factor</div>
        <div class="stat-value" id="profitFactor">-</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Avg Win</div>
        <div class="stat-value positive" id="avgWin">-</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Avg Loss</div>
        <div class="stat-value negative" id="avgLoss">-</div>
    </div>
</div>

<!-- Filters -->
<div class="filters-bar">
    <div class="filter-group">
        <label>Outcome:</label>
        <select class="filter-select" id="outcomeFilter" onchange="loadEntries()">
            <option value="">All</option>
            <option value="win">Wins</option>
            <option value="loss">Losses</option>
            <option value="breakeven">Breakeven</option>
        </select>
    </div>
    <div class="filter-group">
        <label>Strategy:</label>
        <select class="filter-select" id="strategyFilter" onchange="loadEntries()">
            <option value="">All</option>
            <option value="scalp">Scalping</option>
            <option value="swing">Swing</option>
            <option value="breakout">Breakout</option>
            <option value="reversal">Reversal</option>
        </select>
    </div>
</div>

<!-- Journal Table -->
<div id="journalContent">
    <table class="journal-table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Ticker</th>
                <th>Type</th>
                <th>Entry</th>
                <th>Exit</th>
                <th>P&L</th>
                <th>Outcome</th>
                <th>Strategy</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="journalBody">
            <tr>
                <td colspan="9" class="empty-state">
                    <div class="empty-state-icon">üìì</div>
                    <p>No trades recorded yet. Start logging your trades!</p>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<!-- New Trade Modal -->
<div class="modal" id="newTradeModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">üìù New Trade Entry</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        
        <form id="newTradeForm" onsubmit="submitTrade(event)">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Ticker</label>
                    <input type="text" class="form-input" name="ticker" placeholder="AAPL" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Trade Type</label>
                    <select class="form-select" name="trade_type" required>
                        <option value="long">Long</option>
                        <option value="short">Short</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Entry Price</label>
                    <input type="number" step="0.01" class="form-input" name="entry_price" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Shares</label>
                    <input type="number" step="0.01" class="form-input" name="shares" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Entry Date</label>
                    <input type="datetime-local" class="form-input" name="entry_date" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Exit Price (optional)</label>
                    <input type="number" step="0.01" class="form-input" name="exit_price">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Stop Loss</label>
                    <input type="number" step="0.01" class="form-input" name="stop_loss">
                </div>
                <div class="form-group">
                    <label class="form-label">Take Profit</label>
                    <input type="number" step="0.01" class="form-input" name="take_profit">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Strategy</label>
                    <select class="form-select" name="strategy">
                        <option value="">Select...</option>
                        <option value="scalp">Scalping</option>
                        <option value="swing">Swing</option>
                        <option value="breakout">Breakout</option>
                        <option value="reversal">Reversal</option>
                        <option value="momentum">Momentum</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Timeframe</label>
                    <select class="form-select" name="timeframe">
                        <option value="">Select...</option>
                        <option value="1m">1 Minute</option>
                        <option value="5m">5 Minutes</option>
                        <option value="15m">15 Minutes</option>
                        <option value="1h">1 Hour</option>
                        <option value="4h">4 Hours</option>
                        <option value="D">Daily</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Emotion Before Trade</label>
                <div class="emotion-select" data-field="emotion_before">
                    <span class="emotion-option" data-value="confident">üòé Confident</span>
                    <span class="emotion-option" data-value="nervous">üò∞ Nervous</span>
                    <span class="emotion-option" data-value="fomo">ü§ë FOMO</span>
                    <span class="emotion-option" data-value="revenge">üò§ Revenge</span>
                    <span class="emotion-option" data-value="calm">üòå Calm</span>
                </div>
                <input type="hidden" name="emotion_before">
            </div>
            
            <div class="form-group">
                <label class="form-label">Entry Reason</label>
                <textarea class="form-textarea" name="entry_reason" rows="3" placeholder="Why did you enter this trade?"></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Notes</label>
                <textarea class="form-textarea" name="notes" rows="3" placeholder="Additional notes..."></textarea>
            </div>
            
            <button type="submit" class="btn-primary" style="width: 100%;">Save Trade</button>
        </form>
    </div>
</div>

<script>
    // Load entries on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadStats();
        loadEntries();
    });
    
    async function loadStats() {
        try {
            const response = await fetch('/api/journal/stats');
            const data = await response.json();
            
            document.getElementById('totalTrades').textContent = data.total_trades || 0;
            document.getElementById('winRate').textContent = (data.win_rate || 0) + '%';
            
            const totalPnl = data.total_pnl || 0;
            const pnlEl = document.getElementById('totalPnl');
            pnlEl.textContent = '$' + totalPnl.toLocaleString();
            pnlEl.className = 'stat-value ' + (totalPnl >= 0 ? 'positive' : 'negative');
            
            document.getElementById('profitFactor').textContent = data.profit_factor || '-';
            document.getElementById('avgWin').textContent = '$' + (data.avg_win || 0).toLocaleString();
            document.getElementById('avgLoss').textContent = '$' + Math.abs(data.avg_loss || 0).toLocaleString();
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }
    
    async function loadEntries() {
        const outcome = document.getElementById('outcomeFilter').value;
        const strategy = document.getElementById('strategyFilter').value;
        
        let url = '/api/journal/entries?limit=50';
        if (outcome) url += `&outcome=${outcome}`;
        if (strategy) url += `&strategy=${strategy}`;
        
        try {
            const response = await fetch(url);
            const data = await response.json();
            
            renderEntries(data.entries || []);
        } catch (error) {
            console.error('Error loading entries:', error);
        }
    }
    
    function renderEntries(entries) {
        const tbody = document.getElementById('journalBody');
        
        if (entries.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="empty-state">
                        <div class="empty-state-icon">üìì</div>
                        <p>No trades recorded yet. Start logging your trades!</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = entries.map(entry => `
            <tr>
                <td>${new Date(entry.entry_date).toLocaleDateString()}</td>
                <td><span class="ticker-badge">${entry.ticker}</span></td>
                <td><span class="trade-type ${entry.trade_type}">${entry.trade_type}</span></td>
                <td>$${parseFloat(entry.entry_price).toFixed(2)}</td>
                <td>${entry.exit_price ? '$' + parseFloat(entry.exit_price).toFixed(2) : '-'}</td>
                <td style="color: ${entry.pnl >= 0 ? '#2ed573' : '#ff4757'}">
                    ${entry.pnl ? '$' + parseFloat(entry.pnl).toFixed(2) : '-'}
                </td>
                <td><span class="outcome-badge ${entry.outcome || 'open'}">${entry.outcome || 'Open'}</span></td>
                <td>${entry.strategy || '-'}</td>
                <td>
                    <button onclick="viewEntry(${entry.id})" style="background: none; border: none; color: #00d9ff; cursor: pointer;">View</button>
                </td>
            </tr>
        `).join('');
    }
    
    function openNewTradeModal() {
        document.getElementById('newTradeModal').classList.add('show');
        
        // Set default date to now
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.querySelector('input[name="entry_date"]').value = now.toISOString().slice(0, 16);
    }
    
    function closeModal() {
        document.getElementById('newTradeModal').classList.remove('show');
    }
    
    // Emotion selection
    document.querySelectorAll('.emotion-option').forEach(option => {
        option.addEventListener('click', function() {
            const parent = this.parentElement;
            parent.querySelectorAll('.emotion-option').forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');
            
            const field = parent.dataset.field;
            document.querySelector(`input[name="${field}"]`).value = this.dataset.value;
        });
    });
    
    async function submitTrade(event) {
        event.preventDefault();
        
        const form = event.target;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        // Convert entry_date to ISO format
        data.entry_date = new Date(data.entry_date).toISOString();
        
        // Convert numbers
        data.entry_price = parseFloat(data.entry_price);
        data.shares = parseFloat(data.shares);
        if (data.exit_price) data.exit_price = parseFloat(data.exit_price);
        if (data.stop_loss) data.stop_loss = parseFloat(data.stop_loss);
        if (data.take_profit) data.take_profit = parseFloat(data.take_profit);
        
        try {
            const response = await fetch('/api/journal/entries', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                closeModal();
                loadStats();
                loadEntries();
                form.reset();
            } else {
                const error = await response.json();
                alert(error.error || 'Failed to save trade');
            }
        } catch (error) {
            console.error('Error saving trade:', error);
            alert('Failed to save trade');
        }
    }
    
    function viewEntry(id) {
        // TODO: Implement view/edit modal
        alert('View trade #' + id);
    }
</script>
{% endblock %}

