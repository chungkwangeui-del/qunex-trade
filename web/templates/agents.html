{% extends "base_layout.html" %}

{% block title %}Agents Dashboard - Qunex Trade{% endblock %}

{% block extra_styles %}
<style>
    /* Header */
    .agents-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 32px;
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: var(--text-tertiary);
        text-decoration: none;
        font-size: var(--text-sm);
        transition: color var(--transition-fast);
    }

    .back-link:hover {
        color: var(--accent-cyan);
    }

    .back-link svg {
        width: 16px;
        height: 16px;
    }

    .agents-title {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .agents-title h1 {
        font-size: var(--text-2xl);
        font-weight: var(--font-bold);
    }

    .agents-badge {
        padding: 4px 10px;
        background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
        border-radius: var(--radius-full);
        font-size: var(--text-xs);
        font-weight: var(--font-bold);
        color: #000;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* Overall Status Banner */
    .overall-status {
        padding: 20px 24px;
        border-radius: var(--radius-xl);
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 20px;
    }

    .overall-status.healthy {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.02));
        border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .overall-status.warning {
        background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(251, 191, 36, 0.02));
        border: 1px solid rgba(251, 191, 36, 0.3);
    }

    .overall-status.error, .overall-status.critical {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.02));
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .status-main {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .status-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .status-icon.healthy { background: rgba(34, 197, 94, 0.2); }
    .status-icon.warning { background: rgba(251, 191, 36, 0.2); }
    .status-icon.error, .status-icon.critical { background: rgba(239, 68, 68, 0.2); }

    .status-icon svg {
        width: 24px;
        height: 24px;
    }

    .status-icon.healthy svg { stroke: var(--success); }
    .status-icon.warning svg { stroke: var(--warning); }
    .status-icon.error svg, .status-icon.critical svg { stroke: var(--danger); }

    .status-text h2 {
        font-size: var(--text-lg);
        font-weight: var(--font-bold);
        margin-bottom: 4px;
    }

    .status-text p {
        font-size: var(--text-sm);
        color: var(--text-secondary);
    }

    .status-stats {
        display: flex;
        gap: 24px;
    }

    .status-stat {
        text-align: center;
    }

    .status-stat .value {
        font-size: var(--text-2xl);
        font-weight: var(--font-bold);
        font-family: 'JetBrains Mono', monospace;
    }

    .status-stat .label {
        font-size: var(--text-xs);
        color: var(--text-tertiary);
        text-transform: uppercase;
    }

    /* Quick Actions */
    .quick-actions {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
        flex-wrap: wrap;
    }

    .btn-agent {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 20px;
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        color: var(--text-primary);
        font-size: var(--text-sm);
        font-weight: var(--font-semibold);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .btn-agent:hover {
        border-color: var(--accent-cyan);
        background: rgba(0, 217, 255, 0.05);
    }

    .btn-agent svg {
        width: 18px;
        height: 18px;
    }

    .btn-agent.primary {
        background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
        border-color: transparent;
        color: #000;
    }

    .btn-agent.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 217, 255, 0.3);
    }

    .btn-agent.danger {
        border-color: rgba(239, 68, 68, 0.3);
    }

    .btn-agent.danger:hover {
        background: rgba(239, 68, 68, 0.1);
        border-color: var(--danger);
    }

    /* Category Tabs */
    .category-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        flex-wrap: wrap;
        border-bottom: 1px solid var(--border-subtle);
        padding-bottom: 16px;
    }

    .category-tab {
        padding: 10px 20px;
        background: transparent;
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        color: var(--text-secondary);
        font-size: var(--text-sm);
        font-weight: var(--font-semibold);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .category-tab:hover {
        border-color: var(--border-medium);
        color: var(--text-primary);
    }

    .category-tab.active {
        background: linear-gradient(135deg, rgba(0, 217, 255, 0.1), rgba(168, 85, 247, 0.1));
        border-color: var(--accent-cyan);
        color: var(--accent-cyan);
    }

    /* Agent Cards Grid */
    .agents-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
    }

    .agent-card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        overflow: hidden;
        transition: all var(--transition-fast);
    }

    .agent-card:hover {
        border-color: var(--border-medium);
        transform: translateY(-2px);
    }

    .agent-card-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-subtle);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .agent-info {
        display: flex;
        align-items: center;
        gap: 14px;
    }

    .agent-icon {
        width: 44px;
        height: 44px;
        background: linear-gradient(135deg, rgba(0, 217, 255, 0.1), rgba(168, 85, 247, 0.1));
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .agent-icon svg {
        width: 22px;
        height: 22px;
        stroke: var(--accent-cyan);
    }

    .agent-name {
        font-weight: var(--font-bold);
        font-size: var(--text-base);
        margin-bottom: 4px;
    }

    .agent-category {
        font-size: var(--text-xs);
        color: var(--text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .agent-status-badge {
        padding: 6px 12px;
        border-radius: var(--radius-full);
        font-size: var(--text-xs);
        font-weight: var(--font-bold);
        text-transform: uppercase;
    }

    .agent-status-badge.healthy {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success);
        border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .agent-status-badge.warning {
        background: rgba(251, 191, 36, 0.1);
        color: var(--warning);
        border: 1px solid rgba(251, 191, 36, 0.2);
    }

    .agent-status-badge.error, .agent-status-badge.critical {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
        border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .agent-status-badge.unknown, .agent-status-badge.running {
        background: rgba(0, 217, 255, 0.1);
        color: var(--accent-cyan);
        border: 1px solid rgba(0, 217, 255, 0.2);
    }

    .agent-card-body {
        padding: 20px;
    }

    .agent-description {
        font-size: var(--text-sm);
        color: var(--text-secondary);
        margin-bottom: 16px;
        line-height: 1.5;
    }

    .agent-tasks {
        background: rgba(0, 0, 0, 0.2);
        border-radius: var(--radius-md);
        padding: 12px;
    }

    .tasks-header {
        font-size: var(--text-xs);
        color: var(--text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 10px;
    }

    .task-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid var(--border-subtle);
    }

    .task-item:last-child {
        border-bottom: none;
    }

    .task-name {
        font-size: var(--text-xs);
        color: var(--text-primary);
    }

    .task-status {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .task-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
    }

    .task-dot.healthy { background: var(--success); }
    .task-dot.warning { background: var(--warning); }
    .task-dot.error { background: var(--danger); }
    .task-dot.unknown { background: var(--text-tertiary); }

    .task-time {
        font-size: 10px;
        color: var(--text-tertiary);
        font-family: 'JetBrains Mono', monospace;
    }

    .agent-card-footer {
        padding: 16px 20px;
        background: rgba(0, 0, 0, 0.2);
        display: flex;
        gap: 8px;
    }

    .btn-small {
        flex: 1;
        padding: 8px 12px;
        background: transparent;
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        font-size: var(--text-xs);
        font-weight: var(--font-semibold);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .btn-small:hover {
        border-color: var(--accent-cyan);
        color: var(--accent-cyan);
    }

    /* Results Panel */
    .results-panel {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        margin-top: 24px;
        overflow: hidden;
    }

    .results-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-subtle);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .results-title {
        font-size: var(--text-lg);
        font-weight: var(--font-bold);
    }

    .results-body {
        padding: 20px 24px;
        max-height: 400px;
        overflow-y: auto;
    }

    .result-item {
        padding: 12px 16px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: var(--radius-md);
        margin-bottom: 12px;
    }

    .result-item:last-child {
        margin-bottom: 0;
    }

    .result-item.success {
        border-left: 3px solid var(--success);
    }

    .result-item.warning {
        border-left: 3px solid var(--warning);
    }

    .result-item.error {
        border-left: 3px solid var(--danger);
    }

    .result-agent {
        font-weight: var(--font-semibold);
        color: var(--accent-cyan);
        font-size: var(--text-sm);
        margin-bottom: 4px;
    }

    .result-message {
        font-size: var(--text-sm);
        color: var(--text-secondary);
    }

    .suggestion-item {
        padding: 10px 14px;
        background: rgba(0, 217, 255, 0.05);
        border: 1px solid rgba(0, 217, 255, 0.1);
        border-radius: var(--radius-md);
        margin-bottom: 8px;
        font-size: var(--text-sm);
        color: var(--text-secondary);
    }

    .suggestion-item::before {
        content: 'â†’ ';
        color: var(--accent-cyan);
    }

    /* Loading States */
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .spin {
        animation: spin 1s linear infinite;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all var(--transition-fast);
    }

    .loading-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .loading-content {
        text-align: center;
    }

    .loading-spinner {
        width: 48px;
        height: 48px;
        border: 3px solid var(--border-subtle);
        border-top-color: var(--accent-cyan);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
    }

    @media (max-width: 768px) {
        .agents-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 16px;
        }

        .status-stats {
            flex-wrap: wrap;
        }

        .agents-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <p style="color: var(--text-secondary);">Running agents...</p>
    </div>
</div>

<!-- Header -->
<div class="agents-header">
    <div>
        <a href="/admin" class="back-link">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Back to Admin
        </a>
        <div class="agents-title" style="margin-top: 12px;">
            <h1>Automated Agents</h1>
            <span class="agents-badge">DevOps</span>
        </div>
    </div>
</div>

<!-- Overall Status Banner -->
<div class="overall-status healthy" id="overall-status">
    <div class="status-main">
        <div class="status-icon healthy" id="status-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
        </div>
        <div class="status-text">
            <h2 id="status-title">Loading Status...</h2>
            <p id="status-message">Checking all agents...</p>
        </div>
    </div>
    <div class="status-stats">
        <div class="status-stat">
            <div class="value" id="stat-agents">-</div>
            <div class="label">Agents</div>
        </div>
        <div class="status-stat">
            <div class="value" id="stat-tasks">-</div>
            <div class="label">Tasks</div>
        </div>
        <div class="status-stat">
            <div class="value" style="color: var(--warning)" id="stat-warnings">-</div>
            <div class="label">Warnings</div>
        </div>
        <div class="status-stat">
            <div class="value" style="color: var(--danger)" id="stat-errors">-</div>
            <div class="label">Errors</div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="quick-actions">
    <button class="btn-agent primary" onclick="runStatusCheck()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
        Check Status
    </button>
    <button class="btn-agent" onclick="runDiagnose()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="8" x2="12" y2="12"/>
            <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        Diagnose Issues
    </button>
    <button class="btn-agent" onclick="runFix(false)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
        </svg>
        Get Fix Suggestions
    </button>
    <button class="btn-agent danger" onclick="runFix(true)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
        </svg>
        Auto-Fix Issues
    </button>
    <button class="btn-agent" onclick="getDevelopmentSuggestions()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
        </svg>
        Development Ideas
    </button>
</div>

<!-- Category Tabs -->
<div class="category-tabs" id="category-tabs">
    <button class="category-tab active" data-category="all">All Agents</button>
    <!-- Categories will be populated dynamically -->
</div>

<!-- Agent Cards Grid -->
<div class="agents-grid" id="agents-grid">
    <!-- Agent cards will be populated dynamically -->
    <div class="agent-card">
        <div class="agent-card-body" style="text-align: center; padding: 60px 20px;">
            <div class="loading-spinner" style="margin-bottom: 16px;"></div>
            <p style="color: var(--text-tertiary);">Loading agents...</p>
        </div>
    </div>
</div>

<!-- Results Panel -->
<div class="results-panel" id="results-panel" style="display: none;">
    <div class="results-header">
        <div class="results-title" id="results-title">Results</div>
        <button class="btn-small" onclick="closeResults()">Close</button>
    </div>
    <div class="results-body" id="results-body">
        <!-- Results will be populated dynamically -->
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    const agentIcons = {
        health: '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>',
        market_data: '<path d="M3 3v18h18"/><path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/>',
        trading: '<rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>',
        analysis: '<circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>',
        database: '<ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>',
        security: '<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>',
        development: '<polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/>'
    };

    function showLoading() {
        document.getElementById('loading-overlay').classList.add('active');
    }

    function hideLoading() {
        document.getElementById('loading-overlay').classList.remove('active');
    }

    function updateOverallStatus(data) {
        const banner = document.getElementById('overall-status');
        const icon = document.getElementById('status-icon');
        const status = data.overall_status || 'unknown';
        
        // Update classes
        banner.className = `overall-status ${status}`;
        icon.className = `status-icon ${status}`;
        
        // Update icon
        if (status === 'healthy') {
            icon.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>';
        } else if (status === 'warning') {
            icon.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>';
        } else {
            icon.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';
        }
        
        // Update text
        document.getElementById('status-title').textContent = 
            status === 'healthy' ? 'All Systems Operational' :
            status === 'warning' ? 'Warnings Detected' : 'Issues Detected';
        
        document.getElementById('status-message').textContent = 
            `Last checked: ${new Date().toLocaleTimeString()}`;
        
        // Update stats
        document.getElementById('stat-agents').textContent = data.total_agents || 0;
        
        // Count tasks
        let totalTasks = 0;
        for (const category in data.agents_by_category) {
            data.agents_by_category[category].forEach(agent => {
                totalTasks += Object.keys(agent.tasks || {}).length;
            });
        }
        document.getElementById('stat-tasks').textContent = totalTasks;
        document.getElementById('stat-warnings').textContent = data.total_warnings || 0;
        document.getElementById('stat-errors').textContent = data.total_errors || 0;
    }

    function renderAgentCards(data, filter = 'all') {
        const grid = document.getElementById('agents-grid');
        const tabs = document.getElementById('category-tabs');
        
        // Build category tabs
        const categories = data.categories || [];
        tabs.innerHTML = '<button class="category-tab ' + (filter === 'all' ? 'active' : '') + '" data-category="all" onclick="filterCategory(\'all\')">All Agents</button>';
        categories.forEach(cat => {
            tabs.innerHTML += `<button class="category-tab ${filter === cat ? 'active' : ''}" data-category="${cat}" onclick="filterCategory('${cat}')">${cat}</button>`;
        });
        
        // Build agent cards
        let html = '';
        for (const category in data.agents_by_category) {
            if (filter !== 'all' && filter !== category) continue;
            
            data.agents_by_category[category].forEach(agent => {
                const icon = agentIcons[agent.name] || agentIcons.analysis;
                const status = agent.status || 'unknown';
                
                html += `
                    <div class="agent-card" data-agent="${agent.name}" data-category="${category}">
                        <div class="agent-card-header">
                            <div class="agent-info">
                                <div class="agent-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">${icon}</svg>
                                </div>
                                <div>
                                    <div class="agent-name">${agent.name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</div>
                                    <div class="agent-category">${category}</div>
                                </div>
                            </div>
                            <span class="agent-status-badge ${status}">${status}</span>
                        </div>
                        <div class="agent-card-body">
                            <div class="agent-description">${agent.description || 'No description available'}</div>
                            <div class="agent-tasks">
                                <div class="tasks-header">Tasks (${Object.keys(agent.tasks || {}).length})</div>
                                ${Object.entries(agent.tasks || {}).map(([id, task]) => `
                                    <div class="task-item">
                                        <div class="task-name">${task.name}</div>
                                        <div class="task-status">
                                            <span class="task-dot ${task.last_status || 'unknown'}"></span>
                                            <span class="task-time">${task.last_run ? new Date(task.last_run).toLocaleTimeString() : 'never'}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="agent-card-footer">
                            <button class="btn-small" onclick="runAgentStatus('${agent.name}')">Check</button>
                            <button class="btn-small" onclick="runAgentDiagnose('${agent.name}')">Diagnose</button>
                            <button class="btn-small" onclick="runAgentSuggestions('${agent.name}')">Ideas</button>
                        </div>
                    </div>
                `;
            });
        }
        
        grid.innerHTML = html || '<p style="color: var(--text-tertiary); text-align: center; padding: 40px;">No agents found</p>';
    }

    function filterCategory(category) {
        // Update active tab
        document.querySelectorAll('.category-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.category === category);
        });
        
        // Filter cards
        document.querySelectorAll('.agent-card').forEach(card => {
            if (category === 'all' || card.dataset.category === category) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
    }

    function showResults(title, results) {
        const panel = document.getElementById('results-panel');
        const body = document.getElementById('results-body');
        
        document.getElementById('results-title').textContent = title;
        
        let html = '';
        
        if (results.suggestions) {
            results.suggestions.forEach(s => {
                html += `<div class="suggestion-item">${s.suggestion || s}</div>`;
            });
        } else if (results.issues) {
            results.issues.forEach(issue => {
                html += `<div class="result-item error"><div class="result-message">${issue}</div></div>`;
            });
            if (results.suggestions && results.suggestions.length) {
                html += '<h4 style="margin: 16px 0 8px; color: var(--accent-cyan);">Suggestions:</h4>';
                results.suggestions.forEach(s => {
                    html += `<div class="suggestion-item">${s}</div>`;
                });
            }
        } else if (results.results) {
            for (const [agent, result] of Object.entries(results.results)) {
                const statusClass = result.status === 'healthy' ? 'success' : result.status === 'warning' ? 'warning' : 'error';
                html += `
                    <div class="result-item ${statusClass}">
                        <div class="result-agent">${agent}</div>
                        <div class="result-message">${result.message}</div>
                    </div>
                `;
            }
        } else if (results.data) {
            html = `<pre style="font-family: 'JetBrains Mono', monospace; font-size: 12px; overflow-x: auto;">${JSON.stringify(results.data, null, 2)}</pre>`;
        }
        
        body.innerHTML = html || '<p style="color: var(--text-tertiary);">No results</p>';
        panel.style.display = '';
        panel.scrollIntoView({ behavior: 'smooth' });
    }

    function closeResults() {
        document.getElementById('results-panel').style.display = 'none';
    }

    async function loadAgents() {
        try {
            const response = await fetch('/api/agents/summary');
            const data = await response.json();
            
            if (data.success) {
                updateOverallStatus(data.data);
                renderAgentCards(data.data);
            }
        } catch (error) {
            console.error('Error loading agents:', error);
        }
    }

    async function runStatusCheck() {
        showLoading();
        try {
            const response = await fetch('/api/agents/status');
            const data = await response.json();
            
            if (data.success) {
                updateOverallStatus(data.data.overall);
                renderAgentCards(data.data.overall);
                showResults('Status Check Results', { results: data.data.agents });
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
        hideLoading();
    }

    async function runDiagnose() {
        showLoading();
        try {
            const response = await fetch('/api/agents/diagnose');
            const data = await response.json();
            
            if (data.success) {
                showResults('Diagnosis Results', data.data);
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
        hideLoading();
    }

    async function runFix(autoFix) {
        if (autoFix && !confirm('Auto-fix will attempt to automatically resolve issues. Continue?')) {
            return;
        }
        
        showLoading();
        try {
            const response = await fetch('/api/agents/fix', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ auto_fix: autoFix })
            });
            const data = await response.json();
            
            if (data.success) {
                showResults(autoFix ? 'Auto-Fix Results' : 'Fix Suggestions', { results: data.data.results });
                loadAgents(); // Refresh status
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
        hideLoading();
    }

    async function getDevelopmentSuggestions() {
        showLoading();
        try {
            const response = await fetch('/api/agents/develop');
            const data = await response.json();
            
            if (data.success) {
                showResults('Development Suggestions', data.data);
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
        hideLoading();
    }

    async function runAgentStatus(agentName) {
        showLoading();
        try {
            const response = await fetch(`/api/agents/${agentName}`);
            const data = await response.json();
            
            if (data.success) {
                showResults(`${agentName} Status`, { data: data.data });
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
        hideLoading();
    }

    async function runAgentDiagnose(agentName) {
        showLoading();
        try {
            const response = await fetch(`/api/agents/${agentName}/diagnose`);
            const data = await response.json();
            
            if (data.success) {
                showResults(`${agentName} Diagnosis`, data.data);
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
        hideLoading();
    }

    async function runAgentSuggestions(agentName) {
        showLoading();
        try {
            const response = await fetch(`/api/agents/${agentName}/suggestions`);
            const data = await response.json();
            
            if (data.success) {
                showResults(`${agentName} Development Ideas`, data.data);
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
        hideLoading();
    }

    // Load agents on page load
    document.addEventListener('DOMContentLoaded', loadAgents);
</script>
{% endblock %}

