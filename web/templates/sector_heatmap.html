{% extends "base_layout.html" %}

{% block title %}Sector Heatmap - Qunex Trade{% endblock %}

{% block extra_styles %}
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
    /* View Toggle */
    .view-toggle {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
    }

    .view-btn {
        padding: 10px 20px;
        background: var(--bg-hover);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .view-btn:hover {
        background: var(--bg-active);
        color: var(--text-primary);
    }

    .view-btn.active {
        background: linear-gradient(135deg, rgba(0, 217, 255, 0.2), rgba(168, 85, 247, 0.2));
        border-color: rgba(0, 217, 255, 0.4);
        color: var(--text-primary);
    }

    /* Market Summary */
    .market-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .summary-card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        padding: 20px;
        text-align: center;
    }

    .summary-label {
        font-size: var(--text-xs);
        color: var(--text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 8px;
    }

    .summary-value {
        font-size: var(--text-xl);
        font-weight: var(--font-bold);
        font-family: 'JetBrains Mono', monospace;
    }

    .summary-value.positive { color: var(--success); }
    .summary-value.negative { color: var(--danger); }
    .summary-value.bullish { color: var(--success); }
    .summary-value.bearish { color: var(--danger); }
    .summary-value.mixed { color: var(--warning); }

    /* Treemap Container */
    .treemap-container {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        padding: 24px;
        margin-bottom: 24px;
    }

    .treemap-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .treemap-title {
        font-size: var(--text-xl);
        font-weight: var(--font-semibold);
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .realtime-badge {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.3);
        border-radius: var(--radius-full);
        font-size: var(--text-xs);
        color: var(--success);
        font-weight: var(--font-medium);
    }

    .realtime-dot {
        width: 6px;
        height: 6px;
        background: var(--success);
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* Treemap */
    #treemap {
        width: 100%;
        height: 700px;
        background: #1a1a2e;
        border-radius: var(--radius-lg);
        overflow: hidden;
    }

    .treemap-cell {
        stroke: #1a1a2e;
        stroke-width: 1px;
        transition: opacity 0.2s;
    }

    .treemap-cell:hover {
        opacity: 0.85;
        cursor: pointer;
    }

    .treemap-label {
        font-family: 'JetBrains Mono', 'Inter', sans-serif;
        fill: white;
        text-anchor: middle;
        pointer-events: none;
        text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    }

    .treemap-label-ticker {
        font-weight: 700;
        font-size: 12px;
    }

    .treemap-label-change {
        font-weight: 400;
        font-size: 10px;
    }

    .sector-label {
        font-family: 'Inter', sans-serif;
        font-size: 11px;
        font-weight: 600;
        fill: rgba(255,255,255,0.9);
        text-anchor: start;
        pointer-events: none;
        text-shadow: 0 1px 3px rgba(0,0,0,0.9);
    }

    /* Tooltip */
    .treemap-tooltip {
        position: fixed;
        background: rgba(15, 15, 25, 0.95);
        border: 1px solid rgba(255,255,255,0.15);
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 13px;
        pointer-events: none;
        z-index: 1000;
        box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        backdrop-filter: blur(10px);
        display: none;
        min-width: 180px;
    }

    .tooltip-ticker {
        font-size: 16px;
        font-weight: 700;
        font-family: 'JetBrains Mono', monospace;
        margin-bottom: 8px;
    }

    .tooltip-row {
        display: flex;
        justify-content: space-between;
        margin: 4px 0;
        color: var(--text-secondary);
    }

    .tooltip-value {
        font-family: 'JetBrains Mono', monospace;
        font-weight: 600;
    }

    .tooltip-value.positive { color: #22c55e; }
    .tooltip-value.negative { color: #ef4444; }

    /* Color Legend */
    .color-legend {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 4px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .legend-gradient {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .legend-bar {
        width: 200px;
        height: 12px;
        background: linear-gradient(to right,
            #7f1d1d, #b91c1c, #dc2626, #ef4444, #f87171,
            #374151,
            #4ade80, #22c55e, #16a34a, #15803d, #166534
        );
        border-radius: 4px;
    }

    .legend-label {
        font-size: var(--text-xs);
        color: var(--text-tertiary);
        font-family: 'JetBrains Mono', monospace;
    }

    /* Heatmap Grid (Alternative View) */
    .heatmap-container {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        padding: 24px;
        margin-bottom: 32px;
        display: none;
    }

    .heatmap-container.show {
        display: block;
    }

    .heatmap-title {
        font-size: var(--text-xl);
        font-weight: var(--font-semibold);
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .heatmap-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
    }

    @media (max-width: 1024px) {
        .heatmap-grid {
            grid-template-columns: repeat(3, 1fr);
        }
        #treemap {
            height: 500px;
        }
    }

    @media (max-width: 768px) {
        .heatmap-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        #treemap {
            height: 400px;
        }
    }

    @media (max-width: 480px) {
        .heatmap-grid {
            grid-template-columns: 1fr;
        }
    }

    .sector-tile {
        position: relative;
        padding: 24px;
        border-radius: var(--radius-lg);
        cursor: pointer;
        transition: all var(--transition-fast);
        overflow: hidden;
        min-height: 120px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .sector-tile:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
    }

    .sector-tile.strong-gain {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(34, 197, 94, 0.15));
        border: 1px solid rgba(34, 197, 94, 0.4);
    }

    .sector-tile.gain {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.1));
        border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .sector-tile.slight-gain {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05));
        border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .sector-tile.neutral {
        background: var(--bg-hover);
        border: 1px solid var(--border-subtle);
    }

    .sector-tile.slight-loss {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
        border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .sector-tile.loss {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .sector-tile.strong-loss {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(239, 68, 68, 0.15));
        border: 1px solid rgba(239, 68, 68, 0.4);
    }

    .sector-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }

    .sector-name {
        font-size: var(--text-sm);
        font-weight: var(--font-semibold);
        color: var(--text-primary);
    }

    .sector-ticker {
        font-size: var(--text-xs);
        color: var(--text-tertiary);
        font-family: 'JetBrains Mono', monospace;
        padding: 2px 6px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: var(--radius-sm);
    }

    .sector-change {
        font-size: var(--text-2xl);
        font-weight: var(--font-bold);
        font-family: 'JetBrains Mono', monospace;
    }

    .sector-change.positive { color: var(--success); }
    .sector-change.negative { color: var(--danger); }

    .sector-price {
        font-size: var(--text-sm);
        color: var(--text-secondary);
        font-family: 'JetBrains Mono', monospace;
        margin-top: 4px;
    }

    .sector-volume {
        font-size: var(--text-xs);
        color: var(--text-tertiary);
        margin-top: 4px;
    }

    /* Sector Detail Panel */
    .sector-detail {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        padding: 24px;
        display: none;
    }

    .sector-detail.show {
        display: block;
    }

    .detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border-subtle);
    }

    .detail-title {
        font-size: var(--text-xl);
        font-weight: var(--font-semibold);
    }

    .detail-close {
        width: 32px;
        height: 32px;
        background: var(--bg-hover);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--text-secondary);
        transition: all var(--transition-fast);
    }

    .detail-close:hover {
        background: var(--bg-active);
        color: var(--text-primary);
    }

    .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
    }

    .detail-item {
        padding: 16px;
        background: var(--bg-hover);
        border-radius: var(--radius-md);
    }

    .detail-label {
        font-size: var(--text-xs);
        color: var(--text-tertiary);
        margin-bottom: 6px;
    }

    .detail-value {
        font-size: var(--text-lg);
        font-weight: var(--font-semibold);
        font-family: 'JetBrains Mono', monospace;
    }

    /* Loading State */
    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 80px;
        gap: 16px;
    }

    .spinner {
        width: 48px;
        height: 48px;
        border: 3px solid var(--border-subtle);
        border-top-color: var(--accent-cyan);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .loading-text {
        color: var(--text-tertiary);
        font-size: var(--text-sm);
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="content-header">
    <div>
        <h1 class="content-title">Market Map</h1>
        <p class="content-subtitle">Finviz-style treemap visualization of S&P 500 stocks by sector</p>
    </div>
</div>

<!-- View Toggle -->
<div class="view-toggle">
    <button class="view-btn active" onclick="showView('treemap')" id="treemapBtn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px; vertical-align: middle;">
            <rect x="3" y="3" width="7" height="9"/>
            <rect x="14" y="3" width="7" height="5"/>
            <rect x="14" y="12" width="7" height="9"/>
            <rect x="3" y="16" width="7" height="5"/>
        </svg>
        Treemap
    </button>
    <button class="view-btn" onclick="showView('grid')" id="gridBtn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px; vertical-align: middle;">
            <rect x="3" y="3" width="7" height="7"/>
            <rect x="14" y="3" width="7" height="7"/>
            <rect x="3" y="14" width="7" height="7"/>
            <rect x="14" y="14" width="7" height="7"/>
        </svg>
        Sector Grid
    </button>
</div>

<!-- Market Summary -->
<div class="market-summary" id="marketSummary">
    <div class="summary-card">
        <div class="summary-label">Market Trend</div>
        <div class="summary-value" id="marketSentiment">--</div>
    </div>
    <div class="summary-card">
        <div class="summary-label">Market Change</div>
        <div class="summary-value" id="avgChange">--</div>
    </div>
    <div class="summary-card">
        <div class="summary-label">Sectors Up</div>
        <div class="summary-value positive" id="sectorsUp">--</div>
    </div>
    <div class="summary-card">
        <div class="summary-label">Sectors Down</div>
        <div class="summary-value negative" id="sectorsDown">--</div>
    </div>
    <div class="summary-card">
        <div class="summary-label">Stocks Tracked</div>
        <div class="summary-value" id="stocksCount">--</div>
    </div>
</div>

<!-- Treemap View -->
<div class="treemap-container" id="treemapView">
    <div class="treemap-header">
        <div class="treemap-title">
            <span>S&P 500 Market Map</span>
            <div class="realtime-badge">
                <span class="realtime-dot"></span>
                <span>Live</span>
            </div>
        </div>
    </div>

    <div id="treemap">
        <div class="loading-container">
            <div class="spinner"></div>
            <div class="loading-text">Loading market data...</div>
        </div>
    </div>

    <div class="color-legend">
        <div class="legend-gradient">
            <span class="legend-label">-3%</span>
            <div class="legend-bar"></div>
            <span class="legend-label">+3%</span>
        </div>
    </div>
</div>

<!-- Sector Grid View (Alternative) -->
<div class="heatmap-container" id="gridView">
    <div class="heatmap-title">
        <span>11 GICS Sectors</span>
        <div class="realtime-badge">
            <span class="realtime-dot"></span>
            <span>Live</span>
        </div>
    </div>

    <div class="heatmap-grid" id="heatmapGrid">
        <div class="loading-container">
            <div class="spinner"></div>
        </div>
    </div>
</div>

<!-- Tooltip -->
<div class="treemap-tooltip" id="tooltip"></div>

<!-- Sector Detail Panel -->
<div class="sector-detail" id="sectorDetail">
    <div class="detail-header">
        <div class="detail-title" id="detailTitle">Technology</div>
        <button class="detail-close" onclick="closeSectorDetail()">&times;</button>
    </div>
    <div class="detail-grid" id="detailGrid">
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
<script>
    let treemapData = null;
    let sectorData = [];
    let currentView = 'treemap';

    // Color scale for performance (-3% to +3%)
    function getColor(changePercent) {
        // Finviz-style colors: vivid red-to-green scale
        const clampedChange = Math.max(-4, Math.min(4, changePercent || 0));

        if (Math.abs(clampedChange) < 0.1) {
            return '#363636'; // Neutral dark gray
        }

        if (clampedChange > 0) {
            // Green scale (Finviz uses bright greens)
            const t = Math.min(clampedChange / 3, 1);
            if (t < 0.33) {
                // Dark green
                return `rgb(${Math.round(30 - t * 30)}, ${Math.round(80 + t * 60)}, ${Math.round(40 - t * 20)})`;
            } else if (t < 0.66) {
                // Medium green
                return `rgb(${Math.round(20)}, ${Math.round(120 + (t - 0.33) * 80)}, ${Math.round(30)})`;
            } else {
                // Bright green
                return `rgb(${Math.round(15)}, ${Math.round(150 + (t - 0.66) * 50)}, ${Math.round(25)})`;
            }
        } else {
            // Red scale (Finviz uses deep reds)
            const t = Math.min(Math.abs(clampedChange) / 3, 1);
            if (t < 0.33) {
                // Dark red
                return `rgb(${Math.round(100 + t * 60)}, ${Math.round(40 - t * 20)}, ${Math.round(40 - t * 20)})`;
            } else if (t < 0.66) {
                // Medium red
                return `rgb(${Math.round(160 + (t - 0.33) * 40)}, ${Math.round(30 - (t - 0.33) * 15)}, ${Math.round(30 - (t - 0.33) * 15)})`;
            } else {
                // Bright/deep red
                return `rgb(${Math.round(200 + (t - 0.66) * 30)}, ${Math.round(20)}, ${Math.round(20)})`;
            }
        }
    }

    function showView(view) {
        currentView = view;
        document.getElementById('treemapBtn').classList.toggle('active', view === 'treemap');
        document.getElementById('gridBtn').classList.toggle('active', view === 'grid');
        document.getElementById('treemapView').style.display = view === 'treemap' ? 'block' : 'none';
        document.getElementById('gridView').classList.toggle('show', view === 'grid');

        if (view === 'grid' && sectorData.length === 0) {
            loadSectorHeatmap();
        }
    }

    async function loadTreemap() {
        try {
            const response = await fetch('/api/market/treemap');
            const result = await response.json();

            if (result.success) {
                treemapData = result.data;
                renderTreemap(result.data);
                updateSummaryFromTreemap(result.summary);
            } else {
                showTreemapError(result.error || 'Failed to load treemap data');
            }
        } catch (error) {
            console.error('Error loading treemap:', error);
            showTreemapError('Failed to connect to server');
        }
    }

    function renderTreemap(data) {
        const container = document.getElementById('treemap');
        container.innerHTML = '';

        const width = container.clientWidth;
        const height = container.clientHeight;

        const svg = d3.select('#treemap')
            .append('svg')
            .attr('width', width)
            .attr('height', height);

        // Create hierarchy
        const root = d3.hierarchy(data)
            .sum(d => d.value)
            .sort((a, b) => b.value - a.value);

        // Finviz-style treemap: tight layout with minimal gaps
        d3.treemap()
            .tile(d3.treemapSquarify.ratio(1.2))
            .size([width, height])
            .paddingOuter(1)     // Thin outer border
            .paddingTop(15)      // Space for sector label
            .paddingInner(1)     // Minimal gap between cells (just for border)
            .round(true)
            (root);

        const tooltip = document.getElementById('tooltip');

        // Draw all cells first (flat structure like Finviz)
        const allStocks = root.leaves();

        // Draw stock cells
        svg.selectAll('rect.treemap-cell')
            .data(allStocks)
            .join('rect')
            .attr('class', 'treemap-cell')
            .attr('x', d => d.x0)
            .attr('y', d => d.y0)
            .attr('width', d => Math.max(0, d.x1 - d.x0))
            .attr('height', d => Math.max(0, d.y1 - d.y0))
            .attr('fill', d => getColor(d.data.change_percent))
            .attr('stroke', '#1a1a2e')
            .attr('stroke-width', 1)
            .on('mousemove', function(event, d) {
                const changePercent = d.data.change_percent || 0;
                const isPositive = changePercent >= 0;

                tooltip.innerHTML = `
                    <div class="tooltip-ticker">${d.data.ticker}</div>
                    <div class="tooltip-row">
                        <span>Price</span>
                        <span class="tooltip-value">$${(d.data.price || 0).toFixed(2)}</span>
                    </div>
                    <div class="tooltip-row">
                        <span>Change</span>
                        <span class="tooltip-value ${isPositive ? 'positive' : 'negative'}">
                            ${isPositive ? '+' : ''}${changePercent.toFixed(2)}%
                        </span>
                    </div>
                    <div class="tooltip-row">
                        <span>Market Cap</span>
                        <span class="tooltip-value">${formatMarketCap(d.data.market_cap)}</span>
                    </div>
                    <div class="tooltip-row">
                        <span>Volume</span>
                        <span class="tooltip-value">${formatVolume(d.data.volume)}</span>
                    </div>
                `;
                tooltip.style.display = 'block';
                tooltip.style.left = (event.clientX + 15) + 'px';
                tooltip.style.top = (event.clientY + 15) + 'px';
            })
            .on('mouseout', function() {
                tooltip.style.display = 'none';
            })
            .on('click', function(event, d) {
                window.location.href = `/stocks/${d.data.ticker}`;
            });

        // Add stock labels - Finviz style with dynamic sizing
        svg.selectAll('g.stock-label')
            .data(allStocks)
            .join('g')
            .attr('class', 'stock-label')
            .each(function(d) {
                const cellWidth = d.x1 - d.x0;
                const cellHeight = d.y1 - d.y0;
                const centerX = (d.x0 + d.x1) / 2;
                const centerY = (d.y0 + d.y1) / 2;
                const changePercent = d.data.change_percent || 0;
                const isPositive = changePercent >= 0;
                const labelGroup = d3.select(this);

                // Aggressive Finviz-style font scaling
                const area = cellWidth * cellHeight;
                const minDim = Math.min(cellWidth, cellHeight);
                let tickerSize, changeSize, spacing;

                // Scale based on both area and minimum dimension for better fit
                if (area >= 25000 && minDim >= 100) {
                    tickerSize = 28;
                    changeSize = 20;
                    spacing = 28;
                } else if (area >= 15000 && minDim >= 80) {
                    tickerSize = 24;
                    changeSize = 17;
                    spacing = 24;
                } else if (area >= 8000 && minDim >= 60) {
                    tickerSize = 20;
                    changeSize = 14;
                    spacing = 20;
                } else if (area >= 5000 && minDim >= 50) {
                    tickerSize = 16;
                    changeSize = 12;
                    spacing = 16;
                } else if (area >= 3000 && minDim >= 40) {
                    tickerSize = 14;
                    changeSize = 10;
                    spacing = 14;
                } else if (area >= 1500 && minDim >= 30) {
                    tickerSize = 12;
                    changeSize = 9;
                    spacing = 12;
                } else if (area >= 800 && minDim >= 25) {
                    tickerSize = 10;
                    changeSize = 7;
                    spacing = 10;
                } else if (area >= 400 && minDim >= 18) {
                    tickerSize = 9;
                    changeSize = 0;
                    spacing = 0;
                } else if (cellWidth >= 25 && cellHeight >= 15) {
                    tickerSize = 8;
                    changeSize = 0;
                    spacing = 0;
                } else if (cellWidth >= 18 && cellHeight >= 12) {
                    tickerSize = 7;
                    changeSize = 0;
                    spacing = 0;
                } else {
                    return; // Too small for any label
                }

                // Ticker symbol
                labelGroup.append('text')
                    .attr('x', centerX)
                    .attr('y', changeSize > 0 ? centerY - spacing/2 : centerY)
                    .attr('text-anchor', 'middle')
                    .attr('dominant-baseline', 'middle')
                    .style('font-family', 'Arial Black, Arial, sans-serif')
                    .style('font-size', tickerSize + 'px')
                    .style('font-weight', '900')
                    .style('fill', '#ffffff')
                    .style('text-shadow', '1px 1px 2px #000, -1px -1px 2px #000, 1px -1px 2px #000, -1px 1px 2px #000')
                    .style('pointer-events', 'none')
                    .text(d.data.ticker);

                // Change percent
                if (changeSize > 0) {
                    labelGroup.append('text')
                        .attr('x', centerX)
                        .attr('y', centerY + spacing/2 + 2)
                        .attr('text-anchor', 'middle')
                        .attr('dominant-baseline', 'middle')
                        .style('font-family', 'Arial, sans-serif')
                        .style('font-size', changeSize + 'px')
                        .style('font-weight', 'bold')
                        .style('fill', '#ffffff')
                        .style('text-shadow', '1px 1px 2px #000, -1px -1px 2px #000, 1px -1px 2px #000, -1px 1px 2px #000')
                        .style('pointer-events', 'none')
                        .text(`${isPositive ? '+' : ''}${changePercent.toFixed(2)}%`);
                }
            });

        // Draw sector labels on top (overlaid like Finviz)
        svg.selectAll('text.sector-label')
            .data(root.children)
            .join('text')
            .attr('class', 'sector-label')
            .attr('x', d => d.x0 + 4)
            .attr('y', d => d.y0 + 12)
            .style('font-family', 'Arial, sans-serif')
            .style('font-size', '10px')
            .style('font-weight', 'bold')
            .style('fill', '#ffffff')
            .style('text-shadow', '1px 1px 2px #000, -1px -1px 2px #000, 1px -1px 2px #000, -1px 1px 2px #000')
            .style('pointer-events', 'none')
            .text(d => d.data.name);
    }

    function updateSummaryFromTreemap(summary) {
        if (!summary) return;

        document.getElementById('stocksCount').textContent = summary.stocks_count || 0;

        const avgChangeEl = document.getElementById('avgChange');
        const marketChange = summary.market_change || 0;
        avgChangeEl.textContent = `${marketChange >= 0 ? '+' : ''}${marketChange.toFixed(2)}%`;
        avgChangeEl.className = `summary-value ${marketChange >= 0 ? 'positive' : 'negative'}`;

        // Determine sentiment
        const sentimentEl = document.getElementById('marketSentiment');
        if (marketChange > 0.5) {
            sentimentEl.textContent = 'BULLISH';
            sentimentEl.className = 'summary-value bullish';
        } else if (marketChange < -0.5) {
            sentimentEl.textContent = 'BEARISH';
            sentimentEl.className = 'summary-value bearish';
        } else {
            sentimentEl.textContent = 'MIXED';
            sentimentEl.className = 'summary-value mixed';
        }
    }

    async function loadSectorHeatmap() {
        try {
            const response = await fetch('/api/market/sector-heatmap');
            const data = await response.json();

            if (data.success) {
                sectorData = data.sectors;
                renderHeatmap(data.sectors);
                updateSummary(data.summary);
            } else {
                showError(data.error || 'Failed to load sector data');
            }
        } catch (error) {
            console.error('Error loading sector heatmap:', error);
            showError('Failed to load sector data');
        }
    }

    function renderHeatmap(sectors) {
        const grid = document.getElementById('heatmapGrid');

        if (!sectors || sectors.length === 0) {
            grid.innerHTML = '<p style="text-align: center; color: var(--text-tertiary); padding: 40px;">No sector data available</p>';
            return;
        }

        grid.innerHTML = sectors.map(sector => {
            const changePercent = sector.change_percent || 0;
            const colorClass = getColorClass(changePercent);
            const isPositive = changePercent >= 0;

            return `
                <div class="sector-tile ${colorClass}" onclick="showSectorDetail('${sector.sector}', '${sector.ticker}')">
                    <div class="sector-header">
                        <div class="sector-name">${sector.sector}</div>
                        <div class="sector-ticker">${sector.ticker}</div>
                    </div>
                    <div>
                        <div class="sector-change ${isPositive ? 'positive' : 'negative'}">
                            ${isPositive ? '+' : ''}${changePercent.toFixed(2)}%
                        </div>
                        <div class="sector-price">$${(sector.price || 0).toFixed(2)}</div>
                        <div class="sector-volume">Vol: ${formatVolume(sector.volume)}</div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function getColorClass(changePercent) {
        if (changePercent > 2) return 'strong-gain';
        if (changePercent > 1) return 'gain';
        if (changePercent > 0) return 'slight-gain';
        if (changePercent === 0) return 'neutral';
        if (changePercent > -1) return 'slight-loss';
        if (changePercent > -2) return 'loss';
        return 'strong-loss';
    }

    function updateSummary(summary) {
        if (!summary) return;

        const sentimentEl = document.getElementById('marketSentiment');
        sentimentEl.textContent = (summary.sentiment || 'mixed').toUpperCase();
        sentimentEl.className = `summary-value ${summary.sentiment || 'mixed'}`;

        const avgChangeEl = document.getElementById('avgChange');
        const avgChange = summary.avg_change || 0;
        avgChangeEl.textContent = `${avgChange >= 0 ? '+' : ''}${avgChange.toFixed(2)}%`;
        avgChangeEl.className = `summary-value ${avgChange >= 0 ? 'positive' : 'negative'}`;

        document.getElementById('sectorsUp').textContent = summary.gainers || 0;
        document.getElementById('sectorsDown').textContent = summary.losers || 0;
    }

    function showSectorDetail(sectorName, ticker) {
        const sector = sectorData.find(s => s.sector === sectorName);
        if (!sector) return;

        document.getElementById('detailTitle').textContent = `${sectorName} (${ticker})`;

        const changePercent = sector.change_percent || 0;
        const isPositive = changePercent >= 0;

        document.getElementById('detailGrid').innerHTML = `
            <div class="detail-item">
                <div class="detail-label">Current Price</div>
                <div class="detail-value">$${(sector.price || 0).toFixed(2)}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Change</div>
                <div class="detail-value ${isPositive ? 'positive' : 'negative'}">
                    ${isPositive ? '+' : ''}${(sector.change || 0).toFixed(2)}
                </div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Change %</div>
                <div class="detail-value ${isPositive ? 'positive' : 'negative'}">
                    ${isPositive ? '+' : ''}${changePercent.toFixed(2)}%
                </div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Volume</div>
                <div class="detail-value">${formatVolume(sector.volume)}</div>
            </div>
        `;

        document.getElementById('sectorDetail').classList.add('show');
    }

    function closeSectorDetail() {
        document.getElementById('sectorDetail').classList.remove('show');
    }

    function formatVolume(volume) {
        if (!volume) return '0';
        if (volume >= 1e9) return (volume / 1e9).toFixed(1) + 'B';
        if (volume >= 1e6) return (volume / 1e6).toFixed(1) + 'M';
        if (volume >= 1e3) return (volume / 1e3).toFixed(1) + 'K';
        return volume.toString();
    }

    function formatMarketCap(cap) {
        if (!cap) return 'N/A';
        if (cap >= 1e12) return '$' + (cap / 1e12).toFixed(2) + 'T';
        if (cap >= 1e9) return '$' + (cap / 1e9).toFixed(1) + 'B';
        if (cap >= 1e6) return '$' + (cap / 1e6).toFixed(1) + 'M';
        return '$' + cap.toLocaleString();
    }

    function showTreemapError(message) {
        const container = document.getElementById('treemap');
        container.innerHTML = `
            <div class="loading-container">
                <p style="color: var(--danger);">${message}</p>
                <button onclick="loadTreemap()" class="view-btn" style="margin-top: 16px;">Retry</button>
            </div>
        `;
    }

    function showError(message) {
        const grid = document.getElementById('heatmapGrid');
        grid.innerHTML = `<p style="text-align: center; color: var(--danger); padding: 40px;">${message}</p>`;
    }

    // Handle window resize
    let resizeTimeout;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            if (currentView === 'treemap' && treemapData) {
                renderTreemap(treemapData);
            }
        }, 250);
    });

    // Initial load
    loadTreemap();

    // Auto-refresh every 60 seconds
    setInterval(() => {
        if (currentView === 'treemap') {
            loadTreemap();
        } else {
            loadSectorHeatmap();
        }
    }, 60000);
</script>
{% endblock %}
