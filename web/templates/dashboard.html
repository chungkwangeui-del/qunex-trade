{% extends "base_layout.html" %}

{% block title %}Dashboard - Qunex Trade{% endblock %}

{% block extra_styles %}
<style>
    /* Market Overview Cards */
    .market-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 32px;
    }

    .index-card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        padding: 20px;
        transition: all var(--transition-fast);
    }

    .index-card:hover {
        border-color: var(--border-medium);
        transform: translateY(-2px);
    }

    .index-name {
        font-size: var(--text-sm);
        color: var(--text-tertiary);
        margin-bottom: 8px;
    }

    .index-value {
        font-size: var(--text-2xl);
        font-weight: var(--font-bold);
        font-family: 'JetBrains Mono', monospace;
        margin-bottom: 4px;
    }

    .index-change {
        font-size: var(--text-sm);
        font-weight: var(--font-semibold);
        font-family: 'JetBrains Mono', monospace;
    }

    .index-change.positive { color: var(--success); }
    .index-change.negative { color: var(--danger); }

    /* Section Container */
    .section-container {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        margin-bottom: 24px;
        overflow: hidden;
        min-width: 0;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-subtle);
    }

    .section-title {
        font-size: var(--text-lg);
        font-weight: var(--font-semibold);
    }

    .view-all-link {
        color: var(--accent-cyan);
        text-decoration: none;
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        transition: color var(--transition-fast);
    }

    .view-all-link:hover {
        color: var(--accent-purple);
    }

    /* Two Column Layout - Balanced Grid */
    .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        width: 100%;
    }

    .dashboard-left {
        min-width: 0;
    }

    .dashboard-right {
        min-width: 0;
    }

    @media (max-width: 1100px) {
        .dashboard-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Top Movers */
    .movers-tabs {
        display: flex;
        gap: 8px;
    }

    .mover-tab {
        padding: 6px 14px;
        background: var(--bg-hover);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .mover-tab:hover {
        background: var(--bg-active);
    }

    .mover-tab.active {
        background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
        color: #000;
        border-color: transparent;
    }

    .mover-list {
        padding: 16px 24px;
    }

    .mover-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 0;
        border-bottom: 1px solid var(--border-subtle);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .mover-item:last-child {
        border-bottom: none;
    }

    .mover-item:hover {
        padding-left: 8px;
    }

    .mover-info {
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 0;
        flex: 1;
    }

    .mover-logo {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, rgba(0, 217, 255, 0.15), rgba(168, 85, 247, 0.15));
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: var(--font-bold);
        font-size: var(--text-xs);
        color: var(--text-primary);
        flex-shrink: 0;
    }

    .mover-details {
        min-width: 0;
    }

    .mover-symbol {
        font-weight: var(--font-semibold);
        font-size: var(--text-sm);
    }

    .mover-name {
        font-size: var(--text-xs);
        color: var(--text-tertiary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100px;
    }

    .mover-data {
        text-align: right;
        flex-shrink: 0;
    }

    .mover-price {
        font-weight: var(--font-semibold);
        font-family: 'JetBrains Mono', monospace;
        font-size: var(--text-sm);
    }

    .mover-change {
        font-size: var(--text-xs);
        font-family: 'JetBrains Mono', monospace;
    }

    .mover-change.positive { color: var(--success); }
    .mover-change.negative { color: var(--danger); }

    /* Watchlist Table */
    .watchlist-table {
        width: 100%;
        border-collapse: collapse;
    }

    .watchlist-table th {
        padding: 14px 24px;
        text-align: left;
        font-size: var(--text-xs);
        font-weight: var(--font-semibold);
        color: var(--text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 1px solid var(--border-subtle);
    }

    .watchlist-table th.text-right {
        text-align: right;
    }

    .watchlist-table td {
        padding: 16px 24px;
        border-bottom: 1px solid var(--border-subtle);
    }

    .watchlist-table tr:last-child td {
        border-bottom: none;
    }

    .watchlist-table tr:hover td {
        background: var(--bg-hover);
    }

    .stock-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .stock-logo {
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, rgba(0, 217, 255, 0.15), rgba(168, 85, 247, 0.15));
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: var(--font-bold);
        font-size: var(--text-xs);
    }

    .stock-symbol {
        font-weight: var(--font-semibold);
    }

    .stock-name {
        font-size: var(--text-xs);
        color: var(--text-tertiary);
    }

    .price-value {
        font-family: 'JetBrains Mono', monospace;
        font-weight: var(--font-medium);
    }

    .price-change {
        font-family: 'JetBrains Mono', monospace;
        font-size: var(--text-sm);
    }

    .price-change.positive { color: var(--success); }
    .price-change.negative { color: var(--danger); }

    /* News Section - Compact */
    .news-list {
        padding: 8px 16px;
    }

    .news-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        border-bottom: 1px solid var(--border-subtle);
        cursor: pointer;
    }

    .news-item:last-child {
        border-bottom: none;
    }

    .news-item:hover {
        opacity: 0.8;
    }

    .news-sentiment {
        width: 3px;
        height: 24px;
        border-radius: 2px;
        flex-shrink: 0;
    }

    .news-sentiment.bullish { background: var(--success); }
    .news-sentiment.bearish { background: var(--danger); }
    .news-sentiment.neutral { background: var(--text-tertiary); }

    .news-content {
        flex: 1;
        min-width: 0;
    }

    .news-title {
        font-size: 13px;
        line-height: 1.3;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .news-meta {
        display: none;
    }

    .news-ticker {
        color: var(--accent-cyan);
        font-weight: var(--font-semibold);
    }

    /* Empty State */
    .empty-state {
        padding: 48px 24px;
        text-align: center;
        color: var(--text-tertiary);
    }

    .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    .empty-state-text {
        margin-bottom: 16px;
    }

    /* Loading State */
    .loading-spinner {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 48px;
    }

    .spinner {
        width: 32px;
        height: 32px;
        border: 3px solid var(--border-subtle);
        border-top-color: var(--accent-cyan);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="content-header">
    <div>
        <h1 class="content-title">Dashboard</h1>
        <p class="content-subtitle">Welcome back{% if current_user.is_authenticated %}, {{ current_user.username }}{% endif %}</p>
    </div>
</div>

<!-- Market Overview -->
<div class="market-overview" id="marketOverview">
    <div class="index-card">
        <div class="index-name">S&P 500</div>
        <div class="index-value" id="spx-value">--</div>
        <div class="index-change" id="spx-change">--</div>
    </div>
    <div class="index-card">
        <div class="index-name">NASDAQ</div>
        <div class="index-value" id="ndx-value">--</div>
        <div class="index-change" id="ndx-change">--</div>
    </div>
    <div class="index-card">
        <div class="index-name">DOW JONES</div>
        <div class="index-value" id="dji-value">--</div>
        <div class="index-change" id="dji-change">--</div>
    </div>
    <div class="index-card">
        <div class="index-name">RUSSELL 2000</div>
        <div class="index-value" id="rut-value">--</div>
        <div class="index-change" id="rut-change">--</div>
    </div>
</div>

<!-- Two Column Layout -->
<div class="dashboard-grid">
    <!-- Left Column -->
    <div class="dashboard-left">
        <!-- Your Watchlist -->
        <div class="section-container">
            <div class="section-header">
                <h2 class="section-title">Your Watchlist</h2>
                <a href="/watchlist" class="view-all-link">Manage Watchlist &rarr;</a>
            </div>
            <div id="watchlistContent">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- Latest News -->
        <div class="section-container">
            <div class="section-header">
                <h2 class="section-title">Latest News</h2>
                <a href="/news" class="view-all-link">View All &rarr;</a>
            </div>
            <div class="news-list" id="newsContent">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column -->
    <div class="dashboard-right">
        <!-- Top Movers -->
        <div class="section-container">
            <div class="section-header">
                <h2 class="section-title">Top Movers</h2>
                <div class="movers-tabs">
                    <button class="mover-tab active" onclick="showMovers('gainers')">Gainers</button>
                    <button class="mover-tab" onclick="showMovers('losers')">Losers</button>
                </div>
            </div>
            <div class="mover-list" id="moversContent">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Load Market Indices
    async function loadMarketIndices() {
        try {
            const response = await fetch('/api/market/indices');
            if (response.ok) {
                const data = await response.json();
                const indices = data.indices || data;
                updateIndex('spx', indices.SPY || indices.SPX || indices['S&P 500']);
                updateIndex('ndx', indices.QQQ || indices.NDX || indices['NASDAQ']);
                updateIndex('dji', indices.DIA || indices.DJI || indices['Dow Jones']);
                updateIndex('rut', indices.IWM || indices.RUT || indices['Russell 2000']);
            }
        } catch (error) {
            console.error('Failed to load indices:', error);
        }
    }

    function updateIndex(id, data) {
        if (!data) return;
        const valueEl = document.getElementById(`${id}-value`);
        const changeEl = document.getElementById(`${id}-change`);

        valueEl.textContent = formatPrice(data.price || data.close);

        const changePercent = data.changePercent || data.change_percent || 0;
        const isPositive = changePercent >= 0;
        changeEl.textContent = `${isPositive ? '+' : ''}${changePercent.toFixed(2)}%`;
        changeEl.className = `index-change ${isPositive ? 'positive' : 'negative'}`;
    }

    // Load Watchlist
    async function loadWatchlist() {
        const container = document.getElementById('watchlistContent');
        try {
            const response = await fetch('/api/watchlist');
            if (response.ok) {
                const data = await response.json();
                // API returns array directly, not {watchlist: [...]}
                const watchlist = Array.isArray(data) ? data : (data.watchlist || []);
                if (watchlist.length > 0) {
                    renderWatchlist(watchlist.slice(0, 5));
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon" style="margin-bottom: 16px;">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.4;">
                                    <circle cx="11" cy="11" r="8"/>
                                    <path d="M21 21l-4.35-4.35" stroke-linecap="round"/>
                                </svg>
                            </div>
                            <p class="empty-state-text">No stocks in your watchlist yet</p>
                            <a href="/watchlist" class="btn btn-primary">Add Stocks</a>
                        </div>
                    `;
                }
            }
        } catch (error) {
            container.innerHTML = '<div class="empty-state">Failed to load watchlist</div>';
        }
    }

    function renderWatchlist(stocks) {
        const container = document.getElementById('watchlistContent');
        container.innerHTML = `
            <table class="watchlist-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th class="text-right">Price</th>
                        <th class="text-right">Change</th>
                    </tr>
                </thead>
                <tbody>
                    ${stocks.map(stock => `
                        <tr onclick="window.location='/stocks/${stock.ticker}'">
                            <td>
                                <div class="stock-info">
                                    <div class="stock-logo">${stock.ticker.substring(0, 2)}</div>
                                    <div>
                                        <div class="stock-symbol">${stock.ticker}</div>
                                        <div class="stock-name">${stock.company_name || stock.name || ''}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="text-right">
                                <span class="price-value">${formatPrice(stock.price)}</span>
                            </td>
                            <td class="text-right">
                                <span class="price-change ${stock.change_percent >= 0 ? 'positive' : 'negative'}">
                                    ${stock.change_percent >= 0 ? '+' : ''}${(stock.change_percent || 0).toFixed(2)}%
                                </span>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }

    // Load Top Movers
    async function loadTopMovers() {
        try {
            const response = await fetch('/api/market/movers');
            if (response.ok) {
                const data = await response.json();
                window.moversData = data;
                showMovers('gainers');
            }
        } catch (error) {
            document.getElementById('moversContent').innerHTML =
                '<div class="empty-state">Failed to load movers</div>';
        }
    }

    function showMovers(type) {
        // Update tabs
        document.querySelectorAll('.mover-tab').forEach(tab => {
            tab.classList.toggle('active', tab.textContent.toLowerCase() === type);
        });

        const container = document.getElementById('moversContent');
        const data = window.moversData;

        if (!data) {
            container.innerHTML = '<div class="empty-state">No data available</div>';
            return;
        }

        const stocks = type === 'gainers' ? (data.gainers || []) : (data.losers || []);

        if (stocks.length === 0) {
            container.innerHTML = '<div class="empty-state">No movers found</div>';
            return;
        }

        container.innerHTML = stocks.slice(0, 5).map(stock => `
            <div class="mover-item" onclick="window.location='/stocks/${stock.ticker}'">
                <div class="mover-info">
                    <div class="mover-logo">${stock.ticker.substring(0, 2)}</div>
                    <div class="mover-details">
                        <div class="mover-symbol">${stock.ticker}</div>
                    </div>
                </div>
                <div class="mover-data">
                    <div class="mover-price">${formatPrice(stock.price)}</div>
                    <div class="mover-change ${stock.change_percent >= 0 ? 'positive' : 'negative'}">
                        ${stock.change_percent >= 0 ? '+' : ''}${(stock.change_percent || 0).toFixed(2)}%
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Load News
    async function loadNews() {
        const container = document.getElementById('newsContent');
        try {
            const response = await fetch('/api/news?limit=2');
            if (response.ok) {
                const data = await response.json();
                // API returns {articles: [...]} not {news: [...]}
                const articles = data.articles || data.news || [];
                if (articles.length > 0) {
                    renderNews(articles);
                } else {
                    container.innerHTML = '<div class="empty-state">No news available</div>';
                }
            }
        } catch (error) {
            container.innerHTML = '<div class="empty-state">Failed to load news</div>';
        }
    }

    function renderNews(articles) {
        const container = document.getElementById('newsContent');
        container.innerHTML = articles.map(article => `
            <div class="news-item" onclick="window.open('${article.url}', '_blank')">
                <div class="news-sentiment ${getSentimentClass(article.sentiment)}"></div>
                <div class="news-content">
                    <div class="news-title">${article.title}</div>
                    <div class="news-meta">
                        ${article.tickers ? `<span class="news-ticker">${article.tickers.slice(0, 3).join(', ')}</span>` : ''}
                        <span>${formatTimeAgo(article.published_at || article.date)}</span>
                        <span>${article.source || ''}</span>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function getSentimentClass(sentiment) {
        if (!sentiment) return 'neutral';
        const s = sentiment.toLowerCase();
        if (s === 'bullish' || s === 'positive') return 'bullish';
        if (s === 'bearish' || s === 'negative') return 'bearish';
        return 'neutral';
    }

    // Utility Functions
    function formatPrice(price) {
        if (!price) return '--';
        return '$' + parseFloat(price).toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    function formatTimeAgo(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        return `${diffDays}d ago`;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadMarketIndices();
        loadWatchlist();
        loadTopMovers();
        loadNews();

        // Refresh every 60 seconds
        setInterval(() => {
            loadMarketIndices();
            loadWatchlist();
        }, 60000);
    });
</script>
{% endblock %}
