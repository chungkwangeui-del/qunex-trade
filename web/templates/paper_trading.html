{% extends "base_layout.html" %}

{% block title %}Paper Trading - Qunex Trade{% endblock %}

{% block extra_styles %}
<style>
    .paper-header {
        background: linear-gradient(135deg, rgba(249, 115, 22, 0.1), rgba(168, 85, 247, 0.1));
        border: 1px solid rgba(249, 115, 22, 0.2);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
    }

    .paper-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        background: rgba(249, 115, 22, 0.2);
        border: 1px solid rgba(249, 115, 22, 0.4);
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        color: #f97316;
        margin-bottom: 16px;
    }

    .account-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .stat-box {
        text-align: center;
    }

    .stat-label {
        font-size: 0.75rem;
        color: var(--text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 4px;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        font-family: 'JetBrains Mono', monospace;
    }

    .stat-value.positive { color: #22c55e; }
    .stat-value.negative { color: #ef4444; }

    .trade-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        margin-bottom: 24px;
    }

    @media (max-width: 768px) {
        .trade-section {
            grid-template-columns: 1fr;
        }
    }

    .trade-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 24px;
    }

    .card-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 16px;
    }

    .form-group {
        margin-bottom: 16px;
    }

    .form-label {
        display: block;
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-bottom: 6px;
    }

    .form-input {
        width: 100%;
        padding: 12px;
        background: var(--bg-hover);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 1rem;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--accent-cyan);
    }

    .btn-trade {
        width: 100%;
        padding: 14px;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-buy {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: #000;
    }

    .btn-sell {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: #fff;
    }

    .btn-trade:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .holdings-section, .history-section {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 16px;
        margin-bottom: 24px;
        overflow: hidden;
    }

    .section-header {
        padding: 16px 20px;
        background: var(--bg-hover);
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .section-title {
        font-size: 1rem;
        font-weight: 600;
    }

    .holdings-table {
        width: 100%;
        border-collapse: collapse;
    }

    .holdings-table th {
        padding: 12px 16px;
        text-align: left;
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        background: var(--bg-hover);
    }

    .holdings-table td {
        padding: 14px 16px;
        border-bottom: 1px solid var(--border);
        font-size: 0.9rem;
    }

    .holdings-table tr:hover {
        background: var(--bg-hover);
    }

    .ticker-cell {
        font-weight: 700;
        color: var(--accent-cyan);
        font-family: 'JetBrains Mono', monospace;
    }

    .pnl-positive { color: #22c55e; }
    .pnl-negative { color: #ef4444; }

    .btn-reset {
        padding: 8px 16px;
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 8px;
        color: #ef4444;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-reset:hover {
        background: rgba(239, 68, 68, 0.2);
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-tertiary);
    }

    .quote-preview {
        margin-top: 12px;
        padding: 12px;
        background: var(--bg-hover);
        border-radius: 8px;
        font-size: 0.85rem;
    }

    .quote-price {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--accent-cyan);
        font-family: 'JetBrains Mono', monospace;
    }
</style>
{% endblock %}

{% block content %}
<!-- Paper Trading Header -->
<div class="paper-header">
    <div class="paper-badge">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
        </svg>
        PAPER TRADING
    </div>
    <h1 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 8px;">Practice Trading</h1>
    <p style="color: var(--text-secondary); font-size: 0.9rem;">Trade with $100,000 virtual money. No risk, real learning.</p>

    <div class="account-stats">
        <div class="stat-box">
            <div class="stat-label">Cash Balance</div>
            <div class="stat-value" id="cashBalance">$100,000</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Portfolio Value</div>
            <div class="stat-value" id="portfolioValue">$0</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Total Value</div>
            <div class="stat-value" id="totalValue">$100,000</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Total P&L</div>
            <div class="stat-value" id="totalPnl">$0.00</div>
        </div>
    </div>
</div>

<!-- Trade Forms -->
<div class="trade-section">
    <!-- Buy Form -->
    <div class="trade-card">
        <h3 class="card-title" style="color: #22c55e;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <polyline points="5 12 12 5 19 12"/>
            </svg>
            Buy Stock
        </h3>
        <form id="buyForm" onsubmit="executeTrade(event, 'buy')">
            <div class="form-group">
                <label class="form-label">Ticker Symbol</label>
                <input type="text" id="buyTicker" class="form-input" placeholder="e.g., AAPL" required>
            </div>
            <div id="buyQuote" class="quote-preview" style="display: none;"></div>
            <div class="form-group">
                <label class="form-label">Shares</label>
                <input type="number" id="buyShares" class="form-input" placeholder="Number of shares" min="1" required>
            </div>
            <button type="submit" class="btn-trade btn-buy">Buy</button>
        </form>
    </div>

    <!-- Sell Form -->
    <div class="trade-card">
        <h3 class="card-title" style="color: #ef4444;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="19" x2="12" y2="5"/>
                <polyline points="5 12 12 19 19 12"/>
            </svg>
            Sell Stock
        </h3>
        <form id="sellForm" onsubmit="executeTrade(event, 'sell')">
            <div class="form-group">
                <label class="form-label">Ticker Symbol</label>
                <input type="text" id="sellTicker" class="form-input" placeholder="e.g., AAPL" required>
            </div>
            <div id="sellQuote" class="quote-preview" style="display: none;"></div>
            <div class="form-group">
                <label class="form-label">Shares</label>
                <input type="number" id="sellShares" class="form-input" placeholder="Number of shares" min="1" required>
            </div>
            <button type="submit" class="btn-trade btn-sell">Sell</button>
        </form>
    </div>
</div>

<!-- Holdings -->
<div class="holdings-section">
    <div class="section-header">
        <h3 class="section-title">Your Holdings</h3>
        <button class="btn-reset" onclick="resetAccount()">Reset Account</button>
    </div>
    <div id="holdingsContainer">
        <div class="empty-state">Loading...</div>
    </div>
</div>

<!-- Trade History -->
<div class="history-section">
    <div class="section-header">
        <h3 class="section-title">Recent Trades</h3>
    </div>
    <div id="tradesContainer">
        <div class="empty-state">Loading...</div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Load account data on page load
    document.addEventListener('DOMContentLoaded', loadAccount);

    // Debounce for ticker lookup
    let buyTimeout, sellTimeout;
    document.getElementById('buyTicker').addEventListener('input', (e) => {
        clearTimeout(buyTimeout);
        buyTimeout = setTimeout(() => lookupQuote(e.target.value, 'buy'), 500);
    });
    document.getElementById('sellTicker').addEventListener('input', (e) => {
        clearTimeout(sellTimeout);
        sellTimeout = setTimeout(() => lookupQuote(e.target.value, 'sell'), 500);
    });

    async function loadAccount() {
        try {
            const response = await fetch('/api/paper/account');
            const data = await response.json();

            if (data.success) {
                updateAccountDisplay(data.account);
                renderHoldings(data.holdings);
            }
        } catch (error) {
            console.error('Error loading account:', error);
        }

        loadTrades();
    }

    function updateAccountDisplay(account) {
        document.getElementById('cashBalance').textContent = formatCurrency(account.cash);
        document.getElementById('portfolioValue').textContent = formatCurrency(account.portfolio_value);
        document.getElementById('totalValue').textContent = formatCurrency(account.total_value);

        const pnlEl = document.getElementById('totalPnl');
        pnlEl.textContent = (account.total_pnl >= 0 ? '+' : '') + formatCurrency(account.total_pnl);
        pnlEl.className = 'stat-value ' + (account.total_pnl >= 0 ? 'positive' : 'negative');
    }

    function renderHoldings(holdings) {
        const container = document.getElementById('holdingsContainer');

        if (!holdings || holdings.length === 0) {
            container.innerHTML = '<div class="empty-state">No holdings yet. Start trading!</div>';
            return;
        }

        container.innerHTML = `
            <table class="holdings-table">
                <thead>
                    <tr>
                        <th>Ticker</th>
                        <th>Shares</th>
                        <th>Avg Cost</th>
                        <th>Current</th>
                        <th>Value</th>
                        <th>P&L</th>
                    </tr>
                </thead>
                <tbody>
                    ${holdings.map(h => `
                        <tr>
                            <td class="ticker-cell">${h.ticker}</td>
                            <td>${h.shares.toFixed(2)}</td>
                            <td>${formatCurrency(h.avg_cost)}</td>
                            <td>${formatCurrency(h.current_price)}</td>
                            <td>${formatCurrency(h.market_value)}</td>
                            <td class="${h.unrealized_pnl >= 0 ? 'pnl-positive' : 'pnl-negative'}">
                                ${h.unrealized_pnl >= 0 ? '+' : ''}${formatCurrency(h.unrealized_pnl)}
                                (${h.unrealized_pnl_pct >= 0 ? '+' : ''}${h.unrealized_pnl_pct.toFixed(2)}%)
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }

    async function loadTrades() {
        try {
            const response = await fetch('/api/paper/trades?limit=20');
            const data = await response.json();

            if (data.success) {
                renderTrades(data.trades);
            }
        } catch (error) {
            console.error('Error loading trades:', error);
        }
    }

    function renderTrades(trades) {
        const container = document.getElementById('tradesContainer');

        if (!trades || trades.length === 0) {
            container.innerHTML = '<div class="empty-state">No trades yet.</div>';
            return;
        }

        container.innerHTML = `
            <table class="holdings-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Ticker</th>
                        <th>Shares</th>
                        <th>Price</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${trades.map(t => `
                        <tr>
                            <td>${formatDate(t.trade_date)}</td>
                            <td style="color: ${t.trade_type === 'buy' ? '#22c55e' : '#ef4444'}; font-weight: 600;">
                                ${t.trade_type.toUpperCase()}
                            </td>
                            <td class="ticker-cell">${t.ticker}</td>
                            <td>${t.shares.toFixed(2)}</td>
                            <td>${formatCurrency(t.price)}</td>
                            <td>${formatCurrency(t.total_value)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }

    async function lookupQuote(ticker, type) {
        ticker = ticker.toUpperCase().trim();
        const quoteEl = document.getElementById(type + 'Quote');

        if (!ticker || ticker.length < 1) {
            quoteEl.style.display = 'none';
            return;
        }

        try {
            const response = await fetch(`/api/polygon/quote/${ticker}`);
            const data = await response.json();

            if (data.price) {
                quoteEl.innerHTML = `
                    <span class="quote-price">$${data.price.toFixed(2)}</span>
                    <span style="margin-left: 8px; color: ${data.change >= 0 ? '#22c55e' : '#ef4444'};">
                        ${data.change >= 0 ? '+' : ''}${data.change?.toFixed(2) || '0.00'}
                        (${data.changePercent >= 0 ? '+' : ''}${data.changePercent?.toFixed(2) || '0.00'}%)
                    </span>
                `;
                quoteEl.style.display = 'block';
            } else {
                quoteEl.style.display = 'none';
            }
        } catch (error) {
            quoteEl.style.display = 'none';
        }
    }

    async function executeTrade(event, type) {
        event.preventDefault();

        const ticker = document.getElementById(type + 'Ticker').value.toUpperCase().trim();
        const shares = parseFloat(document.getElementById(type + 'Shares').value);

        if (!ticker || !shares || shares <= 0) {
            alert('Please enter valid ticker and shares');
            return;
        }

        try {
            const response = await fetch('/api/paper/trade', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ticker, shares, trade_type: type })
            });

            const data = await response.json();

            if (data.success) {
                alert(data.message);
                document.getElementById(type + 'Form').reset();
                document.getElementById(type + 'Quote').style.display = 'none';
                loadAccount();
            } else {
                alert(data.message || 'Trade failed');
            }
        } catch (error) {
            console.error('Trade error:', error);
            alert('Network error. Please try again.');
        }
    }

    async function resetAccount() {
        if (!confirm('Are you sure you want to reset your paper trading account? All trades will be deleted.')) {
            return;
        }

        try {
            const response = await fetch('/api/paper/reset', { method: 'POST' });
            const data = await response.json();

            if (data.success) {
                alert('Account reset to $100,000');
                loadAccount();
            }
        } catch (error) {
            console.error('Reset error:', error);
        }
    }

    function formatCurrency(value) {
        return '$' + parseFloat(value || 0).toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    function formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }
</script>
{% endblock %}
